(()=>{"use strict";const t=new class{audioContext;tracks=[];slowAverage=39;fx1a=null;fx1b=null;constructor(){this.audioContext=new AudioContext}async initAudio(t){if(16!==t.length)throw new Error("Expected 16 audio files.");const e=t.map((t=>this.loadAudioFile(t)));(await Promise.all(e)).forEach((t=>{const e=this.audioContext.createBufferSource(),n=this.audioContext.createGain();e.buffer=t,n.gain.value=0,e.connect(n);const o=this.audioContext.createAnalyser();o.fftSize=2048,n.connect(o),this.fx1a=this.audioContext.createBiquadFilter(),this.fx1a.type="highpass",this.fx1a.frequency.value=1e3,this.fx1a.gain.value=0,n.connect(this.fx1a),this.fx1b=this.audioContext.createDelay(),this.fx1b.delayTime.value=0,this.fx1a.connect(this.fx1b),n.connect(this.audioContext.destination),this.tracks.push({sourceNode:e,gainNode:n,analyserNode:o}),e.loop=!0,e.start(0)}))}async loadAudioFile(t){const e=await fetch(t),n=await e.arrayBuffer();return this.audioContext.decodeAudioData(n)}getFrequencyColor(t){if(0===this.tracks[t].gainNode.gain.value)return`hsl(${this.slowAverage+t}, 100%, 50%)`;const e=this.tracks[t].analyserNode,n=new Uint8Array(e.frequencyBinCount);e.getByteFrequencyData(n);const o=Math.max(...n),s=n.indexOf(o);return this.updateSlowAverage(s),`hsl(${this.slowAverage+t+10*s%240}, 100%, 50%)`}updateSlowAverage(t){this.slowAverage=this.slowAverage+.001*t%240}enableTrack(t,e){if(-1!=t){if(t>=this.tracks.length)throw new Error(`Track ${t} does not exist.`);console.log("Enabling track",t,e),this.tracks[t].gainNode.gain.value=e?.5:0}}muteAll(){for(let t=0;t<this.tracks.length;t++)this.enableTrack(t,!1)}fx1(t,e){if(0!=t&&0!=e&&Math.random()>.1)return;if(!this.fx1a||!this.fx1b)return;console.log("fx1 called with x:",t,"y:",e),console.log("AudioContext state:",this.audioContext.state),console.log("Current time:",this.audioContext.currentTime),console.log("Applying gain:",25*t,"to fx1a");const n=Math.floor(10*t);this.fx1a.gain.setValueAtTime(n,this.audioContext.currentTime),this.fx1b.delayTime.setValueAtTime(e,this.audioContext.currentTime),console.log(this.fx1a,this.fx1b)}},e=16;var n=!1;function o(t,e,n,o){const s=document.createElement(t);return s.classList.add(e),s.id=n,o.appendChild(s),s}function s(t){document.querySelectorAll(".ball").forEach((e=>{e.style.display=t?"block":"none"}))}function i(t){if(!t)return-1;const e=t.split("square-");return e.length<2?-1:parseInt(e[1])}function a(t){if(t)o("div","spinner","spinner",document.body);else{const t=document.getElementById("spinner");t?.remove()}}function r(){const r=document.getElementById("start-button"),l=document.getElementById("info");r?.addEventListener("click",(async()=>{r.remove(),l?.remove(),a(!0),await async function(){n||(await t.initAudio(["stems/4-on-floor.wav","stems/bass.wav","stems/dnb-124.wav","stems/drums.wav","stems/hats.wav","stems/kick-hat.wav","stems/smooth-chords.wav","stems/toms.wav","stems/guitar.wav","stems/bass.wav","stems/dnb-124.wav","stems/drums.wav","stems/hats.wav","stems/kick-hat.wav","stems/smooth-chords.wav","stems/extacy.wav"]),n=!0)}(),a(!1),function(){const t=o("div","matrix","matrix",document.body);for(let n=0;n<e;n++)o("div","square",`square-${n}`,t);const n=o("div","ballhome","ballhome",document.body);for(let t=0;t<4;t++){const e=o("div","ball",`ball-${t}`,n);e.draggable=!0,e.innerText="ðŸŒˆ"}}(),document.querySelectorAll(".ball").forEach((e=>{function n(t){if(t instanceof TouchEvent&&t.touches)return{x:t.touches[0].clientX,y:t.touches[0].clientY};if(t instanceof MouseEvent)return{x:t.clientX,y:t.clientY};throw new Error("Unsupported event type")}function o(t){const n=e.parentElement;e.setAttribute("origin-square",n.id),e.setAttribute("clicked","true"),t.type,console.log(`[${t.type}] Lifted`,e.id,"from",n.id),t.preventDefault()}function a(t){if("true"!==e.getAttribute("clicked"))return;const o=n(t);e.style.left=o.x-25+"px",e.style.top=o.y-25+"px",console.log(`[${t.type}] Moving/Dragging`,e.id),t.preventDefault()}function r(o){if("true"!==e.getAttribute("clicked"))return;const a=n(o),r=e.getAttribute("origin-square");t.enableTrack(i(r),!1),e.setAttribute("clicked","false"),s(!1);const c=document.elementFromPoint(a.x,a.y);s(!0),((e,n)=>{console.log("Dropped:",e.id,n.id),t.enableTrack(i(n.id),!0),n.appendChild(e)})(e,c),console.log(`[${o.type}] Dropped`,e.id,"from",r)}e.addEventListener("mousedown",o),e.addEventListener("mousemove",a),e.addEventListener("mouseup",r),e.addEventListener("touchstart",o),e.addEventListener("touchmove",a),e.addEventListener("touchend",r)})),c()}))}function c(){if(requestAnimationFrame(c),n)for(let n=0;n<e;n++){const e=document.getElementById(`square-${n}`);e&&(e.style.backgroundColor=t.getFrequencyColor(n))}}document.addEventListener("DOMContentLoaded",(()=>{r()}))})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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YyxpQkFBaUIsVUFBV3dCLEdBQ2pDdEMsRUFBS2MsaUJBQWlCLGFBQWNjLEdBQ3BDNUIsRUFBS2MsaUJBQWlCLFlBQWFtQixHQUNuQ2pDLEVBQUtjLGlCQUFpQixXQUFZd0IsRUFBUSxJQTBJMUNNLEdBQU0sR0FFVixDQU1BLFNBQVNBLElBRVAsR0FEQUMsc0JBQXNCRCxHQUNqQjFELEVBR0wsSUFBSyxJQUFJVixFQUFJLEVBQUdBLEVBQUlTLEVBQVVULElBQUssQ0FDakMsTUFBTXNFLEVBQVNyRCxTQUFTZ0IsZUFBZSxVQUFVakMsS0FDN0NzRSxJQUNGQSxFQUFPN0MsTUFBTThDLGdCQUFrQnJJLEVBQUc2QyxrQkFBa0JpQixHLENBRzFELENBZkFpQixTQUFTcUIsaUJBQWlCLG9CQUFvQixLQUM1Q0gsR0FBbUIsRyIsInNvdXJjZXMiOlsid2VicGFjazovL3NxdWFyZXMvLi9zcmMvbWFpbi50cyIsIndlYnBhY2s6Ly9zcXVhcmVzLy4vc3JjL2F1ZGlvLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEF1ZGlvQ29udHJvbGxlciB9IGZyb20gXCIuL2F1ZGlvXCI7XG5cbmNvbnN0IGFjID0gbmV3IEF1ZGlvQ29udHJvbGxlcigpO1xuY29uc3QgblNxdWFyZXMgPSAxNjtcbmNvbnN0IG5CYWxscyA9IDQ7XG52YXIgaXNJbml0aWF0ZWQgPSBmYWxzZTtcbnZhciBtb2JpbGVVc2FnZSA9IGZhbHNlO1xudmFyIGZ4RW5hYmxlID0gZmFsc2U7XG5cbmZ1bmN0aW9uIGNyZWF0ZVVJRWxlbWVudHMoKSB7XG4gIC8vIENyZWF0ZSBGWCB1aVxuICBpZiAoZnhFbmFibGUpIHtcbiAgICBjb25zdCBmeGRpdiA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJmeFwiLCBcImZ4XCIsIGRvY3VtZW50LmJvZHkpO1xuICAgIGZ4ZGl2LnN0eWxlLmRpc3BsYXkgPSBmeEVuYWJsZSA/IFwiYmxvY2tcIiA6IFwibm9uZVwiO1xuICAgIGNvbnN0IGZ4MSA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJmeDFcIiwgXCJmeDFcIiwgZnhkaXYpO1xuICAgIGZ4MS5pbm5lclRleHQgPSBcIvCfjIpcIjtcbiAgICBjb25zdCBmeHNwYWNlciA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJmeHNwYWNlclwiLCBcImZ4c3BhY2VyXCIsIGZ4ZGl2KTtcbiAgICBjb25zdCBmeDIgPSBjcmVhdGVFbGVtZW50KFwiZGl2XCIsIFwiZngyXCIsIFwiZngyXCIsIGZ4ZGl2KTtcbiAgICBmeDIuaW5uZXJUZXh0ID0gXCLwn5WlXCI7XG4gIH1cblxuICBjb25zdCBtYXRyaXggPSBjcmVhdGVFbGVtZW50KFwiZGl2XCIsIFwibWF0cml4XCIsIFwibWF0cml4XCIsIGRvY3VtZW50LmJvZHkpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IG5TcXVhcmVzOyBpKyspIHtcbiAgICBjcmVhdGVFbGVtZW50KFwiZGl2XCIsIFwic3F1YXJlXCIsIGBzcXVhcmUtJHtpfWAsIG1hdHJpeCk7XG4gIH1cblxuICBjb25zdCBiYWxsSG9tZSA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJiYWxsaG9tZVwiLCBcImJhbGxob21lXCIsIGRvY3VtZW50LmJvZHkpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IG5CYWxsczsgaSsrKSB7XG4gICAgY29uc3QgYmFsbCA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJiYWxsXCIsIGBiYWxsLSR7aX1gLCBiYWxsSG9tZSk7XG4gICAgYmFsbC5kcmFnZ2FibGUgPSB0cnVlO1xuICAgIGJhbGwuaW5uZXJUZXh0ID0gYPCfjIhgO1xuICB9XG59XG5cbmZ1bmN0aW9uIGluaXRVSUxvZ2ljKCkge1xuICBjb25zdCBiYWxsczogTm9kZUxpc3RPZjxIVE1MRWxlbWVudD4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLmJhbGxcIik7XG5cbiAgLy8gRHJvcHMgYSBiYWxsIGludG8gYSB0YXJnZXQgZWxlbWVudCBhbmQgbXV0ZXMgdGhlIHRyYWNrIHRoZSBiYWxsIGNhbWUgZnJvbVxuICBjb25zdCBkcm9wQmFsbCA9IChiYWxsOiBIVE1MRWxlbWVudCwgdGFyZ2V0OiBIVE1MRWxlbWVudCkgPT4ge1xuICAgIGNvbnNvbGUubG9nKFwiRHJvcHBlZDpcIiwgYmFsbC5pZCwgdGFyZ2V0LmlkKTtcbiAgICBhYy5lbmFibGVUcmFjayhnZXRTcXVhcmVJZCh0YXJnZXQuaWQpLCB0cnVlKTtcbiAgICB0YXJnZXQuYXBwZW5kQ2hpbGQoYmFsbCk7XG4gIH07XG5cbiAgYmFsbHMuZm9yRWFjaCgoYmFsbCkgPT4ge1xuICAgIC8vIEhlbHBlciB0byBleHRyYWN0IHBvc2l0aW9uIGZyb20gZXZlbnRcbiAgICBmdW5jdGlvbiBnZXRQb3NpdGlvbkZyb21FdmVudChlOiBNb3VzZUV2ZW50IHwgVG91Y2hFdmVudCk6IHtcbiAgICAgIHg6IG51bWJlcjtcbiAgICAgIHk6IG51bWJlcjtcbiAgICB9IHtcbiAgICAgIGlmIChlIGluc3RhbmNlb2YgVG91Y2hFdmVudCAmJiBlLnRvdWNoZXMpIHtcbiAgICAgICAgcmV0dXJuIHsgeDogZS50b3VjaGVzWzBdLmNsaWVudFgsIHk6IGUudG91Y2hlc1swXS5jbGllbnRZIH07XG4gICAgICB9IGVsc2UgaWYgKGUgaW5zdGFuY2VvZiBNb3VzZUV2ZW50KSB7XG4gICAgICAgIHJldHVybiB7IHg6IGUuY2xpZW50WCwgeTogZS5jbGllbnRZIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbnN1cHBvcnRlZCBldmVudCB0eXBlXCIpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENvbW1vbiBmdW5jdGlvbiBmb3Igc3RhcnRpbmcgdGhlIGRyYWdcbiAgICBmdW5jdGlvbiBzdGFydERyYWcoZTogTW91c2VFdmVudCB8IFRvdWNoRXZlbnQpIHtcbiAgICAgIGNvbnN0IG9yaWdpblNxdWFyZSA9IGJhbGwucGFyZW50RWxlbWVudCBhcyBIVE1MRWxlbWVudDtcbiAgICAgIGJhbGwuc2V0QXR0cmlidXRlKFwib3JpZ2luLXNxdWFyZVwiLCBvcmlnaW5TcXVhcmUuaWQpO1xuICAgICAgYmFsbC5zZXRBdHRyaWJ1dGUoXCJjbGlja2VkXCIsIFwidHJ1ZVwiKTtcbiAgICAgIG1vYmlsZVVzYWdlID0gZS50eXBlID09PSBcInRvdWNoc3RhcnRcIjtcbiAgICAgIGNvbnNvbGUubG9nKGBbJHtlLnR5cGV9XSBMaWZ0ZWRgLCBiYWxsLmlkLCBcImZyb21cIiwgb3JpZ2luU3F1YXJlLmlkKTtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICB9XG5cbiAgICAvLyBDb21tb24gZnVuY3Rpb24gZm9yIGRyYWdnaW5nXG4gICAgZnVuY3Rpb24gZG9EcmFnKGU6IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50KSB7XG4gICAgICBpZiAoYmFsbC5nZXRBdHRyaWJ1dGUoXCJjbGlja2VkXCIpICE9PSBcInRydWVcIikgcmV0dXJuO1xuICAgICAgY29uc3QgcG9zaXRpb24gPSBnZXRQb3NpdGlvbkZyb21FdmVudChlKTtcbiAgICAgIGJhbGwuc3R5bGUubGVmdCA9IGAke3Bvc2l0aW9uLnggLSAyNX1weGA7XG4gICAgICBiYWxsLnN0eWxlLnRvcCA9IGAke3Bvc2l0aW9uLnkgLSAyNX1weGA7XG4gICAgICBjb25zb2xlLmxvZyhgWyR7ZS50eXBlfV0gTW92aW5nL0RyYWdnaW5nYCwgYmFsbC5pZCk7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgfVxuXG4gICAgLy8gQ29tbW9uIGZ1bmN0aW9uIGZvciBlbmRpbmcgdGhlIGRyYWdcbiAgICBmdW5jdGlvbiBlbmREcmFnKGU6IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50KSB7XG4gICAgICBpZiAoYmFsbC5nZXRBdHRyaWJ1dGUoXCJjbGlja2VkXCIpICE9PSBcInRydWVcIikgcmV0dXJuO1xuICAgICAgY29uc3QgcG9zaXRpb24gPSBnZXRQb3NpdGlvbkZyb21FdmVudChlKTtcbiAgICAgIGNvbnN0IG9yaWdpblNxdWFyZUlkID0gYmFsbC5nZXRBdHRyaWJ1dGUoXCJvcmlnaW4tc3F1YXJlXCIpO1xuICAgICAgYWMuZW5hYmxlVHJhY2soZ2V0U3F1YXJlSWQob3JpZ2luU3F1YXJlSWQpLCBmYWxzZSk7XG4gICAgICBiYWxsLnNldEF0dHJpYnV0ZShcImNsaWNrZWRcIiwgXCJmYWxzZVwiKTtcbiAgICAgIHNob3dCYWxscyhmYWxzZSk7XG4gICAgICBjb25zdCB0YXJnZXRFbGVtZW50ID0gZG9jdW1lbnQuZWxlbWVudEZyb21Qb2ludChcbiAgICAgICAgcG9zaXRpb24ueCxcbiAgICAgICAgcG9zaXRpb24ueVxuICAgICAgKSBhcyBIVE1MRWxlbWVudDtcbiAgICAgIHNob3dCYWxscyh0cnVlKTtcbiAgICAgIGRyb3BCYWxsKGJhbGwsIHRhcmdldEVsZW1lbnQpO1xuICAgICAgY29uc29sZS5sb2coYFske2UudHlwZX1dIERyb3BwZWRgLCBiYWxsLmlkLCBcImZyb21cIiwgb3JpZ2luU3F1YXJlSWQpO1xuICAgIH1cblxuICAgIC8vIEFkZCBldmVudCBsaXN0ZW5lcnNcbiAgICBiYWxsLmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZWRvd25cIiwgc3RhcnREcmFnKTtcbiAgICBiYWxsLmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZW1vdmVcIiwgZG9EcmFnKTtcbiAgICBiYWxsLmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZXVwXCIsIGVuZERyYWcpO1xuICAgIGJhbGwuYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNoc3RhcnRcIiwgc3RhcnREcmFnKTtcbiAgICBiYWxsLmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaG1vdmVcIiwgZG9EcmFnKTtcbiAgICBiYWxsLmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaGVuZFwiLCBlbmREcmFnKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGluaXRGWFVJKCkge1xuICBpZiAoIWZ4RW5hYmxlKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IGZ4MSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZngxXCIpO1xuICBpZiAoIWZ4MSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcImZ4MSBub3QgZm91bmRcIik7XG4gIH1cbiAgZngxLmRyYWdnYWJsZSA9IHRydWU7XG4gIGNvbnN0IGZ4MiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZngyXCIpO1xuICBmeDE/LmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnc3RhcnRcIiwgKGU6IERyYWdFdmVudCkgPT4ge1xuICAgIGNvbnN0IHsgeCwgeSB9ID0gbm9ybWFsaXplZFhZKGUueCwgZS55KTtcbiAgICBhYy5meDEoeCwgeSk7XG4gICAgY29uc29sZS5sb2coXCJkcmFnc3RhcnRcIik7XG4gIH0pO1xuICBmeDE/LmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnXCIsIChlOiBEcmFnRXZlbnQpID0+IHtcbiAgICBjb25zdCB7IHgsIHkgfSA9IG5vcm1hbGl6ZWRYWShlLngsIGUueSk7XG4gICAgYWMuZngxKHgsIHkpO1xuICAgIGNvbnNvbGUubG9nKFwiZHJhZ21vdmVcIik7XG4gIH0pO1xuICBmeDE/LmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnZW5kXCIsIChlOiBEcmFnRXZlbnQpID0+IHtcbiAgICBhYy5meDEoMCwgMCk7XG4gICAgY29uc29sZS5sb2coXCJkcmFnZW5kXCIpO1xuICB9KTtcbiAgZngxPy5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hzdGFydFwiLCAoZTogVG91Y2hFdmVudCkgPT4ge1xuICAgIGlmIChlLnRvdWNoZXMubGVuZ3RoICE9IDEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgdG91Y2ggPSBlLnRvdWNoZXNbMF07XG4gICAgY29uc3QgeyB4LCB5IH0gPSBub3JtYWxpemVkWFkodG91Y2guY2xpZW50WCwgdG91Y2guY2xpZW50WSk7XG4gICAgYWMuZngxKHgsIHkpO1xuICAgIGNvbnNvbGUubG9nKFwidG91Y2hzdGFydFwiKTtcbiAgfSk7XG4gIGZ4MT8uYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNobW92ZVwiLCAoZTogVG91Y2hFdmVudCkgPT4ge1xuICAgIGlmIChlLnRvdWNoZXMubGVuZ3RoICE9IDEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgdG91Y2ggPSBlLnRvdWNoZXNbMF07XG4gICAgY29uc3QgeyB4LCB5IH0gPSBub3JtYWxpemVkWFkodG91Y2guY2xpZW50WCwgdG91Y2guY2xpZW50WSk7XG4gICAgYWMuZngxKHgsIHkpO1xuICAgIGNvbnNvbGUubG9nKFwidG91Y2htb3ZlXCIpO1xuICB9KTtcbiAgZngxPy5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hlbmRcIiwgKGU6IFRvdWNoRXZlbnQpID0+IHtcbiAgICBpZiAoZS50b3VjaGVzLmxlbmd0aCAhPSAxKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGFjLmZ4MSgwLCAwKTtcbiAgICBjb25zb2xlLmxvZyhcInRvdWNoZW5kXCIpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlRWxlbWVudChcbiAgdGFnOiBzdHJpbmcsXG4gIGNsczogc3RyaW5nLFxuICBpZDogc3RyaW5nLFxuICBwYXJlbnQ6IEhUTUxFbGVtZW50XG4pIHtcbiAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnKTtcbiAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKGNscyk7XG4gIGVsZW1lbnQuaWQgPSBpZDtcbiAgcGFyZW50LmFwcGVuZENoaWxkKGVsZW1lbnQpO1xuICByZXR1cm4gZWxlbWVudDtcbn1cblxuZnVuY3Rpb24gc2hvd0JhbGxzKHNob3c6IGJvb2xlYW4pIHtcbiAgY29uc3QgYmFsbHM6IE5vZGVMaXN0T2Y8SFRNTEVsZW1lbnQ+ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5iYWxsXCIpO1xuICBiYWxscy5mb3JFYWNoKChiYWxsKSA9PiB7XG4gICAgYmFsbC5zdHlsZS5kaXNwbGF5ID0gc2hvdyA/IFwiYmxvY2tcIiA6IFwibm9uZVwiO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0U3F1YXJlSWQoaWQ6IHN0cmluZyB8IG51bGwpOiBudW1iZXIge1xuICBpZiAoIWlkKSB7XG4gICAgcmV0dXJuIC0xO1xuICB9XG4gIGNvbnN0IHBhcnRzID0gaWQuc3BsaXQoXCJzcXVhcmUtXCIpO1xuICBpZiAocGFydHMubGVuZ3RoIDwgMikge1xuICAgIHJldHVybiAtMTtcbiAgfVxuICByZXR1cm4gcGFyc2VJbnQocGFydHNbMV0pO1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVkWFkoeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcbiAgY29uc3Qgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xuICByZXR1cm4geyB4OiB4IC8gd2lkdGgsIHk6IHkgLyBoZWlnaHQgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5pdEF1ZGlvKCkge1xuICBpZiAoaXNJbml0aWF0ZWQpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgYXdhaXQgYWMuaW5pdEF1ZGlvKFtcbiAgICBcInN0ZW1zLzQtb24tZmxvb3Iud2F2XCIsXG4gICAgXCJzdGVtcy9iYXNzLndhdlwiLFxuICAgIFwic3RlbXMvZG5iLTEyNC53YXZcIixcbiAgICBcInN0ZW1zL2RydW1zLndhdlwiLFxuICAgIFwic3RlbXMvaGF0cy53YXZcIixcbiAgICBcInN0ZW1zL2tpY2staGF0LndhdlwiLFxuICAgIFwic3RlbXMvc21vb3RoLWNob3Jkcy53YXZcIixcbiAgICBcInN0ZW1zL3RvbXMud2F2XCIsXG4gICAgXCJzdGVtcy9ndWl0YXIud2F2XCIsXG4gICAgXCJzdGVtcy9iYXNzLndhdlwiLFxuICAgIFwic3RlbXMvZG5iLTEyNC53YXZcIixcbiAgICBcInN0ZW1zL2RydW1zLndhdlwiLFxuICAgIFwic3RlbXMvaGF0cy53YXZcIixcbiAgICBcInN0ZW1zL2tpY2staGF0LndhdlwiLFxuICAgIFwic3RlbXMvc21vb3RoLWNob3Jkcy53YXZcIixcbiAgICBcInN0ZW1zL2V4dGFjeS53YXZcIixcbiAgXSk7XG4gIGlzSW5pdGlhdGVkID0gdHJ1ZTtcbn1cblxuZnVuY3Rpb24gc3Bpbm5lcihzaG93OiBib29sZWFuKSB7XG4gIGlmIChzaG93KSB7XG4gICAgY3JlYXRlRWxlbWVudChcImRpdlwiLCBcInNwaW5uZXJcIiwgXCJzcGlubmVyXCIsIGRvY3VtZW50LmJvZHkpO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHNwaW5uZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInNwaW5uZXJcIik7XG4gICAgc3Bpbm5lcj8ucmVtb3ZlKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gY3JlYXRlU3RhcnRCdXR0b24oKSB7XG4gIGNvbnN0IHN0YXJ0QnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJzdGFydC1idXR0b25cIik7XG4gIGNvbnN0IGluZm8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImluZm9cIik7XG4gIHN0YXJ0QnV0dG9uPy5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgYXN5bmMgKCkgPT4ge1xuICAgIHN0YXJ0QnV0dG9uLnJlbW92ZSgpO1xuICAgIGluZm8/LnJlbW92ZSgpO1xuICAgIHNwaW5uZXIodHJ1ZSk7XG4gICAgYXdhaXQgaW5pdEF1ZGlvKCk7XG4gICAgc3Bpbm5lcihmYWxzZSk7XG4gICAgY3JlYXRlVUlFbGVtZW50cygpO1xuICAgIGluaXRVSUxvZ2ljKCk7XG4gICAgaW5pdEZYVUkoKTtcbiAgICBkcmF3KCk7XG4gIH0pO1xufVxuXG5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwiRE9NQ29udGVudExvYWRlZFwiLCAoKSA9PiB7XG4gIGNyZWF0ZVN0YXJ0QnV0dG9uKCk7XG59KTtcblxuZnVuY3Rpb24gZHJhdygpIHtcbiAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGRyYXcpO1xuICBpZiAoIWlzSW5pdGlhdGVkKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgblNxdWFyZXM7IGkrKykge1xuICAgIGNvbnN0IHNxdWFyZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBzcXVhcmUtJHtpfWApIGFzIEhUTUxFbGVtZW50O1xuICAgIGlmIChzcXVhcmUpIHtcbiAgICAgIHNxdWFyZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBhYy5nZXRGcmVxdWVuY3lDb2xvcihpKTtcbiAgICB9XG4gIH1cbn1cbiIsImV4cG9ydCBjbGFzcyBBdWRpb0NvbnRyb2xsZXIge1xuICBwcml2YXRlIGF1ZGlvQ29udGV4dDogQXVkaW9Db250ZXh0O1xuICBwcml2YXRlIHRyYWNrczoge1xuICAgIHNvdXJjZU5vZGU6IEF1ZGlvQnVmZmVyU291cmNlTm9kZTtcbiAgICBnYWluTm9kZTogR2Fpbk5vZGU7XG4gICAgYW5hbHlzZXJOb2RlOiBBbmFseXNlck5vZGU7XG4gIH1bXSA9IFtdO1xuICBwcml2YXRlIHNsb3dBdmVyYWdlOiBudW1iZXIgPSAzOTsgLy8gb3JhbmdlXG4gIHByaXZhdGUgZngxYTogQmlxdWFkRmlsdGVyTm9kZSB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGZ4MWI6IERlbGF5Tm9kZSB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuYXVkaW9Db250ZXh0ID0gbmV3IEF1ZGlvQ29udGV4dCgpO1xuICB9XG5cbiAgYXN5bmMgaW5pdEF1ZGlvKGZpbGVOYW1lczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoZmlsZU5hbWVzLmxlbmd0aCAhPT0gMTYpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkV4cGVjdGVkIDE2IGF1ZGlvIGZpbGVzLlwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBmaWxlUHJvbWlzZXMgPSBmaWxlTmFtZXMubWFwKChmaWxlTmFtZSkgPT5cbiAgICAgIHRoaXMubG9hZEF1ZGlvRmlsZShmaWxlTmFtZSlcbiAgICApO1xuXG4gICAgY29uc3QgYXVkaW9CdWZmZXJzID0gYXdhaXQgUHJvbWlzZS5hbGwoZmlsZVByb21pc2VzKTtcblxuICAgIGF1ZGlvQnVmZmVycy5mb3JFYWNoKChidWZmZXIpID0+IHtcbiAgICAgIGNvbnN0IHNvdXJjZU5vZGUgPSB0aGlzLmF1ZGlvQ29udGV4dC5jcmVhdGVCdWZmZXJTb3VyY2UoKTtcbiAgICAgIGNvbnN0IGdhaW5Ob2RlID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlR2FpbigpO1xuXG4gICAgICBzb3VyY2VOb2RlLmJ1ZmZlciA9IGJ1ZmZlcjtcbiAgICAgIGdhaW5Ob2RlLmdhaW4udmFsdWUgPSAwOyAvLyBTdGFydCBtdXRlZFxuICAgICAgc291cmNlTm9kZS5jb25uZWN0KGdhaW5Ob2RlKTtcblxuICAgICAgLy8gc2V0IHVwIGFuIGFuYWx5c2VyIHNvIHdlIGNhbiBkbyBjb29sIHZpc3VhbHNcbiAgICAgIGNvbnN0IGFuYWx5c2VyTm9kZSA9IHRoaXMuYXVkaW9Db250ZXh0LmNyZWF0ZUFuYWx5c2VyKCk7XG4gICAgICBhbmFseXNlck5vZGUuZmZ0U2l6ZSA9IDIwNDg7XG4gICAgICBnYWluTm9kZS5jb25uZWN0KGFuYWx5c2VyTm9kZSk7XG5cbiAgICAgIC8vIHNldCB1cCBmeCBub2Rlc1xuICAgICAgdGhpcy5meDFhID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlQmlxdWFkRmlsdGVyKCk7XG4gICAgICB0aGlzLmZ4MWEudHlwZSA9IFwiaGlnaHBhc3NcIjtcbiAgICAgIHRoaXMuZngxYS5mcmVxdWVuY3kudmFsdWUgPSAxMDAwO1xuICAgICAgdGhpcy5meDFhLmdhaW4udmFsdWUgPSAwO1xuICAgICAgZ2Fpbk5vZGUuY29ubmVjdCh0aGlzLmZ4MWEpO1xuXG4gICAgICB0aGlzLmZ4MWIgPSB0aGlzLmF1ZGlvQ29udGV4dC5jcmVhdGVEZWxheSgpO1xuICAgICAgdGhpcy5meDFiLmRlbGF5VGltZS52YWx1ZSA9IDA7IC8vIHBhc3MgdGhyb3VnaFxuICAgICAgdGhpcy5meDFhLmNvbm5lY3QodGhpcy5meDFiKTtcblxuICAgICAgLy8gZm9yIG5vdyBqdXN0IGJ5cGFzcyB0aGUgRlggbm9kZXMgLSBub3QgaW1wbGVtZW50ZWQgcHJvcGVybHkgeWV0XG4gICAgICAvLyAgIHRoaXMuZngxYi5jb25uZWN0KHRoaXMuYXVkaW9Db250ZXh0LmRlc3RpbmF0aW9uKTtcbiAgICAgIGdhaW5Ob2RlLmNvbm5lY3QodGhpcy5hdWRpb0NvbnRleHQuZGVzdGluYXRpb24pO1xuXG4gICAgICB0aGlzLnRyYWNrcy5wdXNoKHsgc291cmNlTm9kZSwgZ2Fpbk5vZGUsIGFuYWx5c2VyTm9kZSB9KTtcblxuICAgICAgc291cmNlTm9kZS5sb29wID0gdHJ1ZTtcbiAgICAgIHNvdXJjZU5vZGUuc3RhcnQoMCk7IC8vIFBsYXkgaW1tZWRpYXRlbHkgaW4gc3luY1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkQXVkaW9GaWxlKHVybDogc3RyaW5nKTogUHJvbWlzZTxBdWRpb0J1ZmZlcj4ge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsKTtcbiAgICBjb25zdCBhcnJheUJ1ZmZlciA9IGF3YWl0IHJlc3BvbnNlLmFycmF5QnVmZmVyKCk7XG4gICAgcmV0dXJuIHRoaXMuYXVkaW9Db250ZXh0LmRlY29kZUF1ZGlvRGF0YShhcnJheUJ1ZmZlcik7XG4gIH1cblxuICBnZXRGcmVxdWVuY3lDb2xvcih0cmFjazogbnVtYmVyKTogc3RyaW5nIHtcbiAgICBjb25zdCBnYWluTm9kZSA9IHRoaXMudHJhY2tzW3RyYWNrXS5nYWluTm9kZTtcbiAgICBpZiAoZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9PT0gMCkge1xuICAgICAgcmV0dXJuIGBoc2woJHt0aGlzLnNsb3dBdmVyYWdlICsgdHJhY2t9LCAxMDAlLCA1MCUpYDtcbiAgICB9XG4gICAgY29uc3QgYW5hbHlzZXJOb2RlID0gdGhpcy50cmFja3NbdHJhY2tdLmFuYWx5c2VyTm9kZTtcbiAgICBjb25zdCBkYXRhQXJyYXkgPSBuZXcgVWludDhBcnJheShhbmFseXNlck5vZGUuZnJlcXVlbmN5QmluQ291bnQpO1xuICAgIGFuYWx5c2VyTm9kZS5nZXRCeXRlRnJlcXVlbmN5RGF0YShkYXRhQXJyYXkpO1xuXG4gICAgLy8gZ2V0IHRoZSBoaWdoZXN0IGZyZXF1ZW5jeVxuICAgIGNvbnN0IG1heCA9IE1hdGgubWF4KC4uLmRhdGFBcnJheSk7XG4gICAgY29uc3QgbWF4SW5kZXggPSBkYXRhQXJyYXkuaW5kZXhPZihtYXgpO1xuICAgIHRoaXMudXBkYXRlU2xvd0F2ZXJhZ2UobWF4SW5kZXgpO1xuXG4gICAgY29uc3QgaHVlID0gdGhpcy5zbG93QXZlcmFnZSArIHRyYWNrICsgKChtYXhJbmRleCAqIDEwKSAlIDI0MCk7XG4gICAgcmV0dXJuIGBoc2woJHtodWV9LCAxMDAlLCA1MCUpYDtcbiAgfVxuXG4gIHVwZGF0ZVNsb3dBdmVyYWdlKHZhbHVlOiBudW1iZXIpIHtcbiAgICB0aGlzLnNsb3dBdmVyYWdlID0gdGhpcy5zbG93QXZlcmFnZSArICgodmFsdWUgKiAwLjAwMSkgJSAyNDApO1xuICB9XG5cbiAgZW5hYmxlVHJhY2sodHJhY2tOdW1iZXI6IG51bWJlciwgZW5hYmxlOiBib29sZWFuKTogdm9pZCB7XG4gICAgaWYgKHRyYWNrTnVtYmVyID09IC0xKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0cmFja051bWJlciA+PSB0aGlzLnRyYWNrcy5sZW5ndGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHJhY2sgJHt0cmFja051bWJlcn0gZG9lcyBub3QgZXhpc3QuYCk7XG4gICAgfVxuICAgIGNvbnNvbGUubG9nKFwiRW5hYmxpbmcgdHJhY2tcIiwgdHJhY2tOdW1iZXIsIGVuYWJsZSlcbiAgICB0aGlzLnRyYWNrc1t0cmFja051bWJlcl0uZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9IGVuYWJsZSA/IDAuNSA6IDA7XG4gIH1cblxuICBtdXRlQWxsKCk6IHZvaWQge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy50cmFja3MubGVuZ3RoOyBpKyspIHtcbiAgICAgIHRoaXMuZW5hYmxlVHJhY2soaSwgZmFsc2UpO1xuICAgIH1cbiAgfVxuXG4gIGZ4MSh4OiBudW1iZXIsIHk6IG51bWJlcikge1xuICAgIGlmICh4ICE9IDAgJiYgeSAhPSAwKSB7XG4gICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuMSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghdGhpcy5meDFhIHx8ICF0aGlzLmZ4MWIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc29sZS5sb2coXCJmeDEgY2FsbGVkIHdpdGggeDpcIiwgeCwgXCJ5OlwiLCB5KTtcbiAgICBjb25zb2xlLmxvZyhcIkF1ZGlvQ29udGV4dCBzdGF0ZTpcIiwgdGhpcy5hdWRpb0NvbnRleHQuc3RhdGUpO1xuICAgIGNvbnNvbGUubG9nKFwiQ3VycmVudCB0aW1lOlwiLCB0aGlzLmF1ZGlvQ29udGV4dC5jdXJyZW50VGltZSk7XG5cbiAgICBjb25zb2xlLmxvZyhcIkFwcGx5aW5nIGdhaW46XCIsIHggKiAyNSwgXCJ0byBmeDFhXCIpO1xuICAgIGNvbnN0IGdhaW4gPSBNYXRoLmZsb29yKHggKiAxMCk7XG4gICAgdGhpcy5meDFhLmdhaW4uc2V0VmFsdWVBdFRpbWUoZ2FpbiwgdGhpcy5hdWRpb0NvbnRleHQuY3VycmVudFRpbWUpO1xuICAgIHRoaXMuZngxYi5kZWxheVRpbWUuc2V0VmFsdWVBdFRpbWUoeSwgdGhpcy5hdWRpb0NvbnRleHQuY3VycmVudFRpbWUpO1xuXG4gICAgY29uc29sZS5sb2codGhpcy5meDFhLCB0aGlzLmZ4MWIpO1xuICB9XG59XG4iXSwibmFtZXMiOlsiYWMiLCJhdWRpb0NvbnRleHQiLCJ0cmFja3MiLCJzbG93QXZlcmFnZSIsImZ4MWEiLCJmeDFiIiwiY29uc3RydWN0b3IiLCJ0aGlzIiwiQXVkaW9Db250ZXh0IiwiaW5pdEF1ZGlvIiwiZmlsZU5hbWVzIiwibGVuZ3RoIiwiRXJyb3IiLCJmaWxlUHJvbWlzZXMiLCJtYXAiLCJmaWxlTmFtZSIsImxvYWRBdWRpb0ZpbGUiLCJQcm9taXNlIiwiYWxsIiwiZm9yRWFjaCIsImJ1ZmZlciIsInNvdXJjZU5vZGUiLCJjcmVhdGVCdWZmZXJTb3VyY2UiLCJnYWluTm9kZSIsImNyZWF0ZUdhaW4iLCJnYWluIiwidmFsdWUiLCJjb25uZWN0IiwiYW5hbHlzZXJOb2RlIiwiY3JlYXRlQW5hbHlzZXIiLCJmZnRTaXplIiwiY3JlYXRlQmlxdWFkRmlsdGVyIiwidHlwZSIsImZyZXF1ZW5jeSIsImNyZWF0ZURlbGF5IiwiZGVsYXlUaW1lIiwiZGVzdGluYXRpb24iLCJwdXNoIiwibG9vcCIsInN0YXJ0IiwidXJsIiwicmVzcG9uc2UiLCJmZXRjaCIsImFycmF5QnVmZmVyIiwiZGVjb2RlQXVkaW9EYXRhIiwiZ2V0RnJlcXVlbmN5Q29sb3IiLCJ0cmFjayIsImRhdGFBcnJheSIsIlVpbnQ4QXJyYXkiLCJmcmVxdWVuY3lCaW5Db3VudCIsImdldEJ5dGVGcmVxdWVuY3lEYXRhIiwibWF4IiwiTWF0aCIsIm1heEluZGV4IiwiaW5kZXhPZiIsInVwZGF0ZVNsb3dBdmVyYWdlIiwiZW5hYmxlVHJhY2siLCJ0cmFja051bWJlciIsImVuYWJsZSIsImNvbnNvbGUiLCJsb2ciLCJtdXRlQWxsIiwiaSIsImZ4MSIsIngiLCJ5IiwicmFuZG9tIiwic3RhdGUiLCJjdXJyZW50VGltZSIsImZsb29yIiwic2V0VmFsdWVBdFRpbWUiLCJuU3F1YXJlcyIsImlzSW5pdGlhdGVkIiwiY3JlYXRlRWxlbWVudCIsInRhZyIsImNscyIsImlkIiwicGFyZW50IiwiZWxlbWVudCIsImRvY3VtZW50IiwiY2xhc3NMaXN0IiwiYWRkIiwiYXBwZW5kQ2hpbGQiLCJzaG93QmFsbHMiLCJzaG93IiwicXVlcnlTZWxlY3RvckFsbCIsImJhbGwiLCJzdHlsZSIsImRpc3BsYXkiLCJnZXRTcXVhcmVJZCIsInBhcnRzIiwic3BsaXQiLCJwYXJzZUludCIsInNwaW5uZXIiLCJib2R5IiwiZ2V0RWxlbWVudEJ5SWQiLCJyZW1vdmUiLCJjcmVhdGVTdGFydEJ1dHRvbiIsInN0YXJ0QnV0dG9uIiwiaW5mbyIsImFkZEV2ZW50TGlzdGVuZXIiLCJhc3luYyIsIm1hdHJpeCIsImJhbGxIb21lIiwiZHJhZ2dhYmxlIiwiaW5uZXJUZXh0IiwiY3JlYXRlVUlFbGVtZW50cyIsImdldFBvc2l0aW9uRnJvbUV2ZW50IiwiZSIsIlRvdWNoRXZlbnQiLCJ0b3VjaGVzIiwiY2xpZW50WCIsImNsaWVudFkiLCJNb3VzZUV2ZW50Iiwic3RhcnREcmFnIiwib3JpZ2luU3F1YXJlIiwicGFyZW50RWxlbWVudCIsInNldEF0dHJpYnV0ZSIsInByZXZlbnREZWZhdWx0IiwiZG9EcmFnIiwiZ2V0QXR0cmlidXRlIiwicG9zaXRpb24iLCJsZWZ0IiwidG9wIiwiZW5kRHJhZyIsIm9yaWdpblNxdWFyZUlkIiwidGFyZ2V0RWxlbWVudCIsImVsZW1lbnRGcm9tUG9pbnQiLCJ0YXJnZXQiLCJkcm9wQmFsbCIsImRyYXciLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJzcXVhcmUiLCJiYWNrZ3JvdW5kQ29sb3IiXSwic291cmNlUm9vdCI6IiJ9