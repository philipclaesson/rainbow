(()=>{"use strict";const e=new class{audioContext;tracks=[];slowAverage=39;fx1a=null;fx1b=null;constructor(){this.audioContext=new AudioContext}async initAudio(e){if(16!==e.length)throw new Error("Expected 16 audio files.");const t=e.map((e=>this.loadAudioFile(e)));(await Promise.all(t)).forEach((e=>{const t=this.audioContext.createBufferSource(),n=this.audioContext.createGain();t.buffer=e,n.gain.value=0,t.connect(n);const o=this.audioContext.createAnalyser();o.fftSize=2048,n.connect(o),this.fx1a=this.audioContext.createBiquadFilter(),this.fx1a.type="highpass",this.fx1a.frequency.value=1e3,this.fx1a.gain.value=0,n.connect(this.fx1a),this.fx1b=this.audioContext.createDelay(),this.fx1b.delayTime.value=0,this.fx1a.connect(this.fx1b),n.connect(this.audioContext.destination),this.tracks.push({sourceNode:t,gainNode:n,analyserNode:o}),t.loop=!0,t.start(0)}))}async loadAudioFile(e){const t=await fetch(e),n=await t.arrayBuffer();return this.audioContext.decodeAudioData(n)}getFrequencyColor(e){if(0===this.tracks[e].gainNode.gain.value)return`hsl(${this.slowAverage+e}, 100%, 50%)`;const t=this.tracks[e].analyserNode,n=new Uint8Array(t.frequencyBinCount);t.getByteFrequencyData(n);const o=Math.max(...n),a=n.indexOf(o);return this.updateSlowAverage(a),`hsl(${this.slowAverage+e+10*a%240}, 100%, 50%)`}updateSlowAverage(e){this.slowAverage=this.slowAverage+.001*e%240}enableTrack(e,t){if(-1!=e){if(e>=this.tracks.length)throw new Error(`Track ${e} does not exist.`);console.log("Enabling track",e,t),this.tracks[e].gainNode.gain.value=t?.5:0}}muteAll(){for(let e=0;e<this.tracks.length;e++)this.enableTrack(e,!1)}fx1(e,t){if(0!=e&&0!=t&&Math.random()>.1)return;if(!this.fx1a||!this.fx1b)return;console.log("fx1 called with x:",e,"y:",t),console.log("AudioContext state:",this.audioContext.state),console.log("Current time:",this.audioContext.currentTime),console.log("Applying gain:",25*e,"to fx1a");const n=Math.floor(10*e);this.fx1a.gain.setValueAtTime(n,this.audioContext.currentTime),this.fx1b.delayTime.setValueAtTime(t,this.audioContext.currentTime),console.log(this.fx1a,this.fx1b)}},t=16;var n=!1,o=!1,a=null;function s(e,t,n,o){const a=document.createElement(e);return a.classList.add(t),a.id=n,o.appendChild(a),a}function i(e){document.querySelectorAll(".ball").forEach((t=>{t.style.display=e?"block":"none"}))}function r(e){if(!e)return-1;const t=e.split("square-");return t.length<2?-1:parseInt(t[1])}function l(e){if(e)s("div","spinner","spinner",document.body);else{const e=document.getElementById("spinner");e?.remove()}}function d(){if(requestAnimationFrame(d),n)for(let n=0;n<t;n++){const t=document.getElementById(`square-${n}`);t&&(t.style.backgroundColor=e.getFrequencyColor(n))}}document.addEventListener("DOMContentLoaded",(()=>{!function(){const c=document.getElementById("start-button"),u=document.getElementById("info");c?.addEventListener("click",(async()=>{c.remove(),u?.remove(),l(!0),await async function(){n||(await e.initAudio(["stems/4-on-floor.wav","stems/bass.wav","stems/dnb-124.wav","stems/drums.wav","stems/hats.wav","stems/kick-hat.wav","stems/smooth-chords.wav","stems/toms.wav","stems/guitar.wav","stems/bass.wav","stems/dnb-124.wav","stems/drums.wav","stems/hats.wav","stems/kick-hat.wav","stems/smooth-chords.wav","stems/extacy.wav"]),n=!0)}(),l(!1),function(){const e=s("div","matrix","matrix",document.body);for(let n=0;n<t;n++)s("div","square",`square-${n}`,e);a=s("div","ballhome","ballhome",document.body);for(let e=0;e<4;e++){const t=s("div","ball",`ball-${e}`,a);t.draggable=!0,t.innerText="ðŸŒˆ"}}(),function(){const t=document.querySelectorAll(".ball"),n=document.querySelectorAll(".square");let s=null,l=null;const d=t=>{s&&(console.log("Dropped:",s.id,t.id),e.enableTrack(r(t.id),!0),t.appendChild(s),l=null,s.style.display="block",s=null)};if(t.forEach((t=>{t.addEventListener("dragstart",(e=>{s=t;const n=t.parentElement;t.setAttribute("origin-square",n.id),console.log("[Dragstart]: Lifted",t.id,"from",n.id)})),t.addEventListener("dragend",(n=>{const o=t.getAttribute("origin-square");e.enableTrack(r(o),!1),console.log("[Dragend]: Dropped",t.id,"from",o)})),t.addEventListener("touchstart",(e=>{o=!0,s=t;const n=t.parentElement;t.setAttribute("origin-square",n.id),console.log("[Touchstart] Lifted",t.id,"from",n.id)})),t.addEventListener("touchmove",(e=>{if(console.log("[Touchmove] Dragging",t.id,e.touches.length),e.preventDefault(),o=!0,1===e.touches.length){const n=e.touches[0];t.style.left=n.clientX-25+"px",t.style.top=n.clientY-25+"px"}})),t.addEventListener("touchend",(n=>{const o=t.getAttribute("origin-square");e.enableTrack(r(o),!1),i(!1);const a=n.changedTouches[0],s=document.elementFromPoint(a.clientX,a.clientY);i(!0),d(s),console.log("[Touchend] Dropped",t.id)}))})),n.forEach((e=>{e.addEventListener("dragover",(e=>{e.preventDefault()})),e.addEventListener("drop",(t=>{t.preventDefault(),d(e)}))})),!a)throw new Error("Ball home not found");a.addEventListener("dragover",(e=>{e.preventDefault()})),a.addEventListener("drop",(e=>{if(e.preventDefault(),!a)throw new Error("Ball home not found");d(a)})),document.addEventListener("dragover",(e=>{o||e.preventDefault()})),document.addEventListener("drop",(e=>{if(!o){const e=document.getElementById("ballhome");d(e)}}))}(),d()}))}()}))})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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RUFBS0MsTUFBTXNDLElBQVNILEVBQU1JLFFBQVUsR0FBbkIsSSxLQUlyQnhDLEVBQUtlLGlCQUFpQixZQUFhYyxJQUVqQyxNQUFNRyxFQUFpQmhDLEVBQUtpQyxhQUFhLGlCQUN6Q3pILEVBQUd3RCxZQUFZbUMsRUFBWTZCLElBQWlCLEdBRzVDbkMsR0FBVSxHQUNWLE1BQU11QyxFQUFRUCxFQUFFWSxlQUFlLEdBQ3pCQyxFQUFnQmpELFNBQVNrRCxpQkFDN0JQLEVBQU1FLFFBQ05GLEVBQU1JLFNBRVIzQyxHQUFVLEdBRVY4QixFQUFTZSxHQUNUdkUsUUFBUUMsSUFBSSxxQkFBc0I0QixFQUFLVixHQUFHLEdBQzFDLElBR0prQyxFQUFRN0YsU0FBU2tGLElBQ2ZBLEVBQU9FLGlCQUFpQixZQUFhYyxJQUNuQ0EsRUFBRU0sZ0JBQWdCLElBR3BCdEIsRUFBT0UsaUJBQWlCLFFBQVNjLElBQy9CQSxFQUFFTSxpQkFDRlIsRUFBU2QsRUFBTyxHQUNoQixLQUdDM0IsRUFDSCxNQUFNLElBQUk5RCxNQUFNLHVCQUVsQjhELEVBQVM2QixpQkFBaUIsWUFBYWMsSUFDckNBLEVBQUVNLGdCQUFnQixJQUdwQmpELEVBQVM2QixpQkFBaUIsUUFBU2MsSUFFakMsR0FEQUEsRUFBRU0sa0JBQ0dqRCxFQUNILE1BQU0sSUFBSTlELE1BQU0sdUJBRWxCdUcsRUFBU3pDLEVBQVMsSUFHcEJPLFNBQVNzQixpQkFBaUIsWUFBYWMsSUFDaEM1QyxHQUNINEMsRUFBRU0sZ0IsSUFHTjFDLFNBQVNzQixpQkFBaUIsUUFBU2MsSUFDakMsSUFBSzVDLEVBQWEsQ0FDaEIsTUFBTUMsRUFBV08sU0FBU2dCLGVBQWUsWUFDekNrQixFQUFTekMsRSxJQUdmLENBc0lJMEQsR0FFQWpDLEdBQU0sR0FFVixDQUdFa0MsRUFBbUIsRyIsInNvdXJjZXMiOlsid2VicGFjazovL3NxdWFyZXMvLi9zcmMvbWFpbi50cyIsIndlYnBhY2s6Ly9zcXVhcmVzLy4vc3JjL2F1ZGlvLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEF1ZGlvQ29udHJvbGxlciB9IGZyb20gXCIuL2F1ZGlvXCI7XG5cbmNvbnN0IGFjID0gbmV3IEF1ZGlvQ29udHJvbGxlcigpO1xuY29uc3QgblNxdWFyZXMgPSAxNjtcbmNvbnN0IG5CYWxscyA9IDQ7XG52YXIgaXNJbml0aWF0ZWQgPSBmYWxzZTtcbnZhciBtb2JpbGVVc2FnZSA9IGZhbHNlO1xudmFyIGJhbGxIb21lOiBIVE1MRWxlbWVudCB8IG51bGwgPSBudWxsO1xudmFyIGZ4RW5hYmxlID0gZmFsc2U7XG5cbmZ1bmN0aW9uIGNyZWF0ZVVJRWxlbWVudHMoKSB7XG4gIC8vIENyZWF0ZSBGWCB1aVxuICBpZiAoZnhFbmFibGUpIHtcbiAgICBjb25zdCBmeGRpdiA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJmeFwiLCBcImZ4XCIsIGRvY3VtZW50LmJvZHkpO1xuICAgIGZ4ZGl2LnN0eWxlLmRpc3BsYXkgPSBmeEVuYWJsZSA/IFwiYmxvY2tcIiA6IFwibm9uZVwiO1xuICAgIGNvbnN0IGZ4MSA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJmeDFcIiwgXCJmeDFcIiwgZnhkaXYpO1xuICAgIGZ4MS5pbm5lclRleHQgPSBcIvCfjIpcIjtcbiAgICBjb25zdCBmeHNwYWNlciA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJmeHNwYWNlclwiLCBcImZ4c3BhY2VyXCIsIGZ4ZGl2KTtcbiAgICBjb25zdCBmeDIgPSBjcmVhdGVFbGVtZW50KFwiZGl2XCIsIFwiZngyXCIsIFwiZngyXCIsIGZ4ZGl2KTtcbiAgICBmeDIuaW5uZXJUZXh0ID0gXCLwn5WlXCI7XG4gIH1cblxuICBjb25zdCBtYXRyaXggPSBjcmVhdGVFbGVtZW50KFwiZGl2XCIsIFwibWF0cml4XCIsIFwibWF0cml4XCIsIGRvY3VtZW50LmJvZHkpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IG5TcXVhcmVzOyBpKyspIHtcbiAgICBjcmVhdGVFbGVtZW50KFwiZGl2XCIsIFwic3F1YXJlXCIsIGBzcXVhcmUtJHtpfWAsIG1hdHJpeCk7XG4gIH1cbiAgYmFsbEhvbWUgPSBjcmVhdGVFbGVtZW50KFwiZGl2XCIsIFwiYmFsbGhvbWVcIiwgXCJiYWxsaG9tZVwiLCBkb2N1bWVudC5ib2R5KTtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IG5CYWxsczsgaSsrKSB7XG4gICAgY29uc3QgYmFsbCA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJiYWxsXCIsIGBiYWxsLSR7aX1gLCBiYWxsSG9tZSk7XG4gICAgYmFsbC5kcmFnZ2FibGUgPSB0cnVlO1xuICAgIGJhbGwuaW5uZXJUZXh0ID0gYPCfjIhgO1xuICB9XG59XG5cbmZ1bmN0aW9uIGluaXRVSUxvZ2ljKCkge1xuICBjb25zdCBiYWxsczogTm9kZUxpc3RPZjxIVE1MRWxlbWVudD4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLmJhbGxcIik7XG4gIGNvbnN0IHNxdWFyZXM6IE5vZGVMaXN0T2Y8SFRNTEVsZW1lbnQ+ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5zcXVhcmVcIik7XG4gIGxldCBhY3RpdmVCYWxsOiBIVE1MRWxlbWVudCB8IG51bGwgPSBudWxsO1xuICBsZXQgb3JpZ2luU3F1YXJlOiBIVE1MRWxlbWVudCB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0IGRyb3BCYWxsID0gKHRhcmdldDogSFRNTEVsZW1lbnQpID0+IHtcbiAgICBpZiAoYWN0aXZlQmFsbCkge1xuICAgICAgY29uc29sZS5sb2coXCJEcm9wcGVkOlwiLCBhY3RpdmVCYWxsLmlkLCB0YXJnZXQuaWQpO1xuICAgICAgYWMuZW5hYmxlVHJhY2soZ2V0U3F1YXJlSWQodGFyZ2V0LmlkKSwgdHJ1ZSk7XG4gICAgICB0YXJnZXQuYXBwZW5kQ2hpbGQoYWN0aXZlQmFsbCk7XG4gICAgICBvcmlnaW5TcXVhcmUgPSBudWxsO1xuICAgICAgYWN0aXZlQmFsbC5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiOyAvLyBNYWtlIHN1cmUgdG8gZGlzcGxheSB0aGUgYmFsbCBhZ2FpblxuICAgICAgYWN0aXZlQmFsbCA9IG51bGw7XG4gICAgfVxuICB9O1xuXG4gIGJhbGxzLmZvckVhY2goKGJhbGwpID0+IHtcbiAgICBiYWxsLmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnc3RhcnRcIiwgKGU6IERyYWdFdmVudCkgPT4ge1xuICAgICAgYWN0aXZlQmFsbCA9IGJhbGw7XG4gICAgICBjb25zdCBvcmlnaW5TcXVhcmUgPSBiYWxsLnBhcmVudEVsZW1lbnQgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICBiYWxsLnNldEF0dHJpYnV0ZShcIm9yaWdpbi1zcXVhcmVcIiwgb3JpZ2luU3F1YXJlLmlkKTtcbiAgICAgIGNvbnNvbGUubG9nKFwiW0RyYWdzdGFydF06IExpZnRlZFwiLCBiYWxsLmlkLCBcImZyb21cIiwgb3JpZ2luU3F1YXJlLmlkKTtcbiAgICB9KTtcblxuICAgIGJhbGwuYWRkRXZlbnRMaXN0ZW5lcihcImRyYWdlbmRcIiwgKGU6IERyYWdFdmVudCkgPT4ge1xuICAgICAgLy8gTXV0ZSB0aGUgc3F1YXJlIHRoYXQgdGhlIGJhbGwgY2FtZSBmcm9tXG4gICAgICBjb25zdCBvcmlnaW5TcXVhcmVJZCA9IGJhbGwuZ2V0QXR0cmlidXRlKFwib3JpZ2luLXNxdWFyZVwiKTtcbiAgICAgIGFjLmVuYWJsZVRyYWNrKGdldFNxdWFyZUlkKG9yaWdpblNxdWFyZUlkKSwgZmFsc2UpO1xuICAgICAgY29uc29sZS5sb2coXCJbRHJhZ2VuZF06IERyb3BwZWRcIiwgYmFsbC5pZCwgXCJmcm9tXCIsIG9yaWdpblNxdWFyZUlkKTtcbiAgICB9KTtcblxuICAgIGJhbGwuYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNoc3RhcnRcIiwgKGU6IFRvdWNoRXZlbnQpID0+IHtcbiAgICAgIG1vYmlsZVVzYWdlID0gdHJ1ZTtcbiAgICAgIGFjdGl2ZUJhbGwgPSBiYWxsO1xuICAgICAgY29uc3Qgb3JpZ2luU3F1YXJlID0gYmFsbC5wYXJlbnRFbGVtZW50IGFzIEhUTUxFbGVtZW50O1xuICAgICAgYmFsbC5zZXRBdHRyaWJ1dGUoXCJvcmlnaW4tc3F1YXJlXCIsIG9yaWdpblNxdWFyZS5pZCk7XG4gICAgICBjb25zb2xlLmxvZyhcIltUb3VjaHN0YXJ0XSBMaWZ0ZWRcIiwgYmFsbC5pZCwgXCJmcm9tXCIsIG9yaWdpblNxdWFyZS5pZCk7XG4gICAgfSk7XG5cbiAgICBiYWxsLmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaG1vdmVcIiwgKGU6IFRvdWNoRXZlbnQpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKFwiW1RvdWNobW92ZV0gRHJhZ2dpbmdcIiwgYmFsbC5pZCwgZS50b3VjaGVzLmxlbmd0aCk7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBtb2JpbGVVc2FnZSA9IHRydWU7XG4gICAgICBpZiAoZS50b3VjaGVzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICBjb25zdCB0b3VjaCA9IGUudG91Y2hlc1swXTtcbiAgICAgICAgYmFsbC5zdHlsZS5sZWZ0ID0gYCR7dG91Y2guY2xpZW50WCAtIDI1fXB4YDsgLy8gQWRqdXN0IGZvciBjZW50ZXIgb2YgdGhlIGJhbGxcbiAgICAgICAgYmFsbC5zdHlsZS50b3AgPSBgJHt0b3VjaC5jbGllbnRZIC0gMjV9cHhgO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgYmFsbC5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hlbmRcIiwgKGU6IFRvdWNoRXZlbnQpID0+IHtcbiAgICAgIC8vIE11dGUgdGhlIHNxdWFyZSB0aGF0IHRoZSBiYWxsIGNhbWUgZnJvbVxuICAgICAgY29uc3Qgb3JpZ2luU3F1YXJlSWQgPSBiYWxsLmdldEF0dHJpYnV0ZShcIm9yaWdpbi1zcXVhcmVcIik7XG4gICAgICBhYy5lbmFibGVUcmFjayhnZXRTcXVhcmVJZChvcmlnaW5TcXVhcmVJZCksIGZhbHNlKTtcblxuICAgICAgLy8gaGlkZSBiYWxscyB3aGlsZSB3ZSBmaW5kIHRoZSB0YXJnZXQgZWxlbWVudFxuICAgICAgc2hvd0JhbGxzKGZhbHNlKTtcbiAgICAgIGNvbnN0IHRvdWNoID0gZS5jaGFuZ2VkVG91Y2hlc1swXTtcbiAgICAgIGNvbnN0IHRhcmdldEVsZW1lbnQgPSBkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50KFxuICAgICAgICB0b3VjaC5jbGllbnRYLFxuICAgICAgICB0b3VjaC5jbGllbnRZXG4gICAgICApIGFzIEhUTUxFbGVtZW50O1xuICAgICAgc2hvd0JhbGxzKHRydWUpO1xuXG4gICAgICBkcm9wQmFsbCh0YXJnZXRFbGVtZW50KTtcbiAgICAgIGNvbnNvbGUubG9nKFwiW1RvdWNoZW5kXSBEcm9wcGVkXCIsIGJhbGwuaWQpO1xuICAgIH0pO1xuICB9KTtcblxuICBzcXVhcmVzLmZvckVhY2goKHNxdWFyZSkgPT4ge1xuICAgIHNxdWFyZS5hZGRFdmVudExpc3RlbmVyKFwiZHJhZ292ZXJcIiwgKGU6IERyYWdFdmVudCkgPT4ge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIH0pO1xuXG4gICAgc3F1YXJlLmFkZEV2ZW50TGlzdGVuZXIoXCJkcm9wXCIsIChlOiBEcmFnRXZlbnQpID0+IHtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGRyb3BCYWxsKHNxdWFyZSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGlmICghYmFsbEhvbWUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJCYWxsIGhvbWUgbm90IGZvdW5kXCIpO1xuICB9XG4gIGJhbGxIb21lLmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnb3ZlclwiLCAoZTogRHJhZ0V2ZW50KSA9PiB7XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICB9KTtcblxuICBiYWxsSG9tZS5hZGRFdmVudExpc3RlbmVyKFwiZHJvcFwiLCAoZTogRHJhZ0V2ZW50KSA9PiB7XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGlmICghYmFsbEhvbWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkJhbGwgaG9tZSBub3QgZm91bmRcIik7XG4gICAgfVxuICAgIGRyb3BCYWxsKGJhbGxIb21lKTtcbiAgfSk7XG5cbiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImRyYWdvdmVyXCIsIChlKSA9PiB7XG4gICAgaWYgKCFtb2JpbGVVc2FnZSkge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOyAvLyBUaGlzIGFsbG93cyB0aGUgZHJvcCB0byBiZSBhY2NlcHRlZC5cbiAgICB9XG4gIH0pO1xuICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwiZHJvcFwiLCAoZSkgPT4ge1xuICAgIGlmICghbW9iaWxlVXNhZ2UpIHtcbiAgICAgIGNvbnN0IGJhbGxIb21lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJiYWxsaG9tZVwiKSBhcyBIVE1MRWxlbWVudDtcbiAgICAgIGRyb3BCYWxsKGJhbGxIb21lKTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBpbml0RlhVSSgpIHtcbiAgaWYgKCFmeEVuYWJsZSkge1xuICAgIHJldHVybjtcbiAgfVxuICBjb25zdCBmeDEgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImZ4MVwiKTtcbiAgaWYgKCFmeDEpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJmeDEgbm90IGZvdW5kXCIpO1xuICB9XG4gIGZ4MS5kcmFnZ2FibGUgPSB0cnVlO1xuICBjb25zdCBmeDIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImZ4MlwiKTtcbiAgZngxPy5hZGRFdmVudExpc3RlbmVyKFwiZHJhZ3N0YXJ0XCIsIChlOiBEcmFnRXZlbnQpID0+IHtcbiAgICBjb25zdCB7IHgsIHkgfSA9IG5vcm1hbGl6ZWRYWShlLngsIGUueSk7XG4gICAgYWMuZngxKHgsIHkpO1xuICAgIGNvbnNvbGUubG9nKFwiZHJhZ3N0YXJ0XCIpO1xuICB9KTtcbiAgZngxPy5hZGRFdmVudExpc3RlbmVyKFwiZHJhZ1wiLCAoZTogRHJhZ0V2ZW50KSA9PiB7XG4gICAgY29uc3QgeyB4LCB5IH0gPSBub3JtYWxpemVkWFkoZS54LCBlLnkpO1xuICAgIGFjLmZ4MSh4LCB5KTtcbiAgICBjb25zb2xlLmxvZyhcImRyYWdtb3ZlXCIpO1xuICB9KTtcbiAgZngxPy5hZGRFdmVudExpc3RlbmVyKFwiZHJhZ2VuZFwiLCAoZTogRHJhZ0V2ZW50KSA9PiB7XG4gICAgYWMuZngxKDAsIDApO1xuICAgIGNvbnNvbGUubG9nKFwiZHJhZ2VuZFwiKTtcbiAgfSk7XG4gIGZ4MT8uYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNoc3RhcnRcIiwgKGU6IFRvdWNoRXZlbnQpID0+IHtcbiAgICBpZiAoZS50b3VjaGVzLmxlbmd0aCAhPSAxKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHRvdWNoID0gZS50b3VjaGVzWzBdO1xuICAgIGNvbnN0IHsgeCwgeSB9ID0gbm9ybWFsaXplZFhZKHRvdWNoLmNsaWVudFgsIHRvdWNoLmNsaWVudFkpO1xuICAgIGFjLmZ4MSh4LCB5KTtcbiAgICBjb25zb2xlLmxvZyhcInRvdWNoc3RhcnRcIik7XG4gIH0pO1xuICBmeDE/LmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaG1vdmVcIiwgKGU6IFRvdWNoRXZlbnQpID0+IHtcbiAgICBpZiAoZS50b3VjaGVzLmxlbmd0aCAhPSAxKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHRvdWNoID0gZS50b3VjaGVzWzBdO1xuICAgIGNvbnN0IHsgeCwgeSB9ID0gbm9ybWFsaXplZFhZKHRvdWNoLmNsaWVudFgsIHRvdWNoLmNsaWVudFkpO1xuICAgIGFjLmZ4MSh4LCB5KTtcbiAgICBjb25zb2xlLmxvZyhcInRvdWNobW92ZVwiKTtcbiAgfSk7XG4gIGZ4MT8uYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNoZW5kXCIsIChlOiBUb3VjaEV2ZW50KSA9PiB7XG4gICAgaWYgKGUudG91Y2hlcy5sZW5ndGggIT0gMSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBhYy5meDEoMCwgMCk7XG4gICAgY29uc29sZS5sb2coXCJ0b3VjaGVuZFwiKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQoXG4gIHRhZzogc3RyaW5nLFxuICBjbHM6IHN0cmluZyxcbiAgaWQ6IHN0cmluZyxcbiAgcGFyZW50OiBIVE1MRWxlbWVudFxuKSB7XG4gIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZyk7XG4gIGVsZW1lbnQuY2xhc3NMaXN0LmFkZChjbHMpO1xuICBlbGVtZW50LmlkID0gaWQ7XG4gIHBhcmVudC5hcHBlbmRDaGlsZChlbGVtZW50KTtcbiAgcmV0dXJuIGVsZW1lbnQ7XG59XG5cbmZ1bmN0aW9uIHNob3dCYWxscyhzaG93OiBib29sZWFuKSB7XG4gIGNvbnN0IGJhbGxzOiBOb2RlTGlzdE9mPEhUTUxFbGVtZW50PiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCIuYmFsbFwiKTtcbiAgYmFsbHMuZm9yRWFjaCgoYmFsbCkgPT4ge1xuICAgIGJhbGwuc3R5bGUuZGlzcGxheSA9IHNob3cgPyBcImJsb2NrXCIgOiBcIm5vbmVcIjtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGdldFNxdWFyZUlkKGlkOiBzdHJpbmcgfCBudWxsKTogbnVtYmVyIHtcbiAgaWYgKCFpZCkge1xuICAgIHJldHVybiAtMTtcbiAgfVxuICBjb25zdCBwYXJ0cyA9IGlkLnNwbGl0KFwic3F1YXJlLVwiKTtcbiAgaWYgKHBhcnRzLmxlbmd0aCA8IDIpIHtcbiAgICByZXR1cm4gLTE7XG4gIH1cbiAgcmV0dXJuIHBhcnNlSW50KHBhcnRzWzFdKTtcbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplZFhZKHg6IG51bWJlciwgeTogbnVtYmVyKSB7XG4gIGNvbnN0IHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7XG4gIGNvbnN0IGhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDtcbiAgcmV0dXJuIHsgeDogeCAvIHdpZHRoLCB5OiB5IC8gaGVpZ2h0IH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluaXRBdWRpbygpIHtcbiAgaWYgKGlzSW5pdGlhdGVkKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGF3YWl0IGFjLmluaXRBdWRpbyhbXG4gICAgXCJzdGVtcy80LW9uLWZsb29yLndhdlwiLFxuICAgIFwic3RlbXMvYmFzcy53YXZcIixcbiAgICBcInN0ZW1zL2RuYi0xMjQud2F2XCIsXG4gICAgXCJzdGVtcy9kcnVtcy53YXZcIixcbiAgICBcInN0ZW1zL2hhdHMud2F2XCIsXG4gICAgXCJzdGVtcy9raWNrLWhhdC53YXZcIixcbiAgICBcInN0ZW1zL3Ntb290aC1jaG9yZHMud2F2XCIsXG4gICAgXCJzdGVtcy90b21zLndhdlwiLFxuICAgIFwic3RlbXMvZ3VpdGFyLndhdlwiLFxuICAgIFwic3RlbXMvYmFzcy53YXZcIixcbiAgICBcInN0ZW1zL2RuYi0xMjQud2F2XCIsXG4gICAgXCJzdGVtcy9kcnVtcy53YXZcIixcbiAgICBcInN0ZW1zL2hhdHMud2F2XCIsXG4gICAgXCJzdGVtcy9raWNrLWhhdC53YXZcIixcbiAgICBcInN0ZW1zL3Ntb290aC1jaG9yZHMud2F2XCIsXG4gICAgXCJzdGVtcy9leHRhY3kud2F2XCIsXG4gIF0pO1xuICBpc0luaXRpYXRlZCA9IHRydWU7XG59XG5cbmZ1bmN0aW9uIHNwaW5uZXIoc2hvdzogYm9vbGVhbikge1xuICBpZiAoc2hvdykge1xuICAgIGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJzcGlubmVyXCIsIFwic3Bpbm5lclwiLCBkb2N1bWVudC5ib2R5KTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBzcGlubmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJzcGlubmVyXCIpO1xuICAgIHNwaW5uZXI/LnJlbW92ZSgpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVN0YXJ0QnV0dG9uKCkge1xuICBjb25zdCBzdGFydEJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwic3RhcnQtYnV0dG9uXCIpO1xuICBjb25zdCBpbmZvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJpbmZvXCIpO1xuICBzdGFydEJ1dHRvbj8uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGFzeW5jICgpID0+IHtcbiAgICBzdGFydEJ1dHRvbi5yZW1vdmUoKTtcbiAgICBpbmZvPy5yZW1vdmUoKTtcbiAgICBzcGlubmVyKHRydWUpO1xuICAgIGF3YWl0IGluaXRBdWRpbygpO1xuICAgIHNwaW5uZXIoZmFsc2UpO1xuICAgIGNyZWF0ZVVJRWxlbWVudHMoKTtcbiAgICBpbml0VUlMb2dpYygpO1xuICAgIGluaXRGWFVJKCk7XG4gICAgZHJhdygpO1xuICB9KTtcbn1cblxuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIkRPTUNvbnRlbnRMb2FkZWRcIiwgKCkgPT4ge1xuICBjcmVhdGVTdGFydEJ1dHRvbigpO1xufSk7XG5cbmZ1bmN0aW9uIGRyYXcoKSB7XG4gIHJlcXVlc3RBbmltYXRpb25GcmFtZShkcmF3KTtcbiAgaWYgKCFpc0luaXRpYXRlZCkge1xuICAgIHJldHVybjtcbiAgfVxuICBmb3IgKGxldCBpID0gMDsgaSA8IG5TcXVhcmVzOyBpKyspIHtcbiAgICBjb25zdCBzcXVhcmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgc3F1YXJlLSR7aX1gKSBhcyBIVE1MRWxlbWVudDtcbiAgICBpZiAoc3F1YXJlKSB7XG4gICAgICBzcXVhcmUuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gYWMuZ2V0RnJlcXVlbmN5Q29sb3IoaSk7XG4gICAgfVxuICB9XG59XG4iLCJleHBvcnQgY2xhc3MgQXVkaW9Db250cm9sbGVyIHtcbiAgcHJpdmF0ZSBhdWRpb0NvbnRleHQ6IEF1ZGlvQ29udGV4dDtcbiAgcHJpdmF0ZSB0cmFja3M6IHtcbiAgICBzb3VyY2VOb2RlOiBBdWRpb0J1ZmZlclNvdXJjZU5vZGU7XG4gICAgZ2Fpbk5vZGU6IEdhaW5Ob2RlO1xuICAgIGFuYWx5c2VyTm9kZTogQW5hbHlzZXJOb2RlO1xuICB9W10gPSBbXTtcbiAgcHJpdmF0ZSBzbG93QXZlcmFnZTogbnVtYmVyID0gMzk7IC8vIG9yYW5nZVxuICBwcml2YXRlIGZ4MWE6IEJpcXVhZEZpbHRlck5vZGUgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBmeDFiOiBEZWxheU5vZGUgfCBudWxsID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmF1ZGlvQ29udGV4dCA9IG5ldyBBdWRpb0NvbnRleHQoKTtcbiAgfVxuXG4gIGFzeW5jIGluaXRBdWRpbyhmaWxlTmFtZXM6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKGZpbGVOYW1lcy5sZW5ndGggIT09IDE2KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFeHBlY3RlZCAxNiBhdWRpbyBmaWxlcy5cIik7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsZVByb21pc2VzID0gZmlsZU5hbWVzLm1hcCgoZmlsZU5hbWUpID0+XG4gICAgICB0aGlzLmxvYWRBdWRpb0ZpbGUoZmlsZU5hbWUpXG4gICAgKTtcblxuICAgIGNvbnN0IGF1ZGlvQnVmZmVycyA9IGF3YWl0IFByb21pc2UuYWxsKGZpbGVQcm9taXNlcyk7XG5cbiAgICBhdWRpb0J1ZmZlcnMuZm9yRWFjaCgoYnVmZmVyKSA9PiB7XG4gICAgICBjb25zdCBzb3VyY2VOb2RlID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlQnVmZmVyU291cmNlKCk7XG4gICAgICBjb25zdCBnYWluTm9kZSA9IHRoaXMuYXVkaW9Db250ZXh0LmNyZWF0ZUdhaW4oKTtcblxuICAgICAgc291cmNlTm9kZS5idWZmZXIgPSBidWZmZXI7XG4gICAgICBnYWluTm9kZS5nYWluLnZhbHVlID0gMDsgLy8gU3RhcnQgbXV0ZWRcbiAgICAgIHNvdXJjZU5vZGUuY29ubmVjdChnYWluTm9kZSk7XG5cbiAgICAgIC8vIHNldCB1cCBhbiBhbmFseXNlciBzbyB3ZSBjYW4gZG8gY29vbCB2aXN1YWxzXG4gICAgICBjb25zdCBhbmFseXNlck5vZGUgPSB0aGlzLmF1ZGlvQ29udGV4dC5jcmVhdGVBbmFseXNlcigpO1xuICAgICAgYW5hbHlzZXJOb2RlLmZmdFNpemUgPSAyMDQ4O1xuICAgICAgZ2Fpbk5vZGUuY29ubmVjdChhbmFseXNlck5vZGUpO1xuXG4gICAgICAvLyBzZXQgdXAgZnggbm9kZXNcbiAgICAgIHRoaXMuZngxYSA9IHRoaXMuYXVkaW9Db250ZXh0LmNyZWF0ZUJpcXVhZEZpbHRlcigpO1xuICAgICAgdGhpcy5meDFhLnR5cGUgPSBcImhpZ2hwYXNzXCI7XG4gICAgICB0aGlzLmZ4MWEuZnJlcXVlbmN5LnZhbHVlID0gMTAwMDtcbiAgICAgIHRoaXMuZngxYS5nYWluLnZhbHVlID0gMDtcbiAgICAgIGdhaW5Ob2RlLmNvbm5lY3QodGhpcy5meDFhKTtcblxuICAgICAgdGhpcy5meDFiID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlRGVsYXkoKTtcbiAgICAgIHRoaXMuZngxYi5kZWxheVRpbWUudmFsdWUgPSAwOyAvLyBwYXNzIHRocm91Z2hcbiAgICAgIHRoaXMuZngxYS5jb25uZWN0KHRoaXMuZngxYik7XG5cbiAgICAgIC8vIGZvciBub3cganVzdCBieXBhc3MgdGhlIEZYIG5vZGVzIC0gbm90IGltcGxlbWVudGVkIHByb3Blcmx5IHlldFxuICAgICAgLy8gICB0aGlzLmZ4MWIuY29ubmVjdCh0aGlzLmF1ZGlvQ29udGV4dC5kZXN0aW5hdGlvbik7XG4gICAgICBnYWluTm9kZS5jb25uZWN0KHRoaXMuYXVkaW9Db250ZXh0LmRlc3RpbmF0aW9uKTtcblxuICAgICAgdGhpcy50cmFja3MucHVzaCh7IHNvdXJjZU5vZGUsIGdhaW5Ob2RlLCBhbmFseXNlck5vZGUgfSk7XG5cbiAgICAgIHNvdXJjZU5vZGUubG9vcCA9IHRydWU7XG4gICAgICBzb3VyY2VOb2RlLnN0YXJ0KDApOyAvLyBQbGF5IGltbWVkaWF0ZWx5IGluIHN5bmNcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbG9hZEF1ZGlvRmlsZSh1cmw6IHN0cmluZyk6IFByb21pc2U8QXVkaW9CdWZmZXI+IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCk7XG4gICAgY29uc3QgYXJyYXlCdWZmZXIgPSBhd2FpdCByZXNwb25zZS5hcnJheUJ1ZmZlcigpO1xuICAgIHJldHVybiB0aGlzLmF1ZGlvQ29udGV4dC5kZWNvZGVBdWRpb0RhdGEoYXJyYXlCdWZmZXIpO1xuICB9XG5cbiAgZ2V0RnJlcXVlbmN5Q29sb3IodHJhY2s6IG51bWJlcik6IHN0cmluZyB7XG4gICAgY29uc3QgZ2Fpbk5vZGUgPSB0aGlzLnRyYWNrc1t0cmFja10uZ2Fpbk5vZGU7XG4gICAgaWYgKGdhaW5Ob2RlLmdhaW4udmFsdWUgPT09IDApIHtcbiAgICAgIHJldHVybiBgaHNsKCR7dGhpcy5zbG93QXZlcmFnZSArIHRyYWNrfSwgMTAwJSwgNTAlKWA7XG4gICAgfVxuICAgIGNvbnN0IGFuYWx5c2VyTm9kZSA9IHRoaXMudHJhY2tzW3RyYWNrXS5hbmFseXNlck5vZGU7XG4gICAgY29uc3QgZGF0YUFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYW5hbHlzZXJOb2RlLmZyZXF1ZW5jeUJpbkNvdW50KTtcbiAgICBhbmFseXNlck5vZGUuZ2V0Qnl0ZUZyZXF1ZW5jeURhdGEoZGF0YUFycmF5KTtcblxuICAgIC8vIGdldCB0aGUgaGlnaGVzdCBmcmVxdWVuY3lcbiAgICBjb25zdCBtYXggPSBNYXRoLm1heCguLi5kYXRhQXJyYXkpO1xuICAgIGNvbnN0IG1heEluZGV4ID0gZGF0YUFycmF5LmluZGV4T2YobWF4KTtcbiAgICB0aGlzLnVwZGF0ZVNsb3dBdmVyYWdlKG1heEluZGV4KTtcblxuICAgIGNvbnN0IGh1ZSA9IHRoaXMuc2xvd0F2ZXJhZ2UgKyB0cmFjayArICgobWF4SW5kZXggKiAxMCkgJSAyNDApO1xuICAgIHJldHVybiBgaHNsKCR7aHVlfSwgMTAwJSwgNTAlKWA7XG4gIH1cblxuICB1cGRhdGVTbG93QXZlcmFnZSh2YWx1ZTogbnVtYmVyKSB7XG4gICAgdGhpcy5zbG93QXZlcmFnZSA9IHRoaXMuc2xvd0F2ZXJhZ2UgKyAoKHZhbHVlICogMC4wMDEpICUgMjQwKTtcbiAgfVxuXG4gIGVuYWJsZVRyYWNrKHRyYWNrTnVtYmVyOiBudW1iZXIsIGVuYWJsZTogYm9vbGVhbik6IHZvaWQge1xuICAgIGlmICh0cmFja051bWJlciA9PSAtMSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodHJhY2tOdW1iZXIgPj0gdGhpcy50cmFja3MubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRyYWNrICR7dHJhY2tOdW1iZXJ9IGRvZXMgbm90IGV4aXN0LmApO1xuICAgIH1cbiAgICBjb25zb2xlLmxvZyhcIkVuYWJsaW5nIHRyYWNrXCIsIHRyYWNrTnVtYmVyLCBlbmFibGUpXG4gICAgdGhpcy50cmFja3NbdHJhY2tOdW1iZXJdLmdhaW5Ob2RlLmdhaW4udmFsdWUgPSBlbmFibGUgPyAwLjUgOiAwO1xuICB9XG5cbiAgbXV0ZUFsbCgpOiB2b2lkIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudHJhY2tzLmxlbmd0aDsgaSsrKSB7XG4gICAgICB0aGlzLmVuYWJsZVRyYWNrKGksIGZhbHNlKTtcbiAgICB9XG4gIH1cblxuICBmeDEoeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcbiAgICBpZiAoeCAhPSAwICYmIHkgIT0gMCkge1xuICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiAwLjEpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoIXRoaXMuZngxYSB8fCAhdGhpcy5meDFiKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnNvbGUubG9nKFwiZngxIGNhbGxlZCB3aXRoIHg6XCIsIHgsIFwieTpcIiwgeSk7XG4gICAgY29uc29sZS5sb2coXCJBdWRpb0NvbnRleHQgc3RhdGU6XCIsIHRoaXMuYXVkaW9Db250ZXh0LnN0YXRlKTtcbiAgICBjb25zb2xlLmxvZyhcIkN1cnJlbnQgdGltZTpcIiwgdGhpcy5hdWRpb0NvbnRleHQuY3VycmVudFRpbWUpO1xuXG4gICAgY29uc29sZS5sb2coXCJBcHBseWluZyBnYWluOlwiLCB4ICogMjUsIFwidG8gZngxYVwiKTtcbiAgICBjb25zdCBnYWluID0gTWF0aC5mbG9vcih4ICogMTApO1xuICAgIHRoaXMuZngxYS5nYWluLnNldFZhbHVlQXRUaW1lKGdhaW4sIHRoaXMuYXVkaW9Db250ZXh0LmN1cnJlbnRUaW1lKTtcbiAgICB0aGlzLmZ4MWIuZGVsYXlUaW1lLnNldFZhbHVlQXRUaW1lKHksIHRoaXMuYXVkaW9Db250ZXh0LmN1cnJlbnRUaW1lKTtcblxuICAgIGNvbnNvbGUubG9nKHRoaXMuZngxYSwgdGhpcy5meDFiKTtcbiAgfVxufVxuIl0sIm5hbWVzIjpbImFjIiwiYXVkaW9Db250ZXh0IiwidHJhY2tzIiwic2xvd0F2ZXJhZ2UiLCJmeDFhIiwiZngxYiIsImNvbnN0cnVjdG9yIiwidGhpcyIsIkF1ZGlvQ29udGV4dCIsImluaXRBdWRpbyIsImZpbGVOYW1lcyIsImxlbmd0aCIsIkVycm9yIiwiZmlsZVByb21pc2VzIiwibWFwIiwiZmlsZU5hbWUiLCJsb2FkQXVkaW9GaWxlIiwiUHJvbWlzZSIsImFsbCIsImZvckVhY2giLCJidWZmZXIiLCJzb3VyY2VOb2RlIiwiY3JlYXRlQnVmZmVyU291cmNlIiwiZ2Fpbk5vZGUiLCJjcmVhdGVHYWluIiwiZ2FpbiIsInZhbHVlIiwiY29ubmVjdCIsImFuYWx5c2VyTm9kZSIsImNyZWF0ZUFuYWx5c2VyIiwiZmZ0U2l6ZSIsImNyZWF0ZUJpcXVhZEZpbHRlciIsInR5cGUiLCJmcmVxdWVuY3kiLCJjcmVhdGVEZWxheSIsImRlbGF5VGltZSIsImRlc3RpbmF0aW9uIiwicHVzaCIsImxvb3AiLCJzdGFydCIsInVybCIsInJlc3BvbnNlIiwiZmV0Y2giLCJhcnJheUJ1ZmZlciIsImRlY29kZUF1ZGlvRGF0YSIsImdldEZyZXF1ZW5jeUNvbG9yIiwidHJhY2siLCJkYXRhQXJyYXkiLCJVaW50OEFycmF5IiwiZnJlcXVlbmN5QmluQ291bnQiLCJnZXRCeXRlRnJlcXVlbmN5RGF0YSIsIm1heCIsIk1hdGgiLCJtYXhJbmRleCIsImluZGV4T2YiLCJ1cGRhdGVTbG93QXZlcmFnZSIsImVuYWJsZVRyYWNrIiwidHJhY2tOdW1iZXIiLCJlbmFibGUiLCJjb25zb2xlIiwibG9nIiwibXV0ZUFsbCIsImkiLCJmeDEiLCJ4IiwieSIsInJhbmRvbSIsInN0YXRlIiwiY3VycmVudFRpbWUiLCJmbG9vciIsInNldFZhbHVlQXRUaW1lIiwiblNxdWFyZXMiLCJpc0luaXRpYXRlZCIsIm1vYmlsZVVzYWdlIiwiYmFsbEhvbWUiLCJjcmVhdGVFbGVtZW50IiwidGFnIiwiY2xzIiwiaWQiLCJwYXJlbnQiLCJlbGVtZW50IiwiZG9jdW1lbnQiLCJjbGFzc0xpc3QiLCJhZGQiLCJhcHBlbmRDaGlsZCIsInNob3dCYWxscyIsInNob3ciLCJxdWVyeVNlbGVjdG9yQWxsIiwiYmFsbCIsInN0eWxlIiwiZGlzcGxheSIsImdldFNxdWFyZUlkIiwicGFydHMiLCJzcGxpdCIsInBhcnNlSW50Iiwic3Bpbm5lciIsImJvZHkiLCJnZXRFbGVtZW50QnlJZCIsInJlbW92ZSIsImRyYXciLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJzcXVhcmUiLCJiYWNrZ3JvdW5kQ29sb3IiLCJhZGRFdmVudExpc3RlbmVyIiwic3RhcnRCdXR0b24iLCJpbmZvIiwiYXN5bmMiLCJtYXRyaXgiLCJkcmFnZ2FibGUiLCJpbm5lclRleHQiLCJjcmVhdGVVSUVsZW1lbnRzIiwiYmFsbHMiLCJzcXVhcmVzIiwiYWN0aXZlQmFsbCIsIm9yaWdpblNxdWFyZSIsImRyb3BCYWxsIiwidGFyZ2V0IiwiZSIsInBhcmVudEVsZW1lbnQiLCJzZXRBdHRyaWJ1dGUiLCJvcmlnaW5TcXVhcmVJZCIsImdldEF0dHJpYnV0ZSIsInRvdWNoZXMiLCJwcmV2ZW50RGVmYXVsdCIsInRvdWNoIiwibGVmdCIsImNsaWVudFgiLCJ0b3AiLCJjbGllbnRZIiwiY2hhbmdlZFRvdWNoZXMiLCJ0YXJnZXRFbGVtZW50IiwiZWxlbWVudEZyb21Qb2ludCIsImluaXRVSUxvZ2ljIiwiY3JlYXRlU3RhcnRCdXR0b24iXSwic291cmNlUm9vdCI6IiJ9