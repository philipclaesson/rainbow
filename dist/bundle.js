(()=>{"use strict";const e=new class{audioContext;tracks=[];slowAverage=39;fx1a=null;fx1b=null;constructor(){this.audioContext=new AudioContext}async initAudio(e){if(16!==e.length)throw new Error("Expected 16 audio files.");const t=e.map((e=>this.loadAudioFile(e)));(await Promise.all(t)).forEach((e=>{const t=this.audioContext.createBufferSource(),n=this.audioContext.createGain();t.buffer=e,n.gain.value=0,t.connect(n);const o=this.audioContext.createAnalyser();o.fftSize=2048,n.connect(o),this.fx1a=this.audioContext.createBiquadFilter(),this.fx1a.type="highpass",this.fx1a.frequency.value=1e3,this.fx1a.gain.value=0,n.connect(this.fx1a),this.fx1b=this.audioContext.createDelay(),this.fx1b.delayTime.value=0,this.fx1a.connect(this.fx1b),n.connect(this.audioContext.destination),this.tracks.push({sourceNode:t,gainNode:n,analyserNode:o}),t.loop=!0,t.start(0)}))}async loadAudioFile(e){const t=await fetch(e),n=await t.arrayBuffer();return this.audioContext.decodeAudioData(n)}getFrequencyColor(e){if(0===this.tracks[e].gainNode.gain.value)return`hsl(${this.slowAverage+e}, 100%, 50%)`;const t=this.tracks[e].analyserNode,n=new Uint8Array(t.frequencyBinCount);t.getByteFrequencyData(n);const o=Math.max(...n),a=n.indexOf(o);return this.updateSlowAverage(a),`hsl(${this.slowAverage+e+10*a%240}, 100%, 50%)`}updateSlowAverage(e){this.slowAverage=this.slowAverage+.001*e%240}unMuteTrack(e){if(-1!=e){if(!this.tracks[e])throw new Error(`Track ${e} does not exist.`);this.tracks[e].gainNode.gain.value=.5}}muteTrack(e){if(-1!=e){if(!this.tracks[e])throw new Error(`Track ${e} does not exist.`);this.tracks[e].gainNode.gain.value=0}}muteAll(){for(let e=0;e<this.tracks.length;e++)this.muteTrack(e)}fx1(e,t){if(0!=e&&0!=t&&Math.random()>.1)return;if(!this.fx1a||!this.fx1b)return;console.log("fx1 called with x:",e,"y:",t),console.log("AudioContext state:",this.audioContext.state),console.log("Current time:",this.audioContext.currentTime),console.log("Applying gain:",25*e,"to fx1a");const n=Math.floor(10*e);this.fx1a.gain.setValueAtTime(n,this.audioContext.currentTime),this.fx1b.delayTime.setValueAtTime(t,this.audioContext.currentTime),console.log(this.fx1a,this.fx1b)}},t=16;var n=!1,o=!1,a=null;function s(e,t,n,o){const a=document.createElement(e);return a.classList.add(t),a.id=n,o.appendChild(a),a}function i(e){document.querySelectorAll(".ball").forEach((t=>{t.style.display=e?"block":"none"}))}function r(e){if(!e)return-1;const t=e.split("square-");return t.length<2?-1:parseInt(t[1])}function l(e){if(e)s("div","spinner","spinner",document.body);else{const e=document.getElementById("spinner");e?.remove()}}function d(){if(requestAnimationFrame(d),n)for(let n=0;n<t;n++){const t=document.getElementById(`square-${n}`);t&&(t.style.backgroundColor=e.getFrequencyColor(n))}}document.addEventListener("DOMContentLoaded",(()=>{!function(){const c=document.getElementById("start-button"),u=document.getElementById("info");c?.addEventListener("click",(async()=>{c.remove(),u?.remove(),l(!0),await async function(){n||(await e.initAudio(["stems/4-on-floor.wav","stems/bass.wav","stems/dnb-124.wav","stems/drums.wav","stems/hats.wav","stems/kick-hat.wav","stems/smooth-chords.wav","stems/toms.wav","stems/guitar.wav","stems/bass.wav","stems/dnb-124.wav","stems/drums.wav","stems/hats.wav","stems/kick-hat.wav","stems/smooth-chords.wav","stems/extacy.wav"]),n=!0)}(),l(!1),function(){const e=s("div","matrix","matrix",document.body);for(let n=0;n<t;n++)s("div","square",`square-${n}`,e);a=s("div","ballhome","ballhome",document.body);for(let e=0;e<4;e++){const t=s("div","ball",`ball-${e}`,a);t.draggable=!0,t.innerText="ðŸŒˆ"}}(),function(){const t=document.querySelectorAll(".ball"),n=document.querySelectorAll(".square");let s=null,l=null;const d=t=>{s&&(console.log("Dropped:",s.id,t.id),e.unMuteTrack(r(t.id)),t.appendChild(s),l=null,s.style.display="block",s=null)};if(t.forEach((t=>{t.addEventListener("dragstart",(n=>{s=t,l=t.parentElement,n.dataTransfer?.setData("text/plain",t.id),console.log("[Dragstart]: Lifted",t.id,"from",l.id),e.muteTrack(r(l.id))})),t.addEventListener("touchstart",(n=>{o=!0,s=t,l=t.parentElement,console.log("[Touchstart] Lifted",t.id,"from",l.id),e.muteTrack(r(l.id))})),t.addEventListener("touchmove",(e=>{if(console.log("[Touchmove] Dragging",t.id,e.touches.length),e.preventDefault(),o=!0,1===e.touches.length){const n=e.touches[0];t.style.left=n.clientX-25+"px",t.style.top=n.clientY-25+"px"}})),t.addEventListener("touchend",(e=>{if(console.log("[Touchend] Dropped",t.id),!s)return;i(!1);const n=e.changedTouches[0],o=document.elementFromPoint(n.clientX,n.clientY);i(!0),d(o)}))})),n.forEach((e=>{e.addEventListener("dragover",(e=>{e.preventDefault()})),e.addEventListener("drop",(t=>{t.preventDefault(),d(e)}))})),!a)throw new Error("Ball home not found");a.addEventListener("dragover",(e=>{e.preventDefault()})),a.addEventListener("drop",(e=>{if(e.preventDefault(),!a)throw new Error("Ball home not found");d(a)})),document.addEventListener("dragover",(e=>{o||e.preventDefault()})),document.addEventListener("drop",(e=>{if(!o){const e=document.getElementById("ballhome");d(e)}}))}(),d()}))}()}))})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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SSxLQUlyQnZDLEVBQUtlLGlCQUFpQixZQUFhYyxJQUVqQyxHQURBcEQsUUFBUUMsSUFBSSxxQkFBc0JzQixFQUFLVixLQUNsQ21DLEVBQVksT0FDakI1QixHQUFVLEdBQ1YsTUFBTXNDLEVBQVFOLEVBQUVXLGVBQWUsR0FDekJDLEVBQWdCaEQsU0FBU2lELGlCQUM3QlAsRUFBTUUsUUFDTkYsRUFBTUksU0FFUjFDLEdBQVUsR0FDVjhCLEVBQVNjLEVBQWMsR0FDdkIsSUFHSmpCLEVBQVE3RixTQUFTa0YsSUFDZkEsRUFBT0UsaUJBQWlCLFlBQWFjLElBQ25DQSxFQUFFSyxnQkFBZ0IsSUFHcEJyQixFQUFPRSxpQkFBaUIsUUFBU2MsSUFDL0JBLEVBQUVLLGlCQUNGUCxFQUFTZCxFQUFPLEdBQ2hCLEtBR0MzQixFQUNILE1BQU0sSUFBSTlELE1BQU0sdUJBRWxCOEQsRUFBUzZCLGlCQUFpQixZQUFhYyxJQUNyQ0EsRUFBRUssZ0JBQWdCLElBR3BCaEQsRUFBUzZCLGlCQUFpQixRQUFTYyxJQUVqQyxHQURBQSxFQUFFSyxrQkFDR2hELEVBQ0gsTUFBTSxJQUFJOUQsTUFBTSx1QkFFbEJ1RyxFQUFTekMsRUFBUyxJQUdwQk8sU0FBU3NCLGlCQUFpQixZQUFhYyxJQUNoQzVDLEdBQ0g0QyxFQUFFSyxnQixJQUdOekMsU0FBU3NCLGlCQUFpQixRQUFTYyxJQUNqQyxJQUFLNUMsRUFBYSxDQUNoQixNQUFNQyxFQUFXTyxTQUFTZ0IsZUFBZSxZQUN6Q2tCLEVBQVN6QyxFLElBR2YsQ0FzSUl5RCxHQUVBaEMsR0FBTSxHQUVWLENBR0VpQyxFQUFtQixHIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vc3F1YXJlcy8uL3NyYy9tYWluLnRzIiwid2VicGFjazovL3NxdWFyZXMvLi9zcmMvYXVkaW8udHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXVkaW9Db250cm9sbGVyIH0gZnJvbSBcIi4vYXVkaW9cIjtcblxuY29uc3QgYWMgPSBuZXcgQXVkaW9Db250cm9sbGVyKCk7XG5jb25zdCBuU3F1YXJlcyA9IDE2O1xuY29uc3QgbkJhbGxzID0gNDtcbnZhciBpc0luaXRpYXRlZCA9IGZhbHNlO1xudmFyIG1vYmlsZVVzYWdlID0gZmFsc2U7XG52YXIgYmFsbEhvbWU6IEhUTUxFbGVtZW50IHwgbnVsbCA9IG51bGw7XG52YXIgZnhFbmFibGUgPSBmYWxzZTtcblxuZnVuY3Rpb24gY3JlYXRlVUlFbGVtZW50cygpIHtcbiAgLy8gQ3JlYXRlIEZYIHVpXG4gIGlmIChmeEVuYWJsZSkge1xuICAgIGNvbnN0IGZ4ZGl2ID0gY3JlYXRlRWxlbWVudChcImRpdlwiLCBcImZ4XCIsIFwiZnhcIiwgZG9jdW1lbnQuYm9keSk7XG4gICAgZnhkaXYuc3R5bGUuZGlzcGxheSA9IGZ4RW5hYmxlID8gXCJibG9ja1wiIDogXCJub25lXCI7XG4gICAgY29uc3QgZngxID0gY3JlYXRlRWxlbWVudChcImRpdlwiLCBcImZ4MVwiLCBcImZ4MVwiLCBmeGRpdik7XG4gICAgZngxLmlubmVyVGV4dCA9IFwi8J+MilwiO1xuICAgIGNvbnN0IGZ4c3BhY2VyID0gY3JlYXRlRWxlbWVudChcImRpdlwiLCBcImZ4c3BhY2VyXCIsIFwiZnhzcGFjZXJcIiwgZnhkaXYpO1xuICAgIGNvbnN0IGZ4MiA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJmeDJcIiwgXCJmeDJcIiwgZnhkaXYpO1xuICAgIGZ4Mi5pbm5lclRleHQgPSBcIvCflaVcIjtcbiAgfVxuXG4gIGNvbnN0IG1hdHJpeCA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJtYXRyaXhcIiwgXCJtYXRyaXhcIiwgZG9jdW1lbnQuYm9keSk7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgblNxdWFyZXM7IGkrKykge1xuICAgIGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJzcXVhcmVcIiwgYHNxdWFyZS0ke2l9YCwgbWF0cml4KTtcbiAgfVxuICBiYWxsSG9tZSA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJiYWxsaG9tZVwiLCBcImJhbGxob21lXCIsIGRvY3VtZW50LmJvZHkpO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbkJhbGxzOyBpKyspIHtcbiAgICBjb25zdCBiYWxsID0gY3JlYXRlRWxlbWVudChcImRpdlwiLCBcImJhbGxcIiwgYGJhbGwtJHtpfWAsIGJhbGxIb21lKTtcbiAgICBiYWxsLmRyYWdnYWJsZSA9IHRydWU7XG4gICAgYmFsbC5pbm5lclRleHQgPSBg8J+MiGA7XG4gIH1cbn1cblxuZnVuY3Rpb24gaW5pdFVJTG9naWMoKSB7XG4gIGNvbnN0IGJhbGxzOiBOb2RlTGlzdE9mPEhUTUxFbGVtZW50PiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCIuYmFsbFwiKTtcbiAgY29uc3Qgc3F1YXJlczogTm9kZUxpc3RPZjxIVE1MRWxlbWVudD4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLnNxdWFyZVwiKTtcbiAgbGV0IGFjdGl2ZUJhbGw6IEhUTUxFbGVtZW50IHwgbnVsbCA9IG51bGw7XG4gIGxldCBvcmlnaW5TcXVhcmU6IEhUTUxFbGVtZW50IHwgbnVsbCA9IG51bGw7XG5cbiAgY29uc3QgZHJvcEJhbGwgPSAodGFyZ2V0OiBIVE1MRWxlbWVudCkgPT4ge1xuICAgIGlmIChhY3RpdmVCYWxsKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIkRyb3BwZWQ6XCIsIGFjdGl2ZUJhbGwuaWQsIHRhcmdldC5pZCk7XG4gICAgICBhYy51bk11dGVUcmFjayhnZXRTcXVhcmVJZCh0YXJnZXQuaWQpKTtcbiAgICAgIHRhcmdldC5hcHBlbmRDaGlsZChhY3RpdmVCYWxsKTtcbiAgICAgIG9yaWdpblNxdWFyZSA9IG51bGw7XG4gICAgICBhY3RpdmVCYWxsLnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCI7IC8vIE1ha2Ugc3VyZSB0byBkaXNwbGF5IHRoZSBiYWxsIGFnYWluXG4gICAgICBhY3RpdmVCYWxsID0gbnVsbDtcbiAgICB9XG4gIH07XG5cbiAgYmFsbHMuZm9yRWFjaCgoYmFsbCkgPT4ge1xuICAgIGJhbGwuYWRkRXZlbnRMaXN0ZW5lcihcImRyYWdzdGFydFwiLCAoZTogRHJhZ0V2ZW50KSA9PiB7XG4gICAgICBhY3RpdmVCYWxsID0gYmFsbDtcbiAgICAgIG9yaWdpblNxdWFyZSA9IGJhbGwucGFyZW50RWxlbWVudCBhcyBIVE1MRWxlbWVudDtcbiAgICAgIGUuZGF0YVRyYW5zZmVyPy5zZXREYXRhKFwidGV4dC9wbGFpblwiLCBiYWxsLmlkKTtcbiAgICAgIGNvbnNvbGUubG9nKFwiW0RyYWdzdGFydF06IExpZnRlZFwiLCBiYWxsLmlkLCBcImZyb21cIiwgb3JpZ2luU3F1YXJlLmlkKTtcbiAgICAgIGFjLm11dGVUcmFjayhnZXRTcXVhcmVJZChvcmlnaW5TcXVhcmUuaWQpKTtcbiAgICB9KTtcblxuICAgIGJhbGwuYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNoc3RhcnRcIiwgKGU6IFRvdWNoRXZlbnQpID0+IHtcbiAgICAgIG1vYmlsZVVzYWdlID0gdHJ1ZTtcbiAgICAgIGFjdGl2ZUJhbGwgPSBiYWxsO1xuICAgICAgb3JpZ2luU3F1YXJlID0gYmFsbC5wYXJlbnRFbGVtZW50IGFzIEhUTUxFbGVtZW50O1xuICAgICAgY29uc29sZS5sb2coXCJbVG91Y2hzdGFydF0gTGlmdGVkXCIsIGJhbGwuaWQsIFwiZnJvbVwiLCBvcmlnaW5TcXVhcmUuaWQpO1xuICAgICAgYWMubXV0ZVRyYWNrKGdldFNxdWFyZUlkKG9yaWdpblNxdWFyZS5pZCkpO1xuICAgIH0pO1xuXG4gICAgYmFsbC5hZGRFdmVudExpc3RlbmVyKFwidG91Y2htb3ZlXCIsIChlOiBUb3VjaEV2ZW50KSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhcIltUb3VjaG1vdmVdIERyYWdnaW5nXCIsIGJhbGwuaWQsIGUudG91Y2hlcy5sZW5ndGgpO1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgbW9iaWxlVXNhZ2UgPSB0cnVlO1xuICAgICAgaWYgKGUudG91Y2hlcy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgY29uc3QgdG91Y2ggPSBlLnRvdWNoZXNbMF07XG4gICAgICAgIGJhbGwuc3R5bGUubGVmdCA9IGAke3RvdWNoLmNsaWVudFggLSAyNX1weGA7IC8vIEFkanVzdCBmb3IgY2VudGVyIG9mIHRoZSBiYWxsXG4gICAgICAgIGJhbGwuc3R5bGUudG9wID0gYCR7dG91Y2guY2xpZW50WSAtIDI1fXB4YDtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGJhbGwuYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNoZW5kXCIsIChlOiBUb3VjaEV2ZW50KSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhcIltUb3VjaGVuZF0gRHJvcHBlZFwiLCBiYWxsLmlkKTtcbiAgICAgIGlmICghYWN0aXZlQmFsbCkgcmV0dXJuO1xuICAgICAgc2hvd0JhbGxzKGZhbHNlKTtcbiAgICAgIGNvbnN0IHRvdWNoID0gZS5jaGFuZ2VkVG91Y2hlc1swXTtcbiAgICAgIGNvbnN0IHRhcmdldEVsZW1lbnQgPSBkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50KFxuICAgICAgICB0b3VjaC5jbGllbnRYLFxuICAgICAgICB0b3VjaC5jbGllbnRZXG4gICAgICApIGFzIEhUTUxFbGVtZW50O1xuICAgICAgc2hvd0JhbGxzKHRydWUpO1xuICAgICAgZHJvcEJhbGwodGFyZ2V0RWxlbWVudCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIHNxdWFyZXMuZm9yRWFjaCgoc3F1YXJlKSA9PiB7XG4gICAgc3F1YXJlLmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnb3ZlclwiLCAoZTogRHJhZ0V2ZW50KSA9PiB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgfSk7XG5cbiAgICBzcXVhcmUuYWRkRXZlbnRMaXN0ZW5lcihcImRyb3BcIiwgKGU6IERyYWdFdmVudCkgPT4ge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgZHJvcEJhbGwoc3F1YXJlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgaWYgKCFiYWxsSG9tZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkJhbGwgaG9tZSBub3QgZm91bmRcIik7XG4gIH1cbiAgYmFsbEhvbWUuYWRkRXZlbnRMaXN0ZW5lcihcImRyYWdvdmVyXCIsIChlOiBEcmFnRXZlbnQpID0+IHtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gIH0pO1xuXG4gIGJhbGxIb21lLmFkZEV2ZW50TGlzdGVuZXIoXCJkcm9wXCIsIChlOiBEcmFnRXZlbnQpID0+IHtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgaWYgKCFiYWxsSG9tZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQmFsbCBob21lIG5vdCBmb3VuZFwiKTtcbiAgICB9XG4gICAgZHJvcEJhbGwoYmFsbEhvbWUpO1xuICB9KTtcblxuICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwiZHJhZ292ZXJcIiwgKGUpID0+IHtcbiAgICBpZiAoIW1vYmlsZVVzYWdlKSB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7IC8vIFRoaXMgYWxsb3dzIHRoZSBkcm9wIHRvIGJlIGFjY2VwdGVkLlxuICAgIH1cbiAgfSk7XG4gIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJkcm9wXCIsIChlKSA9PiB7XG4gICAgaWYgKCFtb2JpbGVVc2FnZSkge1xuICAgICAgY29uc3QgYmFsbEhvbWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImJhbGxob21lXCIpIGFzIEhUTUxFbGVtZW50O1xuICAgICAgZHJvcEJhbGwoYmFsbEhvbWUpO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGluaXRGWFVJKCkge1xuICBpZiAoIWZ4RW5hYmxlKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IGZ4MSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZngxXCIpO1xuICBpZiAoIWZ4MSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcImZ4MSBub3QgZm91bmRcIik7XG4gIH1cbiAgZngxLmRyYWdnYWJsZSA9IHRydWU7XG4gIGNvbnN0IGZ4MiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZngyXCIpO1xuICBmeDE/LmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnc3RhcnRcIiwgKGU6IERyYWdFdmVudCkgPT4ge1xuICAgIGNvbnN0IHsgeCwgeSB9ID0gbm9ybWFsaXplZFhZKGUueCwgZS55KTtcbiAgICBhYy5meDEoeCwgeSk7XG4gICAgY29uc29sZS5sb2coXCJkcmFnc3RhcnRcIik7XG4gIH0pO1xuICBmeDE/LmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnXCIsIChlOiBEcmFnRXZlbnQpID0+IHtcbiAgICBjb25zdCB7IHgsIHkgfSA9IG5vcm1hbGl6ZWRYWShlLngsIGUueSk7XG4gICAgYWMuZngxKHgsIHkpO1xuICAgIGNvbnNvbGUubG9nKFwiZHJhZ21vdmVcIik7XG4gIH0pO1xuICBmeDE/LmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnZW5kXCIsIChlOiBEcmFnRXZlbnQpID0+IHtcbiAgICBhYy5meDEoMCwgMCk7XG4gICAgY29uc29sZS5sb2coXCJkcmFnZW5kXCIpO1xuICB9KTtcbiAgZngxPy5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hzdGFydFwiLCAoZTogVG91Y2hFdmVudCkgPT4ge1xuICAgIGlmIChlLnRvdWNoZXMubGVuZ3RoICE9IDEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgdG91Y2ggPSBlLnRvdWNoZXNbMF07XG4gICAgY29uc3QgeyB4LCB5IH0gPSBub3JtYWxpemVkWFkodG91Y2guY2xpZW50WCwgdG91Y2guY2xpZW50WSk7XG4gICAgYWMuZngxKHgsIHkpO1xuICAgIGNvbnNvbGUubG9nKFwidG91Y2hzdGFydFwiKTtcbiAgfSk7XG4gIGZ4MT8uYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNobW92ZVwiLCAoZTogVG91Y2hFdmVudCkgPT4ge1xuICAgIGlmIChlLnRvdWNoZXMubGVuZ3RoICE9IDEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgdG91Y2ggPSBlLnRvdWNoZXNbMF07XG4gICAgY29uc3QgeyB4LCB5IH0gPSBub3JtYWxpemVkWFkodG91Y2guY2xpZW50WCwgdG91Y2guY2xpZW50WSk7XG4gICAgYWMuZngxKHgsIHkpO1xuICAgIGNvbnNvbGUubG9nKFwidG91Y2htb3ZlXCIpO1xuICB9KTtcbiAgZngxPy5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hlbmRcIiwgKGU6IFRvdWNoRXZlbnQpID0+IHtcbiAgICBpZiAoZS50b3VjaGVzLmxlbmd0aCAhPSAxKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGFjLmZ4MSgwLCAwKTtcbiAgICBjb25zb2xlLmxvZyhcInRvdWNoZW5kXCIpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlRWxlbWVudChcbiAgdGFnOiBzdHJpbmcsXG4gIGNsczogc3RyaW5nLFxuICBpZDogc3RyaW5nLFxuICBwYXJlbnQ6IEhUTUxFbGVtZW50XG4pIHtcbiAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnKTtcbiAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKGNscyk7XG4gIGVsZW1lbnQuaWQgPSBpZDtcbiAgcGFyZW50LmFwcGVuZENoaWxkKGVsZW1lbnQpO1xuICByZXR1cm4gZWxlbWVudDtcbn1cblxuZnVuY3Rpb24gc2hvd0JhbGxzKHNob3c6IGJvb2xlYW4pIHtcbiAgY29uc3QgYmFsbHM6IE5vZGVMaXN0T2Y8SFRNTEVsZW1lbnQ+ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5iYWxsXCIpO1xuICBiYWxscy5mb3JFYWNoKChiYWxsKSA9PiB7XG4gICAgYmFsbC5zdHlsZS5kaXNwbGF5ID0gc2hvdyA/IFwiYmxvY2tcIiA6IFwibm9uZVwiO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0U3F1YXJlSWQoaWQ6IHN0cmluZyB8IG51bGwpOiBudW1iZXIge1xuICBpZiAoIWlkKSB7XG4gICAgcmV0dXJuIC0xO1xuICB9XG4gIGNvbnN0IHBhcnRzID0gaWQuc3BsaXQoXCJzcXVhcmUtXCIpO1xuICBpZiAocGFydHMubGVuZ3RoIDwgMikge1xuICAgIHJldHVybiAtMTtcbiAgfVxuICByZXR1cm4gcGFyc2VJbnQocGFydHNbMV0pO1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVkWFkoeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcbiAgY29uc3Qgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xuICByZXR1cm4geyB4OiB4IC8gd2lkdGgsIHk6IHkgLyBoZWlnaHQgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5pdEF1ZGlvKCkge1xuICBpZiAoaXNJbml0aWF0ZWQpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgYXdhaXQgYWMuaW5pdEF1ZGlvKFtcbiAgICBcInN0ZW1zLzQtb24tZmxvb3Iud2F2XCIsXG4gICAgXCJzdGVtcy9iYXNzLndhdlwiLFxuICAgIFwic3RlbXMvZG5iLTEyNC53YXZcIixcbiAgICBcInN0ZW1zL2RydW1zLndhdlwiLFxuICAgIFwic3RlbXMvaGF0cy53YXZcIixcbiAgICBcInN0ZW1zL2tpY2staGF0LndhdlwiLFxuICAgIFwic3RlbXMvc21vb3RoLWNob3Jkcy53YXZcIixcbiAgICBcInN0ZW1zL3RvbXMud2F2XCIsXG4gICAgXCJzdGVtcy9ndWl0YXIud2F2XCIsXG4gICAgXCJzdGVtcy9iYXNzLndhdlwiLFxuICAgIFwic3RlbXMvZG5iLTEyNC53YXZcIixcbiAgICBcInN0ZW1zL2RydW1zLndhdlwiLFxuICAgIFwic3RlbXMvaGF0cy53YXZcIixcbiAgICBcInN0ZW1zL2tpY2staGF0LndhdlwiLFxuICAgIFwic3RlbXMvc21vb3RoLWNob3Jkcy53YXZcIixcbiAgICBcInN0ZW1zL2V4dGFjeS53YXZcIixcbiAgXSk7XG4gIGlzSW5pdGlhdGVkID0gdHJ1ZTtcbn1cblxuZnVuY3Rpb24gc3Bpbm5lcihzaG93OiBib29sZWFuKSB7XG4gIGlmIChzaG93KSB7XG4gICAgY3JlYXRlRWxlbWVudChcImRpdlwiLCBcInNwaW5uZXJcIiwgXCJzcGlubmVyXCIsIGRvY3VtZW50LmJvZHkpO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHNwaW5uZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInNwaW5uZXJcIik7XG4gICAgc3Bpbm5lcj8ucmVtb3ZlKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gY3JlYXRlU3RhcnRCdXR0b24oKSB7XG4gIGNvbnN0IHN0YXJ0QnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJzdGFydC1idXR0b25cIik7XG4gIGNvbnN0IGluZm8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImluZm9cIik7XG4gIHN0YXJ0QnV0dG9uPy5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgYXN5bmMgKCkgPT4ge1xuICAgIHN0YXJ0QnV0dG9uLnJlbW92ZSgpO1xuICAgIGluZm8/LnJlbW92ZSgpO1xuICAgIHNwaW5uZXIodHJ1ZSk7XG4gICAgYXdhaXQgaW5pdEF1ZGlvKCk7XG4gICAgc3Bpbm5lcihmYWxzZSk7XG4gICAgY3JlYXRlVUlFbGVtZW50cygpO1xuICAgIGluaXRVSUxvZ2ljKCk7XG4gICAgaW5pdEZYVUkoKTtcbiAgICBkcmF3KCk7XG4gIH0pO1xufVxuXG5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwiRE9NQ29udGVudExvYWRlZFwiLCAoKSA9PiB7XG4gIGNyZWF0ZVN0YXJ0QnV0dG9uKCk7XG59KTtcblxuZnVuY3Rpb24gZHJhdygpIHtcbiAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGRyYXcpO1xuICBpZiAoIWlzSW5pdGlhdGVkKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgblNxdWFyZXM7IGkrKykge1xuICAgIGNvbnN0IHNxdWFyZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBzcXVhcmUtJHtpfWApIGFzIEhUTUxFbGVtZW50O1xuICAgIGlmIChzcXVhcmUpIHtcbiAgICAgIHNxdWFyZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBhYy5nZXRGcmVxdWVuY3lDb2xvcihpKTtcbiAgICB9XG4gIH1cbn1cbiIsImV4cG9ydCBjbGFzcyBBdWRpb0NvbnRyb2xsZXIge1xuICBwcml2YXRlIGF1ZGlvQ29udGV4dDogQXVkaW9Db250ZXh0O1xuICBwcml2YXRlIHRyYWNrczoge1xuICAgIHNvdXJjZU5vZGU6IEF1ZGlvQnVmZmVyU291cmNlTm9kZTtcbiAgICBnYWluTm9kZTogR2Fpbk5vZGU7XG4gICAgYW5hbHlzZXJOb2RlOiBBbmFseXNlck5vZGU7XG4gIH1bXSA9IFtdO1xuICBwcml2YXRlIHNsb3dBdmVyYWdlOiBudW1iZXIgPSAzOTsgLy8gb3JhbmdlXG4gIHByaXZhdGUgZngxYTogQmlxdWFkRmlsdGVyTm9kZSB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGZ4MWI6IERlbGF5Tm9kZSB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuYXVkaW9Db250ZXh0ID0gbmV3IEF1ZGlvQ29udGV4dCgpO1xuICB9XG5cbiAgYXN5bmMgaW5pdEF1ZGlvKGZpbGVOYW1lczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoZmlsZU5hbWVzLmxlbmd0aCAhPT0gMTYpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkV4cGVjdGVkIDE2IGF1ZGlvIGZpbGVzLlwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBmaWxlUHJvbWlzZXMgPSBmaWxlTmFtZXMubWFwKChmaWxlTmFtZSkgPT5cbiAgICAgIHRoaXMubG9hZEF1ZGlvRmlsZShmaWxlTmFtZSlcbiAgICApO1xuXG4gICAgY29uc3QgYXVkaW9CdWZmZXJzID0gYXdhaXQgUHJvbWlzZS5hbGwoZmlsZVByb21pc2VzKTtcblxuICAgIGF1ZGlvQnVmZmVycy5mb3JFYWNoKChidWZmZXIpID0+IHtcbiAgICAgIGNvbnN0IHNvdXJjZU5vZGUgPSB0aGlzLmF1ZGlvQ29udGV4dC5jcmVhdGVCdWZmZXJTb3VyY2UoKTtcbiAgICAgIGNvbnN0IGdhaW5Ob2RlID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlR2FpbigpO1xuXG4gICAgICBzb3VyY2VOb2RlLmJ1ZmZlciA9IGJ1ZmZlcjtcbiAgICAgIGdhaW5Ob2RlLmdhaW4udmFsdWUgPSAwOyAvLyBTdGFydCBtdXRlZFxuICAgICAgc291cmNlTm9kZS5jb25uZWN0KGdhaW5Ob2RlKTtcblxuICAgICAgLy8gc2V0IHVwIGFuIGFuYWx5c2VyIHNvIHdlIGNhbiBkbyBjb29sIHZpc3VhbHNcbiAgICAgIGNvbnN0IGFuYWx5c2VyTm9kZSA9IHRoaXMuYXVkaW9Db250ZXh0LmNyZWF0ZUFuYWx5c2VyKCk7XG4gICAgICBhbmFseXNlck5vZGUuZmZ0U2l6ZSA9IDIwNDg7XG4gICAgICBnYWluTm9kZS5jb25uZWN0KGFuYWx5c2VyTm9kZSk7XG5cbiAgICAgIC8vIHNldCB1cCBmeCBub2Rlc1xuICAgICAgdGhpcy5meDFhID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlQmlxdWFkRmlsdGVyKCk7XG4gICAgICB0aGlzLmZ4MWEudHlwZSA9IFwiaGlnaHBhc3NcIjtcbiAgICAgIHRoaXMuZngxYS5mcmVxdWVuY3kudmFsdWUgPSAxMDAwO1xuICAgICAgdGhpcy5meDFhLmdhaW4udmFsdWUgPSAwO1xuICAgICAgZ2Fpbk5vZGUuY29ubmVjdCh0aGlzLmZ4MWEpO1xuXG4gICAgICB0aGlzLmZ4MWIgPSB0aGlzLmF1ZGlvQ29udGV4dC5jcmVhdGVEZWxheSgpO1xuICAgICAgdGhpcy5meDFiLmRlbGF5VGltZS52YWx1ZSA9IDA7IC8vIHBhc3MgdGhyb3VnaFxuICAgICAgdGhpcy5meDFhLmNvbm5lY3QodGhpcy5meDFiKTtcblxuICAgICAgLy8gZm9yIG5vdyBqdXN0IGJ5cGFzcyB0aGUgRlggbm9kZXMgLSBub3QgaW1wbGVtZW50ZWQgcHJvcGVybHkgeWV0XG4gICAgICAvLyAgIHRoaXMuZngxYi5jb25uZWN0KHRoaXMuYXVkaW9Db250ZXh0LmRlc3RpbmF0aW9uKTtcbiAgICAgIGdhaW5Ob2RlLmNvbm5lY3QodGhpcy5hdWRpb0NvbnRleHQuZGVzdGluYXRpb24pO1xuXG4gICAgICB0aGlzLnRyYWNrcy5wdXNoKHsgc291cmNlTm9kZSwgZ2Fpbk5vZGUsIGFuYWx5c2VyTm9kZSB9KTtcblxuICAgICAgc291cmNlTm9kZS5sb29wID0gdHJ1ZTtcbiAgICAgIHNvdXJjZU5vZGUuc3RhcnQoMCk7IC8vIFBsYXkgaW1tZWRpYXRlbHkgaW4gc3luY1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkQXVkaW9GaWxlKHVybDogc3RyaW5nKTogUHJvbWlzZTxBdWRpb0J1ZmZlcj4ge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsKTtcbiAgICBjb25zdCBhcnJheUJ1ZmZlciA9IGF3YWl0IHJlc3BvbnNlLmFycmF5QnVmZmVyKCk7XG4gICAgcmV0dXJuIHRoaXMuYXVkaW9Db250ZXh0LmRlY29kZUF1ZGlvRGF0YShhcnJheUJ1ZmZlcik7XG4gIH1cblxuICBnZXRGcmVxdWVuY3lDb2xvcih0cmFjazogbnVtYmVyKTogc3RyaW5nIHtcbiAgICBjb25zdCBnYWluTm9kZSA9IHRoaXMudHJhY2tzW3RyYWNrXS5nYWluTm9kZTtcbiAgICBpZiAoZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9PT0gMCkge1xuICAgICAgcmV0dXJuIGBoc2woJHt0aGlzLnNsb3dBdmVyYWdlICsgdHJhY2t9LCAxMDAlLCA1MCUpYDtcbiAgICB9XG4gICAgY29uc3QgYW5hbHlzZXJOb2RlID0gdGhpcy50cmFja3NbdHJhY2tdLmFuYWx5c2VyTm9kZTtcbiAgICBjb25zdCBkYXRhQXJyYXkgPSBuZXcgVWludDhBcnJheShhbmFseXNlck5vZGUuZnJlcXVlbmN5QmluQ291bnQpO1xuICAgIGFuYWx5c2VyTm9kZS5nZXRCeXRlRnJlcXVlbmN5RGF0YShkYXRhQXJyYXkpO1xuXG4gICAgLy8gZ2V0IHRoZSBoaWdoZXN0IGZyZXF1ZW5jeVxuICAgIGNvbnN0IG1heCA9IE1hdGgubWF4KC4uLmRhdGFBcnJheSk7XG4gICAgY29uc3QgbWF4SW5kZXggPSBkYXRhQXJyYXkuaW5kZXhPZihtYXgpO1xuICAgIHRoaXMudXBkYXRlU2xvd0F2ZXJhZ2UobWF4SW5kZXgpO1xuXG4gICAgY29uc3QgaHVlID0gdGhpcy5zbG93QXZlcmFnZSArIHRyYWNrICsgKChtYXhJbmRleCAqIDEwKSAlIDI0MCk7XG4gICAgcmV0dXJuIGBoc2woJHtodWV9LCAxMDAlLCA1MCUpYDtcbiAgfVxuXG4gIHVwZGF0ZVNsb3dBdmVyYWdlKHZhbHVlOiBudW1iZXIpIHtcbiAgICB0aGlzLnNsb3dBdmVyYWdlID0gdGhpcy5zbG93QXZlcmFnZSArICgodmFsdWUgKiAwLjAwMSkgJSAyNDApO1xuICB9XG5cbiAgdW5NdXRlVHJhY2sodHJhY2tOdW1iZXI6IG51bWJlcik6IHZvaWQge1xuICAgIGlmICh0cmFja051bWJlciA9PSAtMSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy50cmFja3NbdHJhY2tOdW1iZXJdKSB7XG4gICAgICB0aGlzLnRyYWNrc1t0cmFja051bWJlcl0uZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9IDAuNTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcmFjayAke3RyYWNrTnVtYmVyfSBkb2VzIG5vdCBleGlzdC5gKTtcbiAgICB9XG4gIH1cblxuICBtdXRlVHJhY2sodHJhY2tOdW1iZXI6IG51bWJlcik6IHZvaWQge1xuICAgIGlmICh0cmFja051bWJlciA9PSAtMSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy50cmFja3NbdHJhY2tOdW1iZXJdKSB7XG4gICAgICB0aGlzLnRyYWNrc1t0cmFja051bWJlcl0uZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9IDA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHJhY2sgJHt0cmFja051bWJlcn0gZG9lcyBub3QgZXhpc3QuYCk7XG4gICAgfVxuICB9XG5cbiAgbXV0ZUFsbCgpOiB2b2lkIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudHJhY2tzLmxlbmd0aDsgaSsrKSB7XG4gICAgICB0aGlzLm11dGVUcmFjayhpKTtcbiAgICB9XG4gIH1cblxuICBmeDEoeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcbiAgICBpZiAoeCAhPSAwICYmIHkgIT0gMCkge1xuICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiAwLjEpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoIXRoaXMuZngxYSB8fCAhdGhpcy5meDFiKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnNvbGUubG9nKFwiZngxIGNhbGxlZCB3aXRoIHg6XCIsIHgsIFwieTpcIiwgeSk7XG4gICAgY29uc29sZS5sb2coXCJBdWRpb0NvbnRleHQgc3RhdGU6XCIsIHRoaXMuYXVkaW9Db250ZXh0LnN0YXRlKTtcbiAgICBjb25zb2xlLmxvZyhcIkN1cnJlbnQgdGltZTpcIiwgdGhpcy5hdWRpb0NvbnRleHQuY3VycmVudFRpbWUpO1xuXG4gICAgY29uc29sZS5sb2coXCJBcHBseWluZyBnYWluOlwiLCB4ICogMjUsIFwidG8gZngxYVwiKTtcbiAgICBjb25zdCBnYWluID0gTWF0aC5mbG9vcih4ICogMTApO1xuICAgIHRoaXMuZngxYS5nYWluLnNldFZhbHVlQXRUaW1lKGdhaW4sIHRoaXMuYXVkaW9Db250ZXh0LmN1cnJlbnRUaW1lKTtcbiAgICB0aGlzLmZ4MWIuZGVsYXlUaW1lLnNldFZhbHVlQXRUaW1lKHksIHRoaXMuYXVkaW9Db250ZXh0LmN1cnJlbnRUaW1lKTtcblxuICAgIGNvbnNvbGUubG9nKHRoaXMuZngxYSwgdGhpcy5meDFiKTtcbiAgfVxufVxuIl0sIm5hbWVzIjpbImFjIiwiYXVkaW9Db250ZXh0IiwidHJhY2tzIiwic2xvd0F2ZXJhZ2UiLCJmeDFhIiwiZngxYiIsImNvbnN0cnVjdG9yIiwidGhpcyIsIkF1ZGlvQ29udGV4dCIsImluaXRBdWRpbyIsImZpbGVOYW1lcyIsImxlbmd0aCIsIkVycm9yIiwiZmlsZVByb21pc2VzIiwibWFwIiwiZmlsZU5hbWUiLCJsb2FkQXVkaW9GaWxlIiwiUHJvbWlzZSIsImFsbCIsImZvckVhY2giLCJidWZmZXIiLCJzb3VyY2VOb2RlIiwiY3JlYXRlQnVmZmVyU291cmNlIiwiZ2Fpbk5vZGUiLCJjcmVhdGVHYWluIiwiZ2FpbiIsInZhbHVlIiwiY29ubmVjdCIsImFuYWx5c2VyTm9kZSIsImNyZWF0ZUFuYWx5c2VyIiwiZmZ0U2l6ZSIsImNyZWF0ZUJpcXVhZEZpbHRlciIsInR5cGUiLCJmcmVxdWVuY3kiLCJjcmVhdGVEZWxheSIsImRlbGF5VGltZSIsImRlc3RpbmF0aW9uIiwicHVzaCIsImxvb3AiLCJzdGFydCIsInVybCIsInJlc3BvbnNlIiwiZmV0Y2giLCJhcnJheUJ1ZmZlciIsImRlY29kZUF1ZGlvRGF0YSIsImdldEZyZXF1ZW5jeUNvbG9yIiwidHJhY2siLCJkYXRhQXJyYXkiLCJVaW50OEFycmF5IiwiZnJlcXVlbmN5QmluQ291bnQiLCJnZXRCeXRlRnJlcXVlbmN5RGF0YSIsIm1heCIsIk1hdGgiLCJtYXhJbmRleCIsImluZGV4T2YiLCJ1cGRhdGVTbG93QXZlcmFnZSIsInVuTXV0ZVRyYWNrIiwidHJhY2tOdW1iZXIiLCJtdXRlVHJhY2siLCJtdXRlQWxsIiwiaSIsImZ4MSIsIngiLCJ5IiwicmFuZG9tIiwiY29uc29sZSIsImxvZyIsInN0YXRlIiwiY3VycmVudFRpbWUiLCJmbG9vciIsInNldFZhbHVlQXRUaW1lIiwiblNxdWFyZXMiLCJpc0luaXRpYXRlZCIsIm1vYmlsZVVzYWdlIiwiYmFsbEhvbWUiLCJjcmVhdGVFbGVtZW50IiwidGFnIiwiY2xzIiwiaWQiLCJwYXJlbnQiLCJlbGVtZW50IiwiZG9jdW1lbnQiLCJjbGFzc0xpc3QiLCJhZGQiLCJhcHBlbmRDaGlsZCIsInNob3dCYWxscyIsInNob3ciLCJxdWVyeVNlbGVjdG9yQWxsIiwiYmFsbCIsInN0eWxlIiwiZGlzcGxheSIsImdldFNxdWFyZUlkIiwicGFydHMiLCJzcGxpdCIsInBhcnNlSW50Iiwic3Bpbm5lciIsImJvZHkiLCJnZXRFbGVtZW50QnlJZCIsInJlbW92ZSIsImRyYXciLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJzcXVhcmUiLCJiYWNrZ3JvdW5kQ29sb3IiLCJhZGRFdmVudExpc3RlbmVyIiwic3RhcnRCdXR0b24iLCJpbmZvIiwiYXN5bmMiLCJtYXRyaXgiLCJkcmFnZ2FibGUiLCJpbm5lclRleHQiLCJjcmVhdGVVSUVsZW1lbnRzIiwiYmFsbHMiLCJzcXVhcmVzIiwiYWN0aXZlQmFsbCIsIm9yaWdpblNxdWFyZSIsImRyb3BCYWxsIiwidGFyZ2V0IiwiZSIsInBhcmVudEVsZW1lbnQiLCJkYXRhVHJhbnNmZXIiLCJzZXREYXRhIiwidG91Y2hlcyIsInByZXZlbnREZWZhdWx0IiwidG91Y2giLCJsZWZ0IiwiY2xpZW50WCIsInRvcCIsImNsaWVudFkiLCJjaGFuZ2VkVG91Y2hlcyIsInRhcmdldEVsZW1lbnQiLCJlbGVtZW50RnJvbVBvaW50IiwiaW5pdFVJTG9naWMiLCJjcmVhdGVTdGFydEJ1dHRvbiJdLCJzb3VyY2VSb290IjoiIn0=