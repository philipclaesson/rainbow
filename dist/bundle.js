(()=>{"use strict";const e=new class{audioContext;tracks=[];slowAverage=39;fx1a=null;fx1b=null;constructor(){this.audioContext=new AudioContext}async initAudio(e){if(16!==e.length)throw new Error("Expected 16 audio files.");const t=e.map((e=>this.loadAudioFile(e)));(await Promise.all(t)).forEach((e=>{const t=this.audioContext.createBufferSource(),o=this.audioContext.createGain();t.buffer=e,o.gain.value=0,t.connect(o);const n=this.audioContext.createAnalyser();n.fftSize=2048,o.connect(n),this.fx1a=this.audioContext.createBiquadFilter(),this.fx1a.type="highpass",this.fx1a.frequency.value=1e3,this.fx1a.gain.value=0,o.connect(this.fx1a),this.fx1b=this.audioContext.createDelay(),this.fx1b.delayTime.value=0,this.fx1a.connect(this.fx1b),o.connect(this.audioContext.destination),this.tracks.push({sourceNode:t,gainNode:o,analyserNode:n}),t.loop=!0,t.start(0)}))}async loadAudioFile(e){const t=await fetch(e),o=await t.arrayBuffer();return this.audioContext.decodeAudioData(o)}getFrequencyColor(e){if(0===this.tracks[e].gainNode.gain.value)return`hsl(${this.slowAverage+e}, 100%, 50%)`;const t=this.tracks[e].analyserNode,o=new Uint8Array(t.frequencyBinCount);t.getByteFrequencyData(o);const n=Math.max(...o),s=o.indexOf(n);return this.updateSlowAverage(s),`hsl(${this.slowAverage+e+10*s%240}, 100%, 50%)`}updateSlowAverage(e){this.slowAverage=this.slowAverage+.001*e%240}enableTrack(e,t){if(-1!=e){if(e>=this.tracks.length)throw new Error(`Track ${e} does not exist.`);console.log("Enabling track",e,t),this.tracks[e].gainNode.gain.value=t?.5:0}}muteAll(){for(let e=0;e<this.tracks.length;e++)this.enableTrack(e,!1)}fx1(e,t){if(0!=e&&0!=t&&Math.random()>.1)return;if(!this.fx1a||!this.fx1b)return;console.log("fx1 called with x:",e,"y:",t),console.log("AudioContext state:",this.audioContext.state),console.log("Current time:",this.audioContext.currentTime),console.log("Applying gain:",25*e,"to fx1a");const o=Math.floor(10*e);this.fx1a.gain.setValueAtTime(o,this.audioContext.currentTime),this.fx1b.delayTime.setValueAtTime(t,this.audioContext.currentTime),console.log(this.fx1a,this.fx1b)}},t=16;var o=!1;function n(e,t,o,n){const s=document.createElement(e);return s.classList.add(t),s.id=o,n.appendChild(s),s}function s(e){document.querySelectorAll(".ball").forEach((t=>{t.style.display=e?"block":"none"}))}function i(e){if(!e)return-1;const t=e.split("square-");return t.length<2?-1:parseInt(t[1])}function a(e){if(e)n("div","spinner","spinner",document.body);else{const e=document.getElementById("spinner");e?.remove()}}function r(){if(requestAnimationFrame(r),o)for(let o=0;o<t;o++){const t=document.getElementById(`square-${o}`);t&&(t.style.backgroundColor=e.getFrequencyColor(o))}}document.addEventListener("DOMContentLoaded",(()=>{!function(){const c=document.getElementById("start-button"),l=document.getElementById("info");c?.addEventListener("click",(async()=>{c.remove(),l?.remove(),a(!0),await async function(){o||(await e.initAudio(["stems/4-on-floor.wav","stems/bass.wav","stems/dnb-124.wav","stems/drums.wav","stems/hats.wav","stems/kick-hat.wav","stems/smooth-chords.wav","stems/toms.wav","stems/guitar.wav","stems/bass.wav","stems/dnb-124.wav","stems/drums.wav","stems/hats.wav","stems/kick-hat.wav","stems/smooth-chords.wav","stems/extacy.wav"]),o=!0)}(),a(!1),function(){const e=n("div","matrix","matrix",document.body);for(let o=0;o<t;o++)n("div","square",`square-${o}`,e);const o=n("div","ballhome","ballhome",document.body);for(let e=0;e<4;e++){const t=n("div","ball",`ball-${e}`,o);t.draggable=!0,t.innerText="ðŸŒˆ"}}(),function(){const t=document.querySelectorAll(".ball"),o=(t,o)=>{console.log("Dropped:",t.id,o.id),e.enableTrack(i(o.id),!0),o.appendChild(t)};t.forEach((t=>{t.addEventListener("mousedown",(e=>{const o=t.parentElement;t.setAttribute("origin-square",o.id),t.setAttribute("clicked","true"),console.log("[Mousedown] Picked up",t.id,"from",o.id),e.preventDefault()})),t.addEventListener("mousemove",(e=>{"true"===t.getAttribute("clicked")&&(console.log("[Mousemove] Moving",t.id),e.preventDefault(),t.style.left=e.clientX-25+"px",t.style.top=e.clientY-25+"px")})),t.addEventListener("mouseup",(n=>{if("true"!==t.getAttribute("clicked"))return;const a=t.getAttribute("origin-square");e.enableTrack(i(a),!1),t.setAttribute("clicked","false"),s(!1);const r=document.elementFromPoint(n.clientX,n.clientY);s(!0),o(t,r),console.log("[Mouseup] Dropped",t.id,"from",a)})),t.addEventListener("touchstart",(e=>{const o=t.parentElement;t.setAttribute("origin-square",o.id),console.log("[Touchstart] Lifted",t.id,"from",o.id)})),t.addEventListener("touchmove",(e=>{if(console.log("[Touchmove] Dragging",t.id,e.touches.length),e.preventDefault(),1===e.touches.length){const o=e.touches[0];t.style.left=o.clientX-25+"px",t.style.top=o.clientY-25+"px"}})),t.addEventListener("touchend",(n=>{const a=t.getAttribute("origin-square");e.enableTrack(i(a),!1),s(!1);const r=n.changedTouches[0],c=document.elementFromPoint(r.clientX,r.clientY);s(!0),o(t,c),console.log("[Touchend] Dropped",t.id)}))}))}(),r()}))}()}))})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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RyxJQUd0RVUsRUFBS2UsaUJBQWlCLGFBQWNZLElBSWxDLEdBSEF0RCxRQUFRQyxJQUFJLHVCQUF3QjBCLEVBQUtWLEdBQUlxQyxFQUFFYSxRQUFRbkgsUUFDdkRzRyxFQUFFSSxpQkFFdUIsSUFBckJKLEVBQUVhLFFBQVFuSCxPQUFjLENBQzFCLE1BQU1vSCxFQUFRZCxFQUFFYSxRQUFRLEdBQ3hCeEMsRUFBS0MsTUFBTWdDLEtBQVVRLEVBQU1QLFFBQVUsR0FBbkIsS0FDbEJsQyxFQUFLQyxNQUFNa0MsSUFBU00sRUFBTUwsUUFBVSxHQUFuQixJLEtBSXJCcEMsRUFBS2UsaUJBQWlCLFlBQWFZLElBRWpDLE1BQU1VLEVBQWlCckMsRUFBS2dDLGFBQWEsaUJBQ3pDdEgsRUFBR3dELFlBQVlpQyxFQUFZa0MsSUFBaUIsR0FHNUN4QyxHQUFVLEdBQ1YsTUFBTTRDLEVBQVFkLEVBQUVlLGVBQWUsR0FDekJKLEVBQWdCN0MsU0FBUzhDLGlCQUM3QkUsRUFBTVAsUUFDTk8sRUFBTUwsU0FFUnZDLEdBQVUsR0FFVjRCLEVBQVN6QixFQUFNc0MsR0FDZmpFLFFBQVFDLElBQUkscUJBQXNCMEIsRUFBS1YsR0FBRyxHQUMxQyxHQUVOLENBc0lJcUQsR0FFQWhDLEdBQU0sR0FFVixDQUdFaUMsRUFBbUIsRyIsInNvdXJjZXMiOlsid2VicGFjazovL3NxdWFyZXMvLi9zcmMvbWFpbi50cyIsIndlYnBhY2s6Ly9zcXVhcmVzLy4vc3JjL2F1ZGlvLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEF1ZGlvQ29udHJvbGxlciB9IGZyb20gXCIuL2F1ZGlvXCI7XG5cbmNvbnN0IGFjID0gbmV3IEF1ZGlvQ29udHJvbGxlcigpO1xuY29uc3QgblNxdWFyZXMgPSAxNjtcbmNvbnN0IG5CYWxscyA9IDQ7XG52YXIgaXNJbml0aWF0ZWQgPSBmYWxzZTtcbnZhciBtb2JpbGVVc2FnZSA9IGZhbHNlO1xudmFyIGZ4RW5hYmxlID0gZmFsc2U7XG5cbmZ1bmN0aW9uIGNyZWF0ZVVJRWxlbWVudHMoKSB7XG4gIC8vIENyZWF0ZSBGWCB1aVxuICBpZiAoZnhFbmFibGUpIHtcbiAgICBjb25zdCBmeGRpdiA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJmeFwiLCBcImZ4XCIsIGRvY3VtZW50LmJvZHkpO1xuICAgIGZ4ZGl2LnN0eWxlLmRpc3BsYXkgPSBmeEVuYWJsZSA/IFwiYmxvY2tcIiA6IFwibm9uZVwiO1xuICAgIGNvbnN0IGZ4MSA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJmeDFcIiwgXCJmeDFcIiwgZnhkaXYpO1xuICAgIGZ4MS5pbm5lclRleHQgPSBcIvCfjIpcIjtcbiAgICBjb25zdCBmeHNwYWNlciA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJmeHNwYWNlclwiLCBcImZ4c3BhY2VyXCIsIGZ4ZGl2KTtcbiAgICBjb25zdCBmeDIgPSBjcmVhdGVFbGVtZW50KFwiZGl2XCIsIFwiZngyXCIsIFwiZngyXCIsIGZ4ZGl2KTtcbiAgICBmeDIuaW5uZXJUZXh0ID0gXCLwn5WlXCI7XG4gIH1cblxuICBjb25zdCBtYXRyaXggPSBjcmVhdGVFbGVtZW50KFwiZGl2XCIsIFwibWF0cml4XCIsIFwibWF0cml4XCIsIGRvY3VtZW50LmJvZHkpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IG5TcXVhcmVzOyBpKyspIHtcbiAgICBjcmVhdGVFbGVtZW50KFwiZGl2XCIsIFwic3F1YXJlXCIsIGBzcXVhcmUtJHtpfWAsIG1hdHJpeCk7XG4gIH1cblxuICBjb25zdCBiYWxsSG9tZSA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJiYWxsaG9tZVwiLCBcImJhbGxob21lXCIsIGRvY3VtZW50LmJvZHkpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IG5CYWxsczsgaSsrKSB7XG4gICAgY29uc3QgYmFsbCA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJiYWxsXCIsIGBiYWxsLSR7aX1gLCBiYWxsSG9tZSk7XG4gICAgYmFsbC5kcmFnZ2FibGUgPSB0cnVlO1xuICAgIGJhbGwuaW5uZXJUZXh0ID0gYPCfjIhgO1xuICB9XG59XG5cbmZ1bmN0aW9uIGluaXRVSUxvZ2ljKCkge1xuICBjb25zdCBiYWxsczogTm9kZUxpc3RPZjxIVE1MRWxlbWVudD4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLmJhbGxcIik7XG5cbiAgLy8gRHJvcHMgYSBiYWxsIGludG8gYSB0YXJnZXQgZWxlbWVudCBhbmQgbXV0ZXMgdGhlIHRyYWNrIHRoZSBiYWxsIGNhbWUgZnJvbVxuICBjb25zdCBkcm9wQmFsbCA9IChiYWxsOiBIVE1MRWxlbWVudCwgdGFyZ2V0OiBIVE1MRWxlbWVudCkgPT4ge1xuICAgIGNvbnNvbGUubG9nKFwiRHJvcHBlZDpcIiwgYmFsbC5pZCwgdGFyZ2V0LmlkKTtcbiAgICBhYy5lbmFibGVUcmFjayhnZXRTcXVhcmVJZCh0YXJnZXQuaWQpLCB0cnVlKTtcbiAgICB0YXJnZXQuYXBwZW5kQ2hpbGQoYmFsbCk7XG4gICAgLy8gYmFsbC5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiOyAvLyBNYWtlIHN1cmUgdG8gZGlzcGxheSB0aGUgYmFsbCBhZ2FpblxuICB9O1xuXG4gIGJhbGxzLmZvckVhY2goKGJhbGwpID0+IHtcbiAgICAvLyBEZXNrdG9wIGNsaWNrIGV2ZW50c1xuICAgIGJhbGwuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlZG93blwiLCAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgICAgbW9iaWxlVXNhZ2UgPSBmYWxzZTsgLy8gQXNzdW1pbmcgeW91IHVzZSB0aGlzIHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gbW9iaWxlIGFuZCBkZXNrdG9wIHVzYWdlXG4gICAgICBjb25zdCBvcmlnaW5TcXVhcmUgPSBiYWxsLnBhcmVudEVsZW1lbnQgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICBiYWxsLnNldEF0dHJpYnV0ZShcIm9yaWdpbi1zcXVhcmVcIiwgb3JpZ2luU3F1YXJlLmlkKTtcbiAgICAgIGJhbGwuc2V0QXR0cmlidXRlKFwiY2xpY2tlZFwiLCBcInRydWVcIilcbiAgICAgIGNvbnNvbGUubG9nKFwiW01vdXNlZG93bl0gUGlja2VkIHVwXCIsIGJhbGwuaWQsIFwiZnJvbVwiLCBvcmlnaW5TcXVhcmUuaWQpO1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOyAvLyBUaGlzIHByZXZlbnRzIHRoZSBkZWZhdWx0IHRleHQgc2VsZWN0aW9uIGJlaGF2aW9yXG4gICAgfSk7XG5cbiAgICBiYWxsLmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZW1vdmVcIiwgKGU6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgIGlmIChiYWxsLmdldEF0dHJpYnV0ZShcImNsaWNrZWRcIikgIT09IFwidHJ1ZVwiKSByZXR1cm47XG4gICAgICBjb25zb2xlLmxvZyhcIltNb3VzZW1vdmVdIE1vdmluZ1wiLCBiYWxsLmlkKTtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGJhbGwuc3R5bGUubGVmdCA9IGAke2UuY2xpZW50WCAtIDI1fXB4YDsgLy8gQWRqdXN0IGZvciBjZW50ZXIgb2YgdGhlIGJhbGxcbiAgICAgIGJhbGwuc3R5bGUudG9wID0gYCR7ZS5jbGllbnRZIC0gMjV9cHhgO1xuICAgIH0pO1xuXG4gICAgYmFsbC5hZGRFdmVudExpc3RlbmVyKFwibW91c2V1cFwiLCAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgICAgaWYgKGJhbGwuZ2V0QXR0cmlidXRlKFwiY2xpY2tlZFwiKSAhPT0gXCJ0cnVlXCIpIHJldHVybjtcbiAgICAgIGNvbnN0IG9yaWdpblNxdWFyZUlkID0gYmFsbC5nZXRBdHRyaWJ1dGUoXCJvcmlnaW4tc3F1YXJlXCIpO1xuICAgICAgYWMuZW5hYmxlVHJhY2soZ2V0U3F1YXJlSWQob3JpZ2luU3F1YXJlSWQpLCBmYWxzZSk7XG4gICAgICBiYWxsLnNldEF0dHJpYnV0ZShcImNsaWNrZWRcIiwgXCJmYWxzZVwiKTtcbiAgICAgIHNob3dCYWxscyhmYWxzZSk7XG4gICAgICBjb25zdCB0YXJnZXRFbGVtZW50ID0gZG9jdW1lbnQuZWxlbWVudEZyb21Qb2ludChcbiAgICAgICAgZS5jbGllbnRYLFxuICAgICAgICBlLmNsaWVudFlcbiAgICAgICkgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICBzaG93QmFsbHModHJ1ZSk7XG5cbiAgICAgIGRyb3BCYWxsKGJhbGwsIHRhcmdldEVsZW1lbnQpO1xuICAgICAgY29uc29sZS5sb2coXCJbTW91c2V1cF0gRHJvcHBlZFwiLCBiYWxsLmlkLCBcImZyb21cIiwgb3JpZ2luU3F1YXJlSWQpO1xuICAgIH0pO1xuXG4gICAgLy8gTW9iaWxlIHRvdWNoIGV2ZW50c1xuICAgIGJhbGwuYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNoc3RhcnRcIiwgKGU6IFRvdWNoRXZlbnQpID0+IHtcbiAgICAgIG1vYmlsZVVzYWdlID0gdHJ1ZTtcbiAgICAgIGNvbnN0IG9yaWdpblNxdWFyZSA9IGJhbGwucGFyZW50RWxlbWVudCBhcyBIVE1MRWxlbWVudDtcbiAgICAgIGJhbGwuc2V0QXR0cmlidXRlKFwib3JpZ2luLXNxdWFyZVwiLCBvcmlnaW5TcXVhcmUuaWQpO1xuICAgICAgY29uc29sZS5sb2coXCJbVG91Y2hzdGFydF0gTGlmdGVkXCIsIGJhbGwuaWQsIFwiZnJvbVwiLCBvcmlnaW5TcXVhcmUuaWQpO1xuICAgIH0pO1xuXG4gICAgYmFsbC5hZGRFdmVudExpc3RlbmVyKFwidG91Y2htb3ZlXCIsIChlOiBUb3VjaEV2ZW50KSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhcIltUb3VjaG1vdmVdIERyYWdnaW5nXCIsIGJhbGwuaWQsIGUudG91Y2hlcy5sZW5ndGgpO1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgbW9iaWxlVXNhZ2UgPSB0cnVlO1xuICAgICAgaWYgKGUudG91Y2hlcy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgY29uc3QgdG91Y2ggPSBlLnRvdWNoZXNbMF07XG4gICAgICAgIGJhbGwuc3R5bGUubGVmdCA9IGAke3RvdWNoLmNsaWVudFggLSAyNX1weGA7IC8vIEFkanVzdCBmb3IgY2VudGVyIG9mIHRoZSBiYWxsXG4gICAgICAgIGJhbGwuc3R5bGUudG9wID0gYCR7dG91Y2guY2xpZW50WSAtIDI1fXB4YDtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGJhbGwuYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNoZW5kXCIsIChlOiBUb3VjaEV2ZW50KSA9PiB7XG4gICAgICAvLyBNdXRlIHRoZSBzcXVhcmUgdGhhdCB0aGUgYmFsbCBjYW1lIGZyb21cbiAgICAgIGNvbnN0IG9yaWdpblNxdWFyZUlkID0gYmFsbC5nZXRBdHRyaWJ1dGUoXCJvcmlnaW4tc3F1YXJlXCIpO1xuICAgICAgYWMuZW5hYmxlVHJhY2soZ2V0U3F1YXJlSWQob3JpZ2luU3F1YXJlSWQpLCBmYWxzZSk7XG5cbiAgICAgIC8vIGhpZGUgYmFsbHMgd2hpbGUgd2UgZmluZCB0aGUgdGFyZ2V0IGVsZW1lbnRcbiAgICAgIHNob3dCYWxscyhmYWxzZSk7XG4gICAgICBjb25zdCB0b3VjaCA9IGUuY2hhbmdlZFRvdWNoZXNbMF07XG4gICAgICBjb25zdCB0YXJnZXRFbGVtZW50ID0gZG9jdW1lbnQuZWxlbWVudEZyb21Qb2ludChcbiAgICAgICAgdG91Y2guY2xpZW50WCxcbiAgICAgICAgdG91Y2guY2xpZW50WVxuICAgICAgKSBhcyBIVE1MRWxlbWVudDtcbiAgICAgIHNob3dCYWxscyh0cnVlKTtcblxuICAgICAgZHJvcEJhbGwoYmFsbCwgdGFyZ2V0RWxlbWVudCk7XG4gICAgICBjb25zb2xlLmxvZyhcIltUb3VjaGVuZF0gRHJvcHBlZFwiLCBiYWxsLmlkKTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGluaXRGWFVJKCkge1xuICBpZiAoIWZ4RW5hYmxlKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IGZ4MSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZngxXCIpO1xuICBpZiAoIWZ4MSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcImZ4MSBub3QgZm91bmRcIik7XG4gIH1cbiAgZngxLmRyYWdnYWJsZSA9IHRydWU7XG4gIGNvbnN0IGZ4MiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZngyXCIpO1xuICBmeDE/LmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnc3RhcnRcIiwgKGU6IERyYWdFdmVudCkgPT4ge1xuICAgIGNvbnN0IHsgeCwgeSB9ID0gbm9ybWFsaXplZFhZKGUueCwgZS55KTtcbiAgICBhYy5meDEoeCwgeSk7XG4gICAgY29uc29sZS5sb2coXCJkcmFnc3RhcnRcIik7XG4gIH0pO1xuICBmeDE/LmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnXCIsIChlOiBEcmFnRXZlbnQpID0+IHtcbiAgICBjb25zdCB7IHgsIHkgfSA9IG5vcm1hbGl6ZWRYWShlLngsIGUueSk7XG4gICAgYWMuZngxKHgsIHkpO1xuICAgIGNvbnNvbGUubG9nKFwiZHJhZ21vdmVcIik7XG4gIH0pO1xuICBmeDE/LmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnZW5kXCIsIChlOiBEcmFnRXZlbnQpID0+IHtcbiAgICBhYy5meDEoMCwgMCk7XG4gICAgY29uc29sZS5sb2coXCJkcmFnZW5kXCIpO1xuICB9KTtcbiAgZngxPy5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hzdGFydFwiLCAoZTogVG91Y2hFdmVudCkgPT4ge1xuICAgIGlmIChlLnRvdWNoZXMubGVuZ3RoICE9IDEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgdG91Y2ggPSBlLnRvdWNoZXNbMF07XG4gICAgY29uc3QgeyB4LCB5IH0gPSBub3JtYWxpemVkWFkodG91Y2guY2xpZW50WCwgdG91Y2guY2xpZW50WSk7XG4gICAgYWMuZngxKHgsIHkpO1xuICAgIGNvbnNvbGUubG9nKFwidG91Y2hzdGFydFwiKTtcbiAgfSk7XG4gIGZ4MT8uYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNobW92ZVwiLCAoZTogVG91Y2hFdmVudCkgPT4ge1xuICAgIGlmIChlLnRvdWNoZXMubGVuZ3RoICE9IDEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgdG91Y2ggPSBlLnRvdWNoZXNbMF07XG4gICAgY29uc3QgeyB4LCB5IH0gPSBub3JtYWxpemVkWFkodG91Y2guY2xpZW50WCwgdG91Y2guY2xpZW50WSk7XG4gICAgYWMuZngxKHgsIHkpO1xuICAgIGNvbnNvbGUubG9nKFwidG91Y2htb3ZlXCIpO1xuICB9KTtcbiAgZngxPy5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hlbmRcIiwgKGU6IFRvdWNoRXZlbnQpID0+IHtcbiAgICBpZiAoZS50b3VjaGVzLmxlbmd0aCAhPSAxKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGFjLmZ4MSgwLCAwKTtcbiAgICBjb25zb2xlLmxvZyhcInRvdWNoZW5kXCIpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlRWxlbWVudChcbiAgdGFnOiBzdHJpbmcsXG4gIGNsczogc3RyaW5nLFxuICBpZDogc3RyaW5nLFxuICBwYXJlbnQ6IEhUTUxFbGVtZW50XG4pIHtcbiAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnKTtcbiAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKGNscyk7XG4gIGVsZW1lbnQuaWQgPSBpZDtcbiAgcGFyZW50LmFwcGVuZENoaWxkKGVsZW1lbnQpO1xuICByZXR1cm4gZWxlbWVudDtcbn1cblxuZnVuY3Rpb24gc2hvd0JhbGxzKHNob3c6IGJvb2xlYW4pIHtcbiAgY29uc3QgYmFsbHM6IE5vZGVMaXN0T2Y8SFRNTEVsZW1lbnQ+ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5iYWxsXCIpO1xuICBiYWxscy5mb3JFYWNoKChiYWxsKSA9PiB7XG4gICAgYmFsbC5zdHlsZS5kaXNwbGF5ID0gc2hvdyA/IFwiYmxvY2tcIiA6IFwibm9uZVwiO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0U3F1YXJlSWQoaWQ6IHN0cmluZyB8IG51bGwpOiBudW1iZXIge1xuICBpZiAoIWlkKSB7XG4gICAgcmV0dXJuIC0xO1xuICB9XG4gIGNvbnN0IHBhcnRzID0gaWQuc3BsaXQoXCJzcXVhcmUtXCIpO1xuICBpZiAocGFydHMubGVuZ3RoIDwgMikge1xuICAgIHJldHVybiAtMTtcbiAgfVxuICByZXR1cm4gcGFyc2VJbnQocGFydHNbMV0pO1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVkWFkoeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcbiAgY29uc3Qgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgY29uc3QgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xuICByZXR1cm4geyB4OiB4IC8gd2lkdGgsIHk6IHkgLyBoZWlnaHQgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5pdEF1ZGlvKCkge1xuICBpZiAoaXNJbml0aWF0ZWQpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgYXdhaXQgYWMuaW5pdEF1ZGlvKFtcbiAgICBcInN0ZW1zLzQtb24tZmxvb3Iud2F2XCIsXG4gICAgXCJzdGVtcy9iYXNzLndhdlwiLFxuICAgIFwic3RlbXMvZG5iLTEyNC53YXZcIixcbiAgICBcInN0ZW1zL2RydW1zLndhdlwiLFxuICAgIFwic3RlbXMvaGF0cy53YXZcIixcbiAgICBcInN0ZW1zL2tpY2staGF0LndhdlwiLFxuICAgIFwic3RlbXMvc21vb3RoLWNob3Jkcy53YXZcIixcbiAgICBcInN0ZW1zL3RvbXMud2F2XCIsXG4gICAgXCJzdGVtcy9ndWl0YXIud2F2XCIsXG4gICAgXCJzdGVtcy9iYXNzLndhdlwiLFxuICAgIFwic3RlbXMvZG5iLTEyNC53YXZcIixcbiAgICBcInN0ZW1zL2RydW1zLndhdlwiLFxuICAgIFwic3RlbXMvaGF0cy53YXZcIixcbiAgICBcInN0ZW1zL2tpY2staGF0LndhdlwiLFxuICAgIFwic3RlbXMvc21vb3RoLWNob3Jkcy53YXZcIixcbiAgICBcInN0ZW1zL2V4dGFjeS53YXZcIixcbiAgXSk7XG4gIGlzSW5pdGlhdGVkID0gdHJ1ZTtcbn1cblxuZnVuY3Rpb24gc3Bpbm5lcihzaG93OiBib29sZWFuKSB7XG4gIGlmIChzaG93KSB7XG4gICAgY3JlYXRlRWxlbWVudChcImRpdlwiLCBcInNwaW5uZXJcIiwgXCJzcGlubmVyXCIsIGRvY3VtZW50LmJvZHkpO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHNwaW5uZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInNwaW5uZXJcIik7XG4gICAgc3Bpbm5lcj8ucmVtb3ZlKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gY3JlYXRlU3RhcnRCdXR0b24oKSB7XG4gIGNvbnN0IHN0YXJ0QnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJzdGFydC1idXR0b25cIik7XG4gIGNvbnN0IGluZm8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImluZm9cIik7XG4gIHN0YXJ0QnV0dG9uPy5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgYXN5bmMgKCkgPT4ge1xuICAgIHN0YXJ0QnV0dG9uLnJlbW92ZSgpO1xuICAgIGluZm8/LnJlbW92ZSgpO1xuICAgIHNwaW5uZXIodHJ1ZSk7XG4gICAgYXdhaXQgaW5pdEF1ZGlvKCk7XG4gICAgc3Bpbm5lcihmYWxzZSk7XG4gICAgY3JlYXRlVUlFbGVtZW50cygpO1xuICAgIGluaXRVSUxvZ2ljKCk7XG4gICAgaW5pdEZYVUkoKTtcbiAgICBkcmF3KCk7XG4gIH0pO1xufVxuXG5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwiRE9NQ29udGVudExvYWRlZFwiLCAoKSA9PiB7XG4gIGNyZWF0ZVN0YXJ0QnV0dG9uKCk7XG59KTtcblxuZnVuY3Rpb24gZHJhdygpIHtcbiAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGRyYXcpO1xuICBpZiAoIWlzSW5pdGlhdGVkKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgblNxdWFyZXM7IGkrKykge1xuICAgIGNvbnN0IHNxdWFyZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBzcXVhcmUtJHtpfWApIGFzIEhUTUxFbGVtZW50O1xuICAgIGlmIChzcXVhcmUpIHtcbiAgICAgIHNxdWFyZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBhYy5nZXRGcmVxdWVuY3lDb2xvcihpKTtcbiAgICB9XG4gIH1cbn1cbiIsImV4cG9ydCBjbGFzcyBBdWRpb0NvbnRyb2xsZXIge1xuICBwcml2YXRlIGF1ZGlvQ29udGV4dDogQXVkaW9Db250ZXh0O1xuICBwcml2YXRlIHRyYWNrczoge1xuICAgIHNvdXJjZU5vZGU6IEF1ZGlvQnVmZmVyU291cmNlTm9kZTtcbiAgICBnYWluTm9kZTogR2Fpbk5vZGU7XG4gICAgYW5hbHlzZXJOb2RlOiBBbmFseXNlck5vZGU7XG4gIH1bXSA9IFtdO1xuICBwcml2YXRlIHNsb3dBdmVyYWdlOiBudW1iZXIgPSAzOTsgLy8gb3JhbmdlXG4gIHByaXZhdGUgZngxYTogQmlxdWFkRmlsdGVyTm9kZSB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGZ4MWI6IERlbGF5Tm9kZSB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuYXVkaW9Db250ZXh0ID0gbmV3IEF1ZGlvQ29udGV4dCgpO1xuICB9XG5cbiAgYXN5bmMgaW5pdEF1ZGlvKGZpbGVOYW1lczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoZmlsZU5hbWVzLmxlbmd0aCAhPT0gMTYpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkV4cGVjdGVkIDE2IGF1ZGlvIGZpbGVzLlwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBmaWxlUHJvbWlzZXMgPSBmaWxlTmFtZXMubWFwKChmaWxlTmFtZSkgPT5cbiAgICAgIHRoaXMubG9hZEF1ZGlvRmlsZShmaWxlTmFtZSlcbiAgICApO1xuXG4gICAgY29uc3QgYXVkaW9CdWZmZXJzID0gYXdhaXQgUHJvbWlzZS5hbGwoZmlsZVByb21pc2VzKTtcblxuICAgIGF1ZGlvQnVmZmVycy5mb3JFYWNoKChidWZmZXIpID0+IHtcbiAgICAgIGNvbnN0IHNvdXJjZU5vZGUgPSB0aGlzLmF1ZGlvQ29udGV4dC5jcmVhdGVCdWZmZXJTb3VyY2UoKTtcbiAgICAgIGNvbnN0IGdhaW5Ob2RlID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlR2FpbigpO1xuXG4gICAgICBzb3VyY2VOb2RlLmJ1ZmZlciA9IGJ1ZmZlcjtcbiAgICAgIGdhaW5Ob2RlLmdhaW4udmFsdWUgPSAwOyAvLyBTdGFydCBtdXRlZFxuICAgICAgc291cmNlTm9kZS5jb25uZWN0KGdhaW5Ob2RlKTtcblxuICAgICAgLy8gc2V0IHVwIGFuIGFuYWx5c2VyIHNvIHdlIGNhbiBkbyBjb29sIHZpc3VhbHNcbiAgICAgIGNvbnN0IGFuYWx5c2VyTm9kZSA9IHRoaXMuYXVkaW9Db250ZXh0LmNyZWF0ZUFuYWx5c2VyKCk7XG4gICAgICBhbmFseXNlck5vZGUuZmZ0U2l6ZSA9IDIwNDg7XG4gICAgICBnYWluTm9kZS5jb25uZWN0KGFuYWx5c2VyTm9kZSk7XG5cbiAgICAgIC8vIHNldCB1cCBmeCBub2Rlc1xuICAgICAgdGhpcy5meDFhID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlQmlxdWFkRmlsdGVyKCk7XG4gICAgICB0aGlzLmZ4MWEudHlwZSA9IFwiaGlnaHBhc3NcIjtcbiAgICAgIHRoaXMuZngxYS5mcmVxdWVuY3kudmFsdWUgPSAxMDAwO1xuICAgICAgdGhpcy5meDFhLmdhaW4udmFsdWUgPSAwO1xuICAgICAgZ2Fpbk5vZGUuY29ubmVjdCh0aGlzLmZ4MWEpO1xuXG4gICAgICB0aGlzLmZ4MWIgPSB0aGlzLmF1ZGlvQ29udGV4dC5jcmVhdGVEZWxheSgpO1xuICAgICAgdGhpcy5meDFiLmRlbGF5VGltZS52YWx1ZSA9IDA7IC8vIHBhc3MgdGhyb3VnaFxuICAgICAgdGhpcy5meDFhLmNvbm5lY3QodGhpcy5meDFiKTtcblxuICAgICAgLy8gZm9yIG5vdyBqdXN0IGJ5cGFzcyB0aGUgRlggbm9kZXMgLSBub3QgaW1wbGVtZW50ZWQgcHJvcGVybHkgeWV0XG4gICAgICAvLyAgIHRoaXMuZngxYi5jb25uZWN0KHRoaXMuYXVkaW9Db250ZXh0LmRlc3RpbmF0aW9uKTtcbiAgICAgIGdhaW5Ob2RlLmNvbm5lY3QodGhpcy5hdWRpb0NvbnRleHQuZGVzdGluYXRpb24pO1xuXG4gICAgICB0aGlzLnRyYWNrcy5wdXNoKHsgc291cmNlTm9kZSwgZ2Fpbk5vZGUsIGFuYWx5c2VyTm9kZSB9KTtcblxuICAgICAgc291cmNlTm9kZS5sb29wID0gdHJ1ZTtcbiAgICAgIHNvdXJjZU5vZGUuc3RhcnQoMCk7IC8vIFBsYXkgaW1tZWRpYXRlbHkgaW4gc3luY1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkQXVkaW9GaWxlKHVybDogc3RyaW5nKTogUHJvbWlzZTxBdWRpb0J1ZmZlcj4ge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsKTtcbiAgICBjb25zdCBhcnJheUJ1ZmZlciA9IGF3YWl0IHJlc3BvbnNlLmFycmF5QnVmZmVyKCk7XG4gICAgcmV0dXJuIHRoaXMuYXVkaW9Db250ZXh0LmRlY29kZUF1ZGlvRGF0YShhcnJheUJ1ZmZlcik7XG4gIH1cblxuICBnZXRGcmVxdWVuY3lDb2xvcih0cmFjazogbnVtYmVyKTogc3RyaW5nIHtcbiAgICBjb25zdCBnYWluTm9kZSA9IHRoaXMudHJhY2tzW3RyYWNrXS5nYWluTm9kZTtcbiAgICBpZiAoZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9PT0gMCkge1xuICAgICAgcmV0dXJuIGBoc2woJHt0aGlzLnNsb3dBdmVyYWdlICsgdHJhY2t9LCAxMDAlLCA1MCUpYDtcbiAgICB9XG4gICAgY29uc3QgYW5hbHlzZXJOb2RlID0gdGhpcy50cmFja3NbdHJhY2tdLmFuYWx5c2VyTm9kZTtcbiAgICBjb25zdCBkYXRhQXJyYXkgPSBuZXcgVWludDhBcnJheShhbmFseXNlck5vZGUuZnJlcXVlbmN5QmluQ291bnQpO1xuICAgIGFuYWx5c2VyTm9kZS5nZXRCeXRlRnJlcXVlbmN5RGF0YShkYXRhQXJyYXkpO1xuXG4gICAgLy8gZ2V0IHRoZSBoaWdoZXN0IGZyZXF1ZW5jeVxuICAgIGNvbnN0IG1heCA9IE1hdGgubWF4KC4uLmRhdGFBcnJheSk7XG4gICAgY29uc3QgbWF4SW5kZXggPSBkYXRhQXJyYXkuaW5kZXhPZihtYXgpO1xuICAgIHRoaXMudXBkYXRlU2xvd0F2ZXJhZ2UobWF4SW5kZXgpO1xuXG4gICAgY29uc3QgaHVlID0gdGhpcy5zbG93QXZlcmFnZSArIHRyYWNrICsgKChtYXhJbmRleCAqIDEwKSAlIDI0MCk7XG4gICAgcmV0dXJuIGBoc2woJHtodWV9LCAxMDAlLCA1MCUpYDtcbiAgfVxuXG4gIHVwZGF0ZVNsb3dBdmVyYWdlKHZhbHVlOiBudW1iZXIpIHtcbiAgICB0aGlzLnNsb3dBdmVyYWdlID0gdGhpcy5zbG93QXZlcmFnZSArICgodmFsdWUgKiAwLjAwMSkgJSAyNDApO1xuICB9XG5cbiAgZW5hYmxlVHJhY2sodHJhY2tOdW1iZXI6IG51bWJlciwgZW5hYmxlOiBib29sZWFuKTogdm9pZCB7XG4gICAgaWYgKHRyYWNrTnVtYmVyID09IC0xKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0cmFja051bWJlciA+PSB0aGlzLnRyYWNrcy5sZW5ndGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHJhY2sgJHt0cmFja051bWJlcn0gZG9lcyBub3QgZXhpc3QuYCk7XG4gICAgfVxuICAgIGNvbnNvbGUubG9nKFwiRW5hYmxpbmcgdHJhY2tcIiwgdHJhY2tOdW1iZXIsIGVuYWJsZSlcbiAgICB0aGlzLnRyYWNrc1t0cmFja051bWJlcl0uZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9IGVuYWJsZSA/IDAuNSA6IDA7XG4gIH1cblxuICBtdXRlQWxsKCk6IHZvaWQge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy50cmFja3MubGVuZ3RoOyBpKyspIHtcbiAgICAgIHRoaXMuZW5hYmxlVHJhY2soaSwgZmFsc2UpO1xuICAgIH1cbiAgfVxuXG4gIGZ4MSh4OiBudW1iZXIsIHk6IG51bWJlcikge1xuICAgIGlmICh4ICE9IDAgJiYgeSAhPSAwKSB7XG4gICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuMSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghdGhpcy5meDFhIHx8ICF0aGlzLmZ4MWIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc29sZS5sb2coXCJmeDEgY2FsbGVkIHdpdGggeDpcIiwgeCwgXCJ5OlwiLCB5KTtcbiAgICBjb25zb2xlLmxvZyhcIkF1ZGlvQ29udGV4dCBzdGF0ZTpcIiwgdGhpcy5hdWRpb0NvbnRleHQuc3RhdGUpO1xuICAgIGNvbnNvbGUubG9nKFwiQ3VycmVudCB0aW1lOlwiLCB0aGlzLmF1ZGlvQ29udGV4dC5jdXJyZW50VGltZSk7XG5cbiAgICBjb25zb2xlLmxvZyhcIkFwcGx5aW5nIGdhaW46XCIsIHggKiAyNSwgXCJ0byBmeDFhXCIpO1xuICAgIGNvbnN0IGdhaW4gPSBNYXRoLmZsb29yKHggKiAxMCk7XG4gICAgdGhpcy5meDFhLmdhaW4uc2V0VmFsdWVBdFRpbWUoZ2FpbiwgdGhpcy5hdWRpb0NvbnRleHQuY3VycmVudFRpbWUpO1xuICAgIHRoaXMuZngxYi5kZWxheVRpbWUuc2V0VmFsdWVBdFRpbWUoeSwgdGhpcy5hdWRpb0NvbnRleHQuY3VycmVudFRpbWUpO1xuXG4gICAgY29uc29sZS5sb2codGhpcy5meDFhLCB0aGlzLmZ4MWIpO1xuICB9XG59XG4iXSwibmFtZXMiOlsiYWMiLCJhdWRpb0NvbnRleHQiLCJ0cmFja3MiLCJzbG93QXZlcmFnZSIsImZ4MWEiLCJmeDFiIiwiY29uc3RydWN0b3IiLCJ0aGlzIiwiQXVkaW9Db250ZXh0IiwiaW5pdEF1ZGlvIiwiZmlsZU5hbWVzIiwibGVuZ3RoIiwiRXJyb3IiLCJmaWxlUHJvbWlzZXMiLCJtYXAiLCJmaWxlTmFtZSIsImxvYWRBdWRpb0ZpbGUiLCJQcm9taXNlIiwiYWxsIiwiZm9yRWFjaCIsImJ1ZmZlciIsInNvdXJjZU5vZGUiLCJjcmVhdGVCdWZmZXJTb3VyY2UiLCJnYWluTm9kZSIsImNyZWF0ZUdhaW4iLCJnYWluIiwidmFsdWUiLCJjb25uZWN0IiwiYW5hbHlzZXJOb2RlIiwiY3JlYXRlQW5hbHlzZXIiLCJmZnRTaXplIiwiY3JlYXRlQmlxdWFkRmlsdGVyIiwidHlwZSIsImZyZXF1ZW5jeSIsImNyZWF0ZURlbGF5IiwiZGVsYXlUaW1lIiwiZGVzdGluYXRpb24iLCJwdXNoIiwibG9vcCIsInN0YXJ0IiwidXJsIiwicmVzcG9uc2UiLCJmZXRjaCIsImFycmF5QnVmZmVyIiwiZGVjb2RlQXVkaW9EYXRhIiwiZ2V0RnJlcXVlbmN5Q29sb3IiLCJ0cmFjayIsImRhdGFBcnJheSIsIlVpbnQ4QXJyYXkiLCJmcmVxdWVuY3lCaW5Db3VudCIsImdldEJ5dGVGcmVxdWVuY3lEYXRhIiwibWF4IiwiTWF0aCIsIm1heEluZGV4IiwiaW5kZXhPZiIsInVwZGF0ZVNsb3dBdmVyYWdlIiwiZW5hYmxlVHJhY2siLCJ0cmFja051bWJlciIsImVuYWJsZSIsImNvbnNvbGUiLCJsb2ciLCJtdXRlQWxsIiwiaSIsImZ4MSIsIngiLCJ5IiwicmFuZG9tIiwic3RhdGUiLCJjdXJyZW50VGltZSIsImZsb29yIiwic2V0VmFsdWVBdFRpbWUiLCJuU3F1YXJlcyIsImlzSW5pdGlhdGVkIiwiY3JlYXRlRWxlbWVudCIsInRhZyIsImNscyIsImlkIiwicGFyZW50IiwiZWxlbWVudCIsImRvY3VtZW50IiwiY2xhc3NMaXN0IiwiYWRkIiwiYXBwZW5kQ2hpbGQiLCJzaG93QmFsbHMiLCJzaG93IiwicXVlcnlTZWxlY3RvckFsbCIsImJhbGwiLCJzdHlsZSIsImRpc3BsYXkiLCJnZXRTcXVhcmVJZCIsInBhcnRzIiwic3BsaXQiLCJwYXJzZUludCIsInNwaW5uZXIiLCJib2R5IiwiZ2V0RWxlbWVudEJ5SWQiLCJyZW1vdmUiLCJkcmF3IiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwic3F1YXJlIiwiYmFja2dyb3VuZENvbG9yIiwiYWRkRXZlbnRMaXN0ZW5lciIsInN0YXJ0QnV0dG9uIiwiaW5mbyIsImFzeW5jIiwibWF0cml4IiwiYmFsbEhvbWUiLCJkcmFnZ2FibGUiLCJpbm5lclRleHQiLCJjcmVhdGVVSUVsZW1lbnRzIiwiYmFsbHMiLCJkcm9wQmFsbCIsInRhcmdldCIsImUiLCJvcmlnaW5TcXVhcmUiLCJwYXJlbnRFbGVtZW50Iiwic2V0QXR0cmlidXRlIiwicHJldmVudERlZmF1bHQiLCJnZXRBdHRyaWJ1dGUiLCJsZWZ0IiwiY2xpZW50WCIsInRvcCIsImNsaWVudFkiLCJvcmlnaW5TcXVhcmVJZCIsInRhcmdldEVsZW1lbnQiLCJlbGVtZW50RnJvbVBvaW50IiwidG91Y2hlcyIsInRvdWNoIiwiY2hhbmdlZFRvdWNoZXMiLCJpbml0VUlMb2dpYyIsImNyZWF0ZVN0YXJ0QnV0dG9uIl0sInNvdXJjZVJvb3QiOiIifQ==