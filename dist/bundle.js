(()=>{"use strict";const e=new class{audioContext;tracks=[];slowAverage=39;fx1a=null;fx1b=null;constructor(){this.audioContext=new AudioContext}async initAudio(e){if(16!==e.length)throw new Error("Expected 16 audio files.");const t=e.map((e=>this.loadAudioFile(e)));(await Promise.all(t)).forEach((e=>{const t=this.audioContext.createBufferSource(),n=this.audioContext.createGain();t.buffer=e,n.gain.value=0,t.connect(n);const o=this.audioContext.createAnalyser();o.fftSize=2048,n.connect(o),this.fx1a=this.audioContext.createBiquadFilter(),this.fx1a.type="highpass",this.fx1a.frequency.value=1e3,this.fx1a.gain.value=0,n.connect(this.fx1a),this.fx1b=this.audioContext.createDelay(),this.fx1b.delayTime.value=0,this.fx1a.connect(this.fx1b),n.connect(this.audioContext.destination),this.tracks.push({sourceNode:t,gainNode:n,analyserNode:o}),t.loop=!0,t.start(0)}))}async loadAudioFile(e){const t=await fetch(e),n=await t.arrayBuffer();return this.audioContext.decodeAudioData(n)}getFrequencyColor(e){if(0===this.tracks[e].gainNode.gain.value)return`hsl(${this.slowAverage+e}, 100%, 50%)`;const t=this.tracks[e].analyserNode,n=new Uint8Array(t.frequencyBinCount);t.getByteFrequencyData(n);const o=Math.max(...n),s=n.indexOf(o);return this.updateSlowAverage(s),`hsl(${this.slowAverage+e+10*s%240}, 100%, 50%)`}updateSlowAverage(e){this.slowAverage=this.slowAverage+.001*e%240}enableTrack(e,t){if(-1!=e){if(e>=this.tracks.length)throw new Error(`Track ${e} does not exist.`);this.tracks[e].gainNode.gain.value=t?.5:0}}muteAll(){for(let e=0;e<this.tracks.length;e++)this.enableTrack(e,!1)}fx1(e,t){if(0!=e&&0!=t&&Math.random()>.1)return;if(!this.fx1a||!this.fx1b)return;console.log("fx1 called with x:",e,"y:",t),console.log("AudioContext state:",this.audioContext.state),console.log("Current time:",this.audioContext.currentTime),console.log("Applying gain:",25*e,"to fx1a");const n=Math.floor(10*e);this.fx1a.gain.setValueAtTime(n,this.audioContext.currentTime),this.fx1b.delayTime.setValueAtTime(t,this.audioContext.currentTime),console.log(this.fx1a,this.fx1b)}},t=16;var n=!1;function o(e){if("undefined"!=typeof TouchEvent&&e instanceof TouchEvent&&(e.touches||e.changedTouches)){const t=e.touches.length>0?e.touches:e.changedTouches;return{x:t[0].clientX,y:t[0].clientY}}if(e instanceof MouseEvent)return{x:e.clientX,y:e.clientY};throw new Error("Unsupported event type")}function s(e,t,n,o){const s=document.createElement(e);return s.classList.add(t),s.id=n,o.appendChild(s),s}function i(e){document.querySelectorAll(".ball").forEach((t=>{t.style.display=e?"block":"none"}))}function a(e){if(!e)return-1;const t=e.split("square-");return t.length<2?-1:parseInt(t[1])}function r(e){if(e)s("div","spinner","spinner",document.body);else{const e=document.getElementById("spinner");e?.remove()}}function c(){const c=document.getElementById("start-button"),l=document.getElementById("info-1"),d=document.getElementById("info-2");c?.addEventListener("click",(async()=>{c.remove(),l?.remove(),d?.remove(),r(!0),await async function(){n||(await e.initAudio(["stems/4-on-floor.wav","stems/dnb-124.wav","stems/drums.wav","stems/hats.wav","stems/kick-hat.wav","stems/toms.wav","stems/smooth-chords.wav","stems/bass.wav","stems/bzzz.wav","stems/guitar.wav","stems/dnb-124.wav","stems/drums.wav","stems/hats.wav","stems/keep-on.wav","stems/what-u-doin-to-me.wav","stems/extacy.wav"]),n=!0)}(),r(!1),function(){const e=s("div","matrix","matrix",document.body);for(let n=0;n<t;n++)s("div","square",`square-${n}`,e);const n=s("div","ballhome","ballhome",document.body);for(let e=0;e<4;e++){const t=s("div","ball",`ball-${e}`,n);t.draggable=!0,t.innerText="ðŸŒˆ"}}(),function(){const t=document.querySelectorAll(".ball");var n=!1;t.forEach((t=>{function n(e){e.preventDefault();const n=t.parentElement;t.setAttribute("origin-square",n.id),t.setAttribute("clicked","true"),console.log(`[${e.type}] Lifted`,t.id,"from",n.id)}function s(e){if(e.preventDefault(),"true"!==t.getAttribute("clicked"))return;const n=o(e);t.style.left=n.x-50+"px",t.style.top=n.y-50+"px"}function r(n){if("true"!==t.getAttribute("clicked"))return;const s=o(n),r=t.getAttribute("origin-square");e.enableTrack(a(r),!1),t.setAttribute("clicked","false"),i(!1);const c=document.elementFromPoint(s.x,s.y);i(!0),((t,n)=>{console.log("Dropped:",t.id,n.id),e.enableTrack(a(n.id),!0),n.appendChild(t)})(t,c),console.log(`[${n.type}] Dropped`,t.id,"from",r)}t.addEventListener("mousedown",n),t.addEventListener("mousemove",s),t.addEventListener("mouseup",r),t.addEventListener("touchstart",n),t.addEventListener("touchmove",s),t.addEventListener("touchend",r)})),document.addEventListener("mouseup",(e=>{n=!1})),document.addEventListener("mousedown",(e=>{n=!0})),document.addEventListener("mousemove",(e=>{if(!n)return;const s=o(e);var i=t[0];t.forEach((e=>{i=null,"true"===e.getAttribute("clicked")&&(i=e)})),i&&0!=function(e,t,n){const o=e.getBoundingClientRect(),s=o.left+o.width/2,i=o.top+o.height/2;return Math.sqrt((s-t)**2+(i-n)**2)}(i,e.clientX,e.clientY)&&(i.style.left=s.x-50+"px",i.style.top=s.y-50+"px")}))}(),u()}))}function u(){if(requestAnimationFrame(u),n)for(let n=0;n<t;n++){const t=document.getElementById(`square-${n}`);t&&(t.style.backgroundColor=e.getFrequencyColor(n))}}document.addEventListener("DOMContentLoaded",(()=>{c()}))})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVuZGxlLmpzIiwibWFwcGluZ3MiOiJtQkFFQSxNQUFNQSxFQUFLLElDRkosTUFDR0MsYUFDQUMsT0FJRixHQUNFQyxZQUFzQixHQUN0QkMsS0FBZ0MsS0FDaENDLEtBQXlCLEtBRWpDLFdBQUFDLEdBQ0VDLEtBQUtOLGFBQWUsSUFBSU8sWUFDMUIsQ0FFQSxlQUFNQyxDQUFVQyxHQUNkLEdBQXlCLEtBQXJCQSxFQUFVQyxPQUNaLE1BQU0sSUFBSUMsTUFBTSw0QkFHbEIsTUFBTUMsRUFBZUgsRUFBVUksS0FBS0MsR0FDbENSLEtBQUtTLGNBQWNELFlBR01FLFFBQVFDLElBQUlMLElBRTFCTSxTQUFTQyxJQUNwQixNQUFNQyxFQUFhZCxLQUFLTixhQUFhcUIscUJBQy9CQyxFQUFXaEIsS0FBS04sYUFBYXVCLGFBRW5DSCxFQUFXRCxPQUFTQSxFQUNwQkcsRUFBU0UsS0FBS0MsTUFBUSxFQUN0QkwsRUFBV00sUUFBUUosR0FHbkIsTUFBTUssRUFBZXJCLEtBQUtOLGFBQWE0QixpQkFDdkNELEVBQWFFLFFBQVUsS0FDdkJQLEVBQVNJLFFBQVFDLEdBR2pCckIsS0FBS0gsS0FBT0csS0FBS04sYUFBYThCLHFCQUM5QnhCLEtBQUtILEtBQUs0QixLQUFPLFdBQ2pCekIsS0FBS0gsS0FBSzZCLFVBQVVQLE1BQVEsSUFDNUJuQixLQUFLSCxLQUFLcUIsS0FBS0MsTUFBUSxFQUN2QkgsRUFBU0ksUUFBUXBCLEtBQUtILE1BRXRCRyxLQUFLRixLQUFPRSxLQUFLTixhQUFhaUMsY0FDOUIzQixLQUFLRixLQUFLOEIsVUFBVVQsTUFBUSxFQUM1Qm5CLEtBQUtILEtBQUt1QixRQUFRcEIsS0FBS0YsTUFJdkJrQixFQUFTSSxRQUFRcEIsS0FBS04sYUFBYW1DLGFBRW5DN0IsS0FBS0wsT0FBT21DLEtBQUssQ0FBRWhCLGFBQVlFLFdBQVVLLGlCQUV6Q1AsRUFBV2lCLE1BQU8sRUFDbEJqQixFQUFXa0IsTUFBTSxFQUFFLEdBRXZCLENBRVEsbUJBQU12QixDQUFjd0IsR0FDMUIsTUFBTUMsUUFBaUJDLE1BQU1GLEdBQ3ZCRyxRQUFvQkYsRUFBU0UsY0FDbkMsT0FBT3BDLEtBQUtOLGFBQWEyQyxnQkFBZ0JELEVBQzNDLENBRUEsaUJBQUFFLENBQWtCQyxHQUVoQixHQUE0QixJQURYdkMsS0FBS0wsT0FBTzRDLEdBQU92QixTQUN2QkUsS0FBS0MsTUFDaEIsTUFBTyxPQUFPbkIsS0FBS0osWUFBYzJDLGdCQUVuQyxNQUFNbEIsRUFBZXJCLEtBQUtMLE9BQU80QyxHQUFPbEIsYUFDbENtQixFQUFZLElBQUlDLFdBQVdwQixFQUFhcUIsbUJBQzlDckIsRUFBYXNCLHFCQUFxQkgsR0FHbEMsTUFBTUksRUFBTUMsS0FBS0QsT0FBT0osR0FDbEJNLEVBQVdOLEVBQVVPLFFBQVFILEdBSW5DLE9BSEE1QyxLQUFLZ0Qsa0JBQWtCRixHQUdoQixPQURLOUMsS0FBS0osWUFBYzJDLEVBQXFCLEdBQVhPLEVBQWlCLGlCQUU1RCxDQUVBLGlCQUFBRSxDQUFrQjdCLEdBQ2hCbkIsS0FBS0osWUFBY0ksS0FBS0osWUFBd0IsS0FBUnVCLEVBQWlCLEdBQzNELENBRUEsV0FBQThCLENBQVlDLEVBQXFCQyxHQUMvQixJQUFvQixHQUFoQkQsRUFBSixDQUdBLEdBQUlBLEdBQWVsRCxLQUFLTCxPQUFPUyxPQUM3QixNQUFNLElBQUlDLE1BQU0sU0FBUzZDLHFCQUUzQmxELEtBQUtMLE9BQU91RCxHQUFhbEMsU0FBU0UsS0FBS0MsTUFBUWdDLEVBQVMsR0FBTSxDLENBQ2hFLENBRUEsT0FBQUMsR0FDRSxJQUFLLElBQUlDLEVBQUksRUFBR0EsRUFBSXJELEtBQUtMLE9BQU9TLE9BQVFpRCxJQUN0Q3JELEtBQUtpRCxZQUFZSSxHQUFHLEVBRXhCLENBRUEsR0FBQUMsQ0FBSUMsRUFBV0MsR0FDYixHQUFTLEdBQUxELEdBQWUsR0FBTEMsR0FDUlgsS0FBS1ksU0FBVyxHQUNsQixPQUdKLElBQUt6RCxLQUFLSCxPQUFTRyxLQUFLRixLQUN0QixPQUVGNEQsUUFBUUMsSUFBSSxxQkFBc0JKLEVBQUcsS0FBTUMsR0FDM0NFLFFBQVFDLElBQUksc0JBQXVCM0QsS0FBS04sYUFBYWtFLE9BQ3JERixRQUFRQyxJQUFJLGdCQUFpQjNELEtBQUtOLGFBQWFtRSxhQUUvQ0gsUUFBUUMsSUFBSSxpQkFBc0IsR0FBSkosRUFBUSxXQUN0QyxNQUFNckMsRUFBTzJCLEtBQUtpQixNQUFVLEdBQUpQLEdBQ3hCdkQsS0FBS0gsS0FBS3FCLEtBQUs2QyxlQUFlN0MsRUFBTWxCLEtBQUtOLGFBQWFtRSxhQUN0RDdELEtBQUtGLEtBQUs4QixVQUFVbUMsZUFBZVAsRUFBR3hELEtBQUtOLGFBQWFtRSxhQUV4REgsUUFBUUMsSUFBSTNELEtBQUtILEtBQU1HLEtBQUtGLEtBQzlCLEdEekhJa0UsRUFBVyxHQUVqQixJQUFJQyxHQUFjLEVBbUhsQixTQUFTQyxFQUFxQkMsR0FDNUIsR0FBMEIsb0JBQWZDLFlBQThCRCxhQUFhQyxhQUFlRCxFQUFFRSxTQUFXRixFQUFFRyxnQkFBaUIsQ0FDbkcsTUFBTUQsRUFBVUYsRUFBRUUsUUFBUWpFLE9BQVMsRUFBSStELEVBQUVFLFFBQVVGLEVBQUVHLGVBQ3JELE1BQU8sQ0FBRWYsRUFBR2MsRUFBUSxHQUFHRSxRQUFTZixFQUFHYSxFQUFRLEdBQUdHLFEsQ0FDekMsR0FBSUwsYUFBYU0sV0FDdEIsTUFBTyxDQUFFbEIsRUFBR1ksRUFBRUksUUFBU2YsRUFBR1csRUFBRUssU0FFNUIsTUFBTSxJQUFJbkUsTUFBTSx5QkFFcEIsQ0FzREEsU0FBU3FFLEVBQ1BDLEVBQ0FDLEVBQ0FDLEVBQ0FDLEdBRUEsTUFBTUMsRUFBVUMsU0FBU04sY0FBY0MsR0FJdkMsT0FIQUksRUFBUUUsVUFBVUMsSUFBSU4sR0FDdEJHLEVBQVFGLEdBQUtBLEVBQ2JDLEVBQU9LLFlBQVlKLEdBQ1pBLENBQ1QsQ0FFQSxTQUFTSyxFQUFVQyxHQUNzQkwsU0FBU00saUJBQWlCLFNBQzNEMUUsU0FBUzJFLElBQ2JBLEVBQUtDLE1BQU1DLFFBQVVKLEVBQU8sUUFBVSxNQUFNLEdBRWhELENBRUEsU0FBU0ssRUFBWWIsR0FDbkIsSUFBS0EsRUFDSCxPQUFRLEVBRVYsTUFBTWMsRUFBUWQsRUFBR2UsTUFBTSxXQUN2QixPQUFJRCxFQUFNdkYsT0FBUyxHQUNULEVBRUh5RixTQUFTRixFQUFNLEdBQ3hCLENBaUNBLFNBQVNHLEVBQVFULEdBQ2YsR0FBSUEsRUFDRlgsRUFBYyxNQUFPLFVBQVcsVUFBV00sU0FBU2UsVUFDL0MsQ0FDTCxNQUFNRCxFQUFVZCxTQUFTZ0IsZUFBZSxXQUN4Q0YsR0FBU0csUSxDQUViLENBRUEsU0FBU0MsSUFDUCxNQUFNQyxFQUFjbkIsU0FBU2dCLGVBQWUsZ0JBQ3RDSSxFQUFRcEIsU0FBU2dCLGVBQWUsVUFDaENLLEVBQVFyQixTQUFTZ0IsZUFBZSxVQUN0Q0csR0FBYUcsaUJBQWlCLFNBQVNDLFVBQ3JDSixFQUFZRixTQUNaRyxHQUFPSCxTQUNQSSxHQUFPSixTQUNQSCxHQUFRLFNBMUNaUyxpQkFDTXRDLFVBR0V4RSxFQUFHUyxVQUFVLENBQ2pCLHVCQUNBLG9CQUNBLGtCQUNBLGlCQUNBLHFCQUNBLGlCQUNBLDBCQUNBLGlCQUNBLGlCQUNBLG1CQUNBLG9CQUNBLGtCQUNBLGlCQUNBLG9CQUNBLDhCQUNBLHFCQUVGK0QsR0FBYyxFQUNoQixDQW9CVS9ELEdBQ040RixHQUFRLEdBaFFaLFdBWUUsTUFBTVUsRUFBUzlCLEVBQWMsTUFBTyxTQUFVLFNBQVVNLFNBQVNlLE1BQ2pFLElBQUssSUFBSTFDLEVBQUksRUFBR0EsRUFBSVcsRUFBVVgsSUFDNUJxQixFQUFjLE1BQU8sU0FBVSxVQUFVckIsSUFBS21ELEdBR2hELE1BQU1DLEVBQVcvQixFQUFjLE1BQU8sV0FBWSxXQUFZTSxTQUFTZSxNQUN2RSxJQUFLLElBQUkxQyxFQUFJLEVBQUdBLEVBdEJILEVBc0JlQSxJQUFLLENBQy9CLE1BQU1rQyxFQUFPYixFQUFjLE1BQU8sT0FBUSxRQUFRckIsSUFBS29ELEdBQ3ZEbEIsRUFBS21CLFdBQVksRUFDakJuQixFQUFLb0IsVUFBWSxJLENBRXJCLENBME9JQyxHQXhPSixXQUNFLE1BQU1DLEVBQWlDN0IsU0FBU00saUJBQWlCLFNBQ2pFLElBQUl3QixHQUFZLEVBUWhCRCxFQUFNakcsU0FBUzJFLElBRWIsU0FBU3dCLEVBQVU1QyxHQUNqQkEsRUFBRTZDLGlCQUNGLE1BQU1DLEVBQWUxQixFQUFLMkIsY0FDMUIzQixFQUFLNEIsYUFBYSxnQkFBaUJGLEVBQWFwQyxJQUNoRFUsRUFBSzRCLGFBQWEsVUFBVyxRQUM3QnpELFFBQVFDLElBQUksSUFBSVEsRUFBRTFDLGVBQWdCOEQsRUFBS1YsR0FBSSxPQUFRb0MsRUFBYXBDLEdBQ2xFLENBR0EsU0FBU3VDLEVBQU9qRCxHQUVkLEdBREFBLEVBQUU2QyxpQkFDbUMsU0FBakN6QixFQUFLOEIsYUFBYSxXQUF1QixPQUM3QyxNQUFNQyxFQUFXcEQsRUFBcUJDLEdBQ3RDb0IsRUFBS0MsTUFBTStCLEtBQVVELEVBQVMvRCxFQUFJLEdBQWhCLEtBQ2xCZ0MsRUFBS0MsTUFBTWdDLElBQVNGLEVBQVM5RCxFQUFJLEdBQWhCLElBRW5CLENBR0EsU0FBU2lFLEVBQVF0RCxHQUNmLEdBQXFDLFNBQWpDb0IsRUFBSzhCLGFBQWEsV0FBdUIsT0FDN0MsTUFBTUMsRUFBV3BELEVBQXFCQyxHQUNoQ3VELEVBQWlCbkMsRUFBSzhCLGFBQWEsaUJBQ3pDNUgsRUFBR3dELFlBQVl5QyxFQUFZZ0MsSUFBaUIsR0FDNUNuQyxFQUFLNEIsYUFBYSxVQUFXLFNBQzdCL0IsR0FBVSxHQUNWLE1BQU11QyxFQUFnQjNDLFNBQVM0QyxpQkFDN0JOLEVBQVMvRCxFQUNUK0QsRUFBUzlELEdBRVg0QixHQUFVLEdBdENHLEVBQUNHLEVBQW1Cc0MsS0FDbkNuRSxRQUFRQyxJQUFJLFdBQVk0QixFQUFLVixHQUFJZ0QsRUFBT2hELElBQ3hDcEYsRUFBR3dELFlBQVl5QyxFQUFZbUMsRUFBT2hELEtBQUssR0FDdkNnRCxFQUFPMUMsWUFBWUksRUFBSyxFQW9DdEJ1QyxDQUFTdkMsRUFBTW9DLEdBQ2ZqRSxRQUFRQyxJQUFJLElBQUlRLEVBQUUxQyxnQkFBaUI4RCxFQUFLVixHQUFJLE9BQVE2QyxFQUN0RCxDQUdBbkMsRUFBS2UsaUJBQWlCLFlBQWFTLEdBQ25DeEIsRUFBS2UsaUJBQWlCLFlBQWFjLEdBQ25DN0IsRUFBS2UsaUJBQWlCLFVBQVdtQixHQUNqQ2xDLEVBQUtlLGlCQUFpQixhQUFjUyxHQUNwQ3hCLEVBQUtlLGlCQUFpQixZQUFhYyxHQUNuQzdCLEVBQUtlLGlCQUFpQixXQUFZbUIsRUFBUSxJQUU1Q3pDLFNBQVNzQixpQkFBaUIsV0FBWW5DLElBQ3BDMkMsR0FBWSxDQUFLLElBRW5COUIsU0FBU3NCLGlCQUFpQixhQUFjbkMsSUFDdEMyQyxHQUFZLENBQUksSUFFbEI5QixTQUFTc0IsaUJBQWlCLGFBQWNuQyxJQUN0QyxJQUFLMkMsRUFBVyxPQUNoQixNQUFNUSxFQUFXcEQsRUFBcUJDLEdBQ3RDLElBQUk0RCxFQUFrQ2xCLEVBQU0sR0FFNUNBLEVBQU1qRyxTQUFTMkUsSUFDYndDLEVBQWMsS0FDdUIsU0FBakN4QyxFQUFLOEIsYUFBYSxhQUNwQlUsRUFBY3hDLEUsSUFHYndDLEdBQ3NELEdBTS9ELFNBQTBCeEMsRUFBbUJoQyxFQUFXQyxHQUN0RCxNQUFNd0UsRUFBT3pDLEVBQUswQyx3QkFDWkMsRUFBUUYsRUFBS1QsS0FBT1MsRUFBS0csTUFBUSxFQUNqQ0MsRUFBUUosRUFBS1IsSUFBTVEsRUFBS0ssT0FBUyxFQUN2QyxPQUFPeEYsS0FBS3lGLE1BQU1KLEVBQVEzRSxJQUFNLEdBQUs2RSxFQUFRNUUsSUFBTSxFQUNyRCxDQVhRK0UsQ0FBaUJSLEVBQWE1RCxFQUFFSSxRQUFTSixFQUFFSyxXQUMvQ3VELEVBQVl2QyxNQUFNK0IsS0FBVUQsRUFBUy9ELEVBQUksR0FBaEIsS0FDekJ3RSxFQUFZdkMsTUFBTWdDLElBQVNGLEVBQVM5RCxFQUFJLEdBQWhCLEtBQXNCLEdBRWxELENBNEpJZ0YsR0FFQUMsR0FBTSxHQUVWLENBTUEsU0FBU0EsSUFFUCxHQURBQyxzQkFBc0JELEdBQ2pCeEUsRUFHTCxJQUFLLElBQUlaLEVBQUksRUFBR0EsRUFBSVcsRUFBVVgsSUFBSyxDQUNqQyxNQUFNc0YsRUFBUzNELFNBQVNnQixlQUFlLFVBQVUzQyxLQUM3Q3NGLElBQ0ZBLEVBQU9uRCxNQUFNb0QsZ0JBQWtCbkosRUFBRzZDLGtCQUFrQmUsRyxDQUcxRCxDQWZBMkIsU0FBU3NCLGlCQUFpQixvQkFBb0IsS0FDNUNKLEdBQW1CLEciLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9zcXVhcmVzLy4vc3JjL21haW4udHMiLCJ3ZWJwYWNrOi8vc3F1YXJlcy8uL3NyYy9hdWRpby50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBdWRpb0NvbnRyb2xsZXIgfSBmcm9tIFwiLi9hdWRpb1wiO1xuXG5jb25zdCBhYyA9IG5ldyBBdWRpb0NvbnRyb2xsZXIoKTtcbmNvbnN0IG5TcXVhcmVzID0gMTY7XG5jb25zdCBuQmFsbHMgPSA0O1xudmFyIGlzSW5pdGlhdGVkID0gZmFsc2U7XG52YXIgZnhFbmFibGUgPSBmYWxzZTtcblxuZnVuY3Rpb24gY3JlYXRlVUlFbGVtZW50cygpIHtcbiAgLy8gQ3JlYXRlIEZYIHVpXG4gIGlmIChmeEVuYWJsZSkge1xuICAgIGNvbnN0IGZ4ZGl2ID0gY3JlYXRlRWxlbWVudChcImRpdlwiLCBcImZ4XCIsIFwiZnhcIiwgZG9jdW1lbnQuYm9keSk7XG4gICAgZnhkaXYuc3R5bGUuZGlzcGxheSA9IGZ4RW5hYmxlID8gXCJibG9ja1wiIDogXCJub25lXCI7XG4gICAgY29uc3QgZngxID0gY3JlYXRlRWxlbWVudChcImRpdlwiLCBcImZ4MVwiLCBcImZ4MVwiLCBmeGRpdik7XG4gICAgZngxLmlubmVyVGV4dCA9IFwi8J+MilwiO1xuICAgIGNvbnN0IGZ4c3BhY2VyID0gY3JlYXRlRWxlbWVudChcImRpdlwiLCBcImZ4c3BhY2VyXCIsIFwiZnhzcGFjZXJcIiwgZnhkaXYpO1xuICAgIGNvbnN0IGZ4MiA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJmeDJcIiwgXCJmeDJcIiwgZnhkaXYpO1xuICAgIGZ4Mi5pbm5lclRleHQgPSBcIvCflaVcIjtcbiAgfVxuXG4gIGNvbnN0IG1hdHJpeCA9IGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJtYXRyaXhcIiwgXCJtYXRyaXhcIiwgZG9jdW1lbnQuYm9keSk7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgblNxdWFyZXM7IGkrKykge1xuICAgIGNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgXCJzcXVhcmVcIiwgYHNxdWFyZS0ke2l9YCwgbWF0cml4KTtcbiAgfVxuXG4gIGNvbnN0IGJhbGxIb21lID0gY3JlYXRlRWxlbWVudChcImRpdlwiLCBcImJhbGxob21lXCIsIFwiYmFsbGhvbWVcIiwgZG9jdW1lbnQuYm9keSk7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbkJhbGxzOyBpKyspIHtcbiAgICBjb25zdCBiYWxsID0gY3JlYXRlRWxlbWVudChcImRpdlwiLCBcImJhbGxcIiwgYGJhbGwtJHtpfWAsIGJhbGxIb21lKTtcbiAgICBiYWxsLmRyYWdnYWJsZSA9IHRydWU7XG4gICAgYmFsbC5pbm5lclRleHQgPSBg8J+MiGA7XG4gIH1cbn1cblxuZnVuY3Rpb24gaW5pdFVJTG9naWMoKSB7XG4gIGNvbnN0IGJhbGxzOiBOb2RlTGlzdE9mPEhUTUxFbGVtZW50PiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCIuYmFsbFwiKTtcbiAgdmFyIG1vdXNlRG93biA9IGZhbHNlO1xuICAvLyBEcm9wcyBhIGJhbGwgaW50byBhIHRhcmdldCBlbGVtZW50IGFuZCBtdXRlcyB0aGUgdHJhY2sgdGhlIGJhbGwgY2FtZSBmcm9tXG4gIGNvbnN0IGRyb3BCYWxsID0gKGJhbGw6IEhUTUxFbGVtZW50LCB0YXJnZXQ6IEhUTUxFbGVtZW50KSA9PiB7XG4gICAgY29uc29sZS5sb2coXCJEcm9wcGVkOlwiLCBiYWxsLmlkLCB0YXJnZXQuaWQpO1xuICAgIGFjLmVuYWJsZVRyYWNrKGdldFNxdWFyZUlkKHRhcmdldC5pZCksIHRydWUpO1xuICAgIHRhcmdldC5hcHBlbmRDaGlsZChiYWxsKTtcbiAgfTtcblxuICBiYWxscy5mb3JFYWNoKChiYWxsKSA9PiB7XG4gICAgLy8gQ29tbW9uIGZ1bmN0aW9uIGZvciBzdGFydGluZyB0aGUgZHJhZ1xuICAgIGZ1bmN0aW9uIHN0YXJ0RHJhZyhlOiBNb3VzZUV2ZW50IHwgVG91Y2hFdmVudCkge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgY29uc3Qgb3JpZ2luU3F1YXJlID0gYmFsbC5wYXJlbnRFbGVtZW50IGFzIEhUTUxFbGVtZW50O1xuICAgICAgYmFsbC5zZXRBdHRyaWJ1dGUoXCJvcmlnaW4tc3F1YXJlXCIsIG9yaWdpblNxdWFyZS5pZCk7XG4gICAgICBiYWxsLnNldEF0dHJpYnV0ZShcImNsaWNrZWRcIiwgXCJ0cnVlXCIpO1xuICAgICAgY29uc29sZS5sb2coYFske2UudHlwZX1dIExpZnRlZGAsIGJhbGwuaWQsIFwiZnJvbVwiLCBvcmlnaW5TcXVhcmUuaWQpO1xuICAgIH1cblxuICAgIC8vIENvbW1vbiBmdW5jdGlvbiBmb3IgZHJhZ2dpbmdcbiAgICBmdW5jdGlvbiBkb0RyYWcoZTogTW91c2VFdmVudCB8IFRvdWNoRXZlbnQpIHtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGlmIChiYWxsLmdldEF0dHJpYnV0ZShcImNsaWNrZWRcIikgIT09IFwidHJ1ZVwiKSByZXR1cm47XG4gICAgICBjb25zdCBwb3NpdGlvbiA9IGdldFBvc2l0aW9uRnJvbUV2ZW50KGUpO1xuICAgICAgYmFsbC5zdHlsZS5sZWZ0ID0gYCR7cG9zaXRpb24ueCAtIDUwfXB4YDtcbiAgICAgIGJhbGwuc3R5bGUudG9wID0gYCR7cG9zaXRpb24ueSAtIDUwfXB4YDtcbiAgICAgIC8vIGNvbnNvbGUubG9nKGBbJHtlLnR5cGV9XSBNb3ZpbmcvRHJhZ2dpbmdgLCBiYWxsLmlkKTtcbiAgICB9XG5cbiAgICAvLyBDb21tb24gZnVuY3Rpb24gZm9yIGVuZGluZyB0aGUgZHJhZ1xuICAgIGZ1bmN0aW9uIGVuZERyYWcoZTogTW91c2VFdmVudCB8IFRvdWNoRXZlbnQpIHtcbiAgICAgIGlmIChiYWxsLmdldEF0dHJpYnV0ZShcImNsaWNrZWRcIikgIT09IFwidHJ1ZVwiKSByZXR1cm47XG4gICAgICBjb25zdCBwb3NpdGlvbiA9IGdldFBvc2l0aW9uRnJvbUV2ZW50KGUpO1xuICAgICAgY29uc3Qgb3JpZ2luU3F1YXJlSWQgPSBiYWxsLmdldEF0dHJpYnV0ZShcIm9yaWdpbi1zcXVhcmVcIik7XG4gICAgICBhYy5lbmFibGVUcmFjayhnZXRTcXVhcmVJZChvcmlnaW5TcXVhcmVJZCksIGZhbHNlKTtcbiAgICAgIGJhbGwuc2V0QXR0cmlidXRlKFwiY2xpY2tlZFwiLCBcImZhbHNlXCIpO1xuICAgICAgc2hvd0JhbGxzKGZhbHNlKTtcbiAgICAgIGNvbnN0IHRhcmdldEVsZW1lbnQgPSBkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50KFxuICAgICAgICBwb3NpdGlvbi54LFxuICAgICAgICBwb3NpdGlvbi55XG4gICAgICApIGFzIEhUTUxFbGVtZW50O1xuICAgICAgc2hvd0JhbGxzKHRydWUpO1xuICAgICAgZHJvcEJhbGwoYmFsbCwgdGFyZ2V0RWxlbWVudCk7XG4gICAgICBjb25zb2xlLmxvZyhgWyR7ZS50eXBlfV0gRHJvcHBlZGAsIGJhbGwuaWQsIFwiZnJvbVwiLCBvcmlnaW5TcXVhcmVJZCk7XG4gICAgfVxuXG4gICAgLy8gQWRkIGV2ZW50IGxpc3RlbmVyc1xuICAgIGJhbGwuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlZG93blwiLCBzdGFydERyYWcpO1xuICAgIGJhbGwuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlbW92ZVwiLCBkb0RyYWcpO1xuICAgIGJhbGwuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNldXBcIiwgZW5kRHJhZyk7XG4gICAgYmFsbC5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hzdGFydFwiLCBzdGFydERyYWcpO1xuICAgIGJhbGwuYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNobW92ZVwiLCBkb0RyYWcpO1xuICAgIGJhbGwuYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNoZW5kXCIsIGVuZERyYWcpO1xuICB9KTtcbiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNldXBcIiwgKGUpID0+IHtcbiAgICBtb3VzZURvd24gPSBmYWxzZTtcbiAgfSk7XG4gIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZWRvd25cIiwgKGUpID0+IHtcbiAgICBtb3VzZURvd24gPSB0cnVlO1xuICB9KTtcbiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlbW92ZVwiLCAoZSkgPT4ge1xuICAgIGlmICghbW91c2VEb3duKSByZXR1cm47XG4gICAgY29uc3QgcG9zaXRpb24gPSBnZXRQb3NpdGlvbkZyb21FdmVudChlKTtcbiAgICB2YXIgY2xpY2tlZEJhbGw6IEhUTUxFbGVtZW50IHwgbnVsbCA9IGJhbGxzWzBdO1xuXG4gICAgYmFsbHMuZm9yRWFjaCgoYmFsbCkgPT4ge1xuICAgICAgY2xpY2tlZEJhbGwgPSBudWxsO1xuICAgICAgaWYgKGJhbGwuZ2V0QXR0cmlidXRlKFwiY2xpY2tlZFwiKSA9PT0gXCJ0cnVlXCIpIHtcbiAgICAgICAgY2xpY2tlZEJhbGwgPSBiYWxsO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGlmICghY2xpY2tlZEJhbGwpIHJldHVybjtcbiAgICBpZiAoZGlzdGFuY2VGcm9tQmFsbChjbGlja2VkQmFsbCwgZS5jbGllbnRYLCBlLmNsaWVudFkpID09IDApIHJldHVybjtcbiAgICBjbGlja2VkQmFsbC5zdHlsZS5sZWZ0ID0gYCR7cG9zaXRpb24ueCAtIDUwfXB4YDtcbiAgICBjbGlja2VkQmFsbC5zdHlsZS50b3AgPSBgJHtwb3NpdGlvbi55IC0gNTB9cHhgO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gZGlzdGFuY2VGcm9tQmFsbChiYWxsOiBIVE1MRWxlbWVudCwgeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcbiAgY29uc3QgcmVjdCA9IGJhbGwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gIGNvbnN0IGJhbGxYID0gcmVjdC5sZWZ0ICsgcmVjdC53aWR0aCAvIDI7XG4gIGNvbnN0IGJhbGxZID0gcmVjdC50b3AgKyByZWN0LmhlaWdodCAvIDI7XG4gIHJldHVybiBNYXRoLnNxcnQoKGJhbGxYIC0geCkgKiogMiArIChiYWxsWSAtIHkpICoqIDIpO1xufVxuXG4vLyBIZWxwZXIgdG8gZXh0cmFjdCBwb3NpdGlvbiBmcm9tIGV2ZW50XG5mdW5jdGlvbiBnZXRQb3NpdGlvbkZyb21FdmVudChlOiBhbnkpIHtcbiAgaWYgKHR5cGVvZiBUb3VjaEV2ZW50ICE9PSAndW5kZWZpbmVkJyAmJiBlIGluc3RhbmNlb2YgVG91Y2hFdmVudCAmJiAoZS50b3VjaGVzIHx8IGUuY2hhbmdlZFRvdWNoZXMpKSB7XG4gICAgY29uc3QgdG91Y2hlcyA9IGUudG91Y2hlcy5sZW5ndGggPiAwID8gZS50b3VjaGVzIDogZS5jaGFuZ2VkVG91Y2hlcztcbiAgICByZXR1cm4geyB4OiB0b3VjaGVzWzBdLmNsaWVudFgsIHk6IHRvdWNoZXNbMF0uY2xpZW50WSB9O1xuICB9IGVsc2UgaWYgKGUgaW5zdGFuY2VvZiBNb3VzZUV2ZW50KSB7XG4gICAgcmV0dXJuIHsgeDogZS5jbGllbnRYLCB5OiBlLmNsaWVudFkgfTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbnN1cHBvcnRlZCBldmVudCB0eXBlXCIpO1xuICB9XG59XG5cblxuZnVuY3Rpb24gaW5pdEZYVUkoKSB7XG4gIGlmICghZnhFbmFibGUpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgZngxID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJmeDFcIik7XG4gIGlmICghZngxKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiZngxIG5vdCBmb3VuZFwiKTtcbiAgfVxuICBmeDEuZHJhZ2dhYmxlID0gdHJ1ZTtcbiAgY29uc3QgZngyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJmeDJcIik7XG4gIGZ4MT8uYWRkRXZlbnRMaXN0ZW5lcihcImRyYWdzdGFydFwiLCAoZTogRHJhZ0V2ZW50KSA9PiB7XG4gICAgY29uc3QgeyB4LCB5IH0gPSBub3JtYWxpemVkWFkoZS54LCBlLnkpO1xuICAgIGFjLmZ4MSh4LCB5KTtcbiAgICBjb25zb2xlLmxvZyhcImRyYWdzdGFydFwiKTtcbiAgfSk7XG4gIGZ4MT8uYWRkRXZlbnRMaXN0ZW5lcihcImRyYWdcIiwgKGU6IERyYWdFdmVudCkgPT4ge1xuICAgIGNvbnN0IHsgeCwgeSB9ID0gbm9ybWFsaXplZFhZKGUueCwgZS55KTtcbiAgICBhYy5meDEoeCwgeSk7XG4gICAgY29uc29sZS5sb2coXCJkcmFnbW92ZVwiKTtcbiAgfSk7XG4gIGZ4MT8uYWRkRXZlbnRMaXN0ZW5lcihcImRyYWdlbmRcIiwgKGU6IERyYWdFdmVudCkgPT4ge1xuICAgIGFjLmZ4MSgwLCAwKTtcbiAgICBjb25zb2xlLmxvZyhcImRyYWdlbmRcIik7XG4gIH0pO1xuICBmeDE/LmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaHN0YXJ0XCIsIChlOiBUb3VjaEV2ZW50KSA9PiB7XG4gICAgaWYgKGUudG91Y2hlcy5sZW5ndGggIT0gMSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCB0b3VjaCA9IGUudG91Y2hlc1swXTtcbiAgICBjb25zdCB7IHgsIHkgfSA9IG5vcm1hbGl6ZWRYWSh0b3VjaC5jbGllbnRYLCB0b3VjaC5jbGllbnRZKTtcbiAgICBhYy5meDEoeCwgeSk7XG4gICAgY29uc29sZS5sb2coXCJ0b3VjaHN0YXJ0XCIpO1xuICB9KTtcbiAgZngxPy5hZGRFdmVudExpc3RlbmVyKFwidG91Y2htb3ZlXCIsIChlOiBUb3VjaEV2ZW50KSA9PiB7XG4gICAgaWYgKGUudG91Y2hlcy5sZW5ndGggIT0gMSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCB0b3VjaCA9IGUudG91Y2hlc1swXTtcbiAgICBjb25zdCB7IHgsIHkgfSA9IG5vcm1hbGl6ZWRYWSh0b3VjaC5jbGllbnRYLCB0b3VjaC5jbGllbnRZKTtcbiAgICBhYy5meDEoeCwgeSk7XG4gICAgY29uc29sZS5sb2coXCJ0b3VjaG1vdmVcIik7XG4gIH0pO1xuICBmeDE/LmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaGVuZFwiLCAoZTogVG91Y2hFdmVudCkgPT4ge1xuICAgIGlmIChlLnRvdWNoZXMubGVuZ3RoICE9IDEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgYWMuZngxKDAsIDApO1xuICAgIGNvbnNvbGUubG9nKFwidG91Y2hlbmRcIik7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVFbGVtZW50KFxuICB0YWc6IHN0cmluZyxcbiAgY2xzOiBzdHJpbmcsXG4gIGlkOiBzdHJpbmcsXG4gIHBhcmVudDogSFRNTEVsZW1lbnRcbikge1xuICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWcpO1xuICBlbGVtZW50LmNsYXNzTGlzdC5hZGQoY2xzKTtcbiAgZWxlbWVudC5pZCA9IGlkO1xuICBwYXJlbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7XG4gIHJldHVybiBlbGVtZW50O1xufVxuXG5mdW5jdGlvbiBzaG93QmFsbHMoc2hvdzogYm9vbGVhbikge1xuICBjb25zdCBiYWxsczogTm9kZUxpc3RPZjxIVE1MRWxlbWVudD4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLmJhbGxcIik7XG4gIGJhbGxzLmZvckVhY2goKGJhbGwpID0+IHtcbiAgICBiYWxsLnN0eWxlLmRpc3BsYXkgPSBzaG93ID8gXCJibG9ja1wiIDogXCJub25lXCI7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBnZXRTcXVhcmVJZChpZDogc3RyaW5nIHwgbnVsbCk6IG51bWJlciB7XG4gIGlmICghaWQpIHtcbiAgICByZXR1cm4gLTE7XG4gIH1cbiAgY29uc3QgcGFydHMgPSBpZC5zcGxpdChcInNxdWFyZS1cIik7XG4gIGlmIChwYXJ0cy5sZW5ndGggPCAyKSB7XG4gICAgcmV0dXJuIC0xO1xuICB9XG4gIHJldHVybiBwYXJzZUludChwYXJ0c1sxXSk7XG59XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZWRYWSh4OiBudW1iZXIsIHk6IG51bWJlcikge1xuICBjb25zdCB3aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoO1xuICBjb25zdCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7XG4gIHJldHVybiB7IHg6IHggLyB3aWR0aCwgeTogeSAvIGhlaWdodCB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbml0QXVkaW8oKSB7XG4gIGlmIChpc0luaXRpYXRlZCkge1xuICAgIHJldHVybjtcbiAgfVxuICBhd2FpdCBhYy5pbml0QXVkaW8oW1xuICAgIFwic3RlbXMvNC1vbi1mbG9vci53YXZcIixcbiAgICBcInN0ZW1zL2RuYi0xMjQud2F2XCIsXG4gICAgXCJzdGVtcy9kcnVtcy53YXZcIixcbiAgICBcInN0ZW1zL2hhdHMud2F2XCIsXG4gICAgXCJzdGVtcy9raWNrLWhhdC53YXZcIixcbiAgICBcInN0ZW1zL3RvbXMud2F2XCIsXG4gICAgXCJzdGVtcy9zbW9vdGgtY2hvcmRzLndhdlwiLFxuICAgIFwic3RlbXMvYmFzcy53YXZcIixcbiAgICBcInN0ZW1zL2J6enoud2F2XCIsXG4gICAgXCJzdGVtcy9ndWl0YXIud2F2XCIsXG4gICAgXCJzdGVtcy9kbmItMTI0LndhdlwiLFxuICAgIFwic3RlbXMvZHJ1bXMud2F2XCIsXG4gICAgXCJzdGVtcy9oYXRzLndhdlwiLFxuICAgIFwic3RlbXMva2VlcC1vbi53YXZcIixcbiAgICBcInN0ZW1zL3doYXQtdS1kb2luLXRvLW1lLndhdlwiLFxuICAgIFwic3RlbXMvZXh0YWN5LndhdlwiLFxuICBdKTtcbiAgaXNJbml0aWF0ZWQgPSB0cnVlO1xufVxuXG5mdW5jdGlvbiBzcGlubmVyKHNob3c6IGJvb2xlYW4pIHtcbiAgaWYgKHNob3cpIHtcbiAgICBjcmVhdGVFbGVtZW50KFwiZGl2XCIsIFwic3Bpbm5lclwiLCBcInNwaW5uZXJcIiwgZG9jdW1lbnQuYm9keSk7XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgc3Bpbm5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwic3Bpbm5lclwiKTtcbiAgICBzcGlubmVyPy5yZW1vdmUoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjcmVhdGVTdGFydEJ1dHRvbigpIHtcbiAgY29uc3Qgc3RhcnRCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInN0YXJ0LWJ1dHRvblwiKTtcbiAgY29uc3QgaW5mbzEgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImluZm8tMVwiKTtcbiAgY29uc3QgaW5mbzIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImluZm8tMlwiKTtcbiAgc3RhcnRCdXR0b24/LmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBhc3luYyAoKSA9PiB7XG4gICAgc3RhcnRCdXR0b24ucmVtb3ZlKCk7XG4gICAgaW5mbzE/LnJlbW92ZSgpO1xuICAgIGluZm8yPy5yZW1vdmUoKTtcbiAgICBzcGlubmVyKHRydWUpO1xuICAgIGF3YWl0IGluaXRBdWRpbygpO1xuICAgIHNwaW5uZXIoZmFsc2UpO1xuICAgIGNyZWF0ZVVJRWxlbWVudHMoKTtcbiAgICBpbml0VUlMb2dpYygpO1xuICAgIGluaXRGWFVJKCk7XG4gICAgZHJhdygpO1xuICB9KTtcbn1cblxuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIkRPTUNvbnRlbnRMb2FkZWRcIiwgKCkgPT4ge1xuICBjcmVhdGVTdGFydEJ1dHRvbigpO1xufSk7XG5cbmZ1bmN0aW9uIGRyYXcoKSB7XG4gIHJlcXVlc3RBbmltYXRpb25GcmFtZShkcmF3KTtcbiAgaWYgKCFpc0luaXRpYXRlZCkge1xuICAgIHJldHVybjtcbiAgfVxuICBmb3IgKGxldCBpID0gMDsgaSA8IG5TcXVhcmVzOyBpKyspIHtcbiAgICBjb25zdCBzcXVhcmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgc3F1YXJlLSR7aX1gKSBhcyBIVE1MRWxlbWVudDtcbiAgICBpZiAoc3F1YXJlKSB7XG4gICAgICBzcXVhcmUuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gYWMuZ2V0RnJlcXVlbmN5Q29sb3IoaSk7XG4gICAgfVxuICB9XG59XG4iLCJleHBvcnQgY2xhc3MgQXVkaW9Db250cm9sbGVyIHtcbiAgcHJpdmF0ZSBhdWRpb0NvbnRleHQ6IEF1ZGlvQ29udGV4dDtcbiAgcHJpdmF0ZSB0cmFja3M6IHtcbiAgICBzb3VyY2VOb2RlOiBBdWRpb0J1ZmZlclNvdXJjZU5vZGU7XG4gICAgZ2Fpbk5vZGU6IEdhaW5Ob2RlO1xuICAgIGFuYWx5c2VyTm9kZTogQW5hbHlzZXJOb2RlO1xuICB9W10gPSBbXTtcbiAgcHJpdmF0ZSBzbG93QXZlcmFnZTogbnVtYmVyID0gMzk7IC8vIG9yYW5nZVxuICBwcml2YXRlIGZ4MWE6IEJpcXVhZEZpbHRlck5vZGUgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBmeDFiOiBEZWxheU5vZGUgfCBudWxsID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmF1ZGlvQ29udGV4dCA9IG5ldyBBdWRpb0NvbnRleHQoKTtcbiAgfVxuXG4gIGFzeW5jIGluaXRBdWRpbyhmaWxlTmFtZXM6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKGZpbGVOYW1lcy5sZW5ndGggIT09IDE2KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFeHBlY3RlZCAxNiBhdWRpbyBmaWxlcy5cIik7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsZVByb21pc2VzID0gZmlsZU5hbWVzLm1hcCgoZmlsZU5hbWUpID0+XG4gICAgICB0aGlzLmxvYWRBdWRpb0ZpbGUoZmlsZU5hbWUpXG4gICAgKTtcblxuICAgIGNvbnN0IGF1ZGlvQnVmZmVycyA9IGF3YWl0IFByb21pc2UuYWxsKGZpbGVQcm9taXNlcyk7XG5cbiAgICBhdWRpb0J1ZmZlcnMuZm9yRWFjaCgoYnVmZmVyKSA9PiB7XG4gICAgICBjb25zdCBzb3VyY2VOb2RlID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlQnVmZmVyU291cmNlKCk7XG4gICAgICBjb25zdCBnYWluTm9kZSA9IHRoaXMuYXVkaW9Db250ZXh0LmNyZWF0ZUdhaW4oKTtcblxuICAgICAgc291cmNlTm9kZS5idWZmZXIgPSBidWZmZXI7XG4gICAgICBnYWluTm9kZS5nYWluLnZhbHVlID0gMDsgLy8gU3RhcnQgbXV0ZWRcbiAgICAgIHNvdXJjZU5vZGUuY29ubmVjdChnYWluTm9kZSk7XG5cbiAgICAgIC8vIHNldCB1cCBhbiBhbmFseXNlciBzbyB3ZSBjYW4gZG8gY29vbCB2aXN1YWxzXG4gICAgICBjb25zdCBhbmFseXNlck5vZGUgPSB0aGlzLmF1ZGlvQ29udGV4dC5jcmVhdGVBbmFseXNlcigpO1xuICAgICAgYW5hbHlzZXJOb2RlLmZmdFNpemUgPSAyMDQ4O1xuICAgICAgZ2Fpbk5vZGUuY29ubmVjdChhbmFseXNlck5vZGUpO1xuXG4gICAgICAvLyBzZXQgdXAgZnggbm9kZXNcbiAgICAgIHRoaXMuZngxYSA9IHRoaXMuYXVkaW9Db250ZXh0LmNyZWF0ZUJpcXVhZEZpbHRlcigpO1xuICAgICAgdGhpcy5meDFhLnR5cGUgPSBcImhpZ2hwYXNzXCI7XG4gICAgICB0aGlzLmZ4MWEuZnJlcXVlbmN5LnZhbHVlID0gMTAwMDtcbiAgICAgIHRoaXMuZngxYS5nYWluLnZhbHVlID0gMDtcbiAgICAgIGdhaW5Ob2RlLmNvbm5lY3QodGhpcy5meDFhKTtcblxuICAgICAgdGhpcy5meDFiID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlRGVsYXkoKTtcbiAgICAgIHRoaXMuZngxYi5kZWxheVRpbWUudmFsdWUgPSAwOyAvLyBwYXNzIHRocm91Z2hcbiAgICAgIHRoaXMuZngxYS5jb25uZWN0KHRoaXMuZngxYik7XG5cbiAgICAgIC8vIGZvciBub3cganVzdCBieXBhc3MgdGhlIEZYIG5vZGVzIC0gbm90IGltcGxlbWVudGVkIHByb3Blcmx5IHlldFxuICAgICAgLy8gICB0aGlzLmZ4MWIuY29ubmVjdCh0aGlzLmF1ZGlvQ29udGV4dC5kZXN0aW5hdGlvbik7XG4gICAgICBnYWluTm9kZS5jb25uZWN0KHRoaXMuYXVkaW9Db250ZXh0LmRlc3RpbmF0aW9uKTtcblxuICAgICAgdGhpcy50cmFja3MucHVzaCh7IHNvdXJjZU5vZGUsIGdhaW5Ob2RlLCBhbmFseXNlck5vZGUgfSk7XG5cbiAgICAgIHNvdXJjZU5vZGUubG9vcCA9IHRydWU7XG4gICAgICBzb3VyY2VOb2RlLnN0YXJ0KDApOyAvLyBQbGF5IGltbWVkaWF0ZWx5IGluIHN5bmNcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbG9hZEF1ZGlvRmlsZSh1cmw6IHN0cmluZyk6IFByb21pc2U8QXVkaW9CdWZmZXI+IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCk7XG4gICAgY29uc3QgYXJyYXlCdWZmZXIgPSBhd2FpdCByZXNwb25zZS5hcnJheUJ1ZmZlcigpO1xuICAgIHJldHVybiB0aGlzLmF1ZGlvQ29udGV4dC5kZWNvZGVBdWRpb0RhdGEoYXJyYXlCdWZmZXIpO1xuICB9XG5cbiAgZ2V0RnJlcXVlbmN5Q29sb3IodHJhY2s6IG51bWJlcik6IHN0cmluZyB7XG4gICAgY29uc3QgZ2Fpbk5vZGUgPSB0aGlzLnRyYWNrc1t0cmFja10uZ2Fpbk5vZGU7XG4gICAgaWYgKGdhaW5Ob2RlLmdhaW4udmFsdWUgPT09IDApIHtcbiAgICAgIHJldHVybiBgaHNsKCR7dGhpcy5zbG93QXZlcmFnZSArIHRyYWNrfSwgMTAwJSwgNTAlKWA7XG4gICAgfVxuICAgIGNvbnN0IGFuYWx5c2VyTm9kZSA9IHRoaXMudHJhY2tzW3RyYWNrXS5hbmFseXNlck5vZGU7XG4gICAgY29uc3QgZGF0YUFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYW5hbHlzZXJOb2RlLmZyZXF1ZW5jeUJpbkNvdW50KTtcbiAgICBhbmFseXNlck5vZGUuZ2V0Qnl0ZUZyZXF1ZW5jeURhdGEoZGF0YUFycmF5KTtcblxuICAgIC8vIGdldCB0aGUgaGlnaGVzdCBmcmVxdWVuY3lcbiAgICBjb25zdCBtYXggPSBNYXRoLm1heCguLi5kYXRhQXJyYXkpO1xuICAgIGNvbnN0IG1heEluZGV4ID0gZGF0YUFycmF5LmluZGV4T2YobWF4KTtcbiAgICB0aGlzLnVwZGF0ZVNsb3dBdmVyYWdlKG1heEluZGV4KTtcblxuICAgIGNvbnN0IGh1ZSA9IHRoaXMuc2xvd0F2ZXJhZ2UgKyB0cmFjayArICgobWF4SW5kZXggKiAxMCkgJSAyNDApO1xuICAgIHJldHVybiBgaHNsKCR7aHVlfSwgMTAwJSwgNTAlKWA7XG4gIH1cblxuICB1cGRhdGVTbG93QXZlcmFnZSh2YWx1ZTogbnVtYmVyKSB7XG4gICAgdGhpcy5zbG93QXZlcmFnZSA9IHRoaXMuc2xvd0F2ZXJhZ2UgKyAoKHZhbHVlICogMC4wMDEpICUgMjQwKTtcbiAgfVxuXG4gIGVuYWJsZVRyYWNrKHRyYWNrTnVtYmVyOiBudW1iZXIsIGVuYWJsZTogYm9vbGVhbik6IHZvaWQge1xuICAgIGlmICh0cmFja051bWJlciA9PSAtMSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodHJhY2tOdW1iZXIgPj0gdGhpcy50cmFja3MubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRyYWNrICR7dHJhY2tOdW1iZXJ9IGRvZXMgbm90IGV4aXN0LmApO1xuICAgIH1cbiAgICB0aGlzLnRyYWNrc1t0cmFja051bWJlcl0uZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9IGVuYWJsZSA/IDAuNSA6IDA7XG4gIH1cblxuICBtdXRlQWxsKCk6IHZvaWQge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy50cmFja3MubGVuZ3RoOyBpKyspIHtcbiAgICAgIHRoaXMuZW5hYmxlVHJhY2soaSwgZmFsc2UpO1xuICAgIH1cbiAgfVxuXG4gIGZ4MSh4OiBudW1iZXIsIHk6IG51bWJlcikge1xuICAgIGlmICh4ICE9IDAgJiYgeSAhPSAwKSB7XG4gICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuMSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghdGhpcy5meDFhIHx8ICF0aGlzLmZ4MWIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc29sZS5sb2coXCJmeDEgY2FsbGVkIHdpdGggeDpcIiwgeCwgXCJ5OlwiLCB5KTtcbiAgICBjb25zb2xlLmxvZyhcIkF1ZGlvQ29udGV4dCBzdGF0ZTpcIiwgdGhpcy5hdWRpb0NvbnRleHQuc3RhdGUpO1xuICAgIGNvbnNvbGUubG9nKFwiQ3VycmVudCB0aW1lOlwiLCB0aGlzLmF1ZGlvQ29udGV4dC5jdXJyZW50VGltZSk7XG5cbiAgICBjb25zb2xlLmxvZyhcIkFwcGx5aW5nIGdhaW46XCIsIHggKiAyNSwgXCJ0byBmeDFhXCIpO1xuICAgIGNvbnN0IGdhaW4gPSBNYXRoLmZsb29yKHggKiAxMCk7XG4gICAgdGhpcy5meDFhLmdhaW4uc2V0VmFsdWVBdFRpbWUoZ2FpbiwgdGhpcy5hdWRpb0NvbnRleHQuY3VycmVudFRpbWUpO1xuICAgIHRoaXMuZngxYi5kZWxheVRpbWUuc2V0VmFsdWVBdFRpbWUoeSwgdGhpcy5hdWRpb0NvbnRleHQuY3VycmVudFRpbWUpO1xuXG4gICAgY29uc29sZS5sb2codGhpcy5meDFhLCB0aGlzLmZ4MWIpO1xuICB9XG59XG4iXSwibmFtZXMiOlsiYWMiLCJhdWRpb0NvbnRleHQiLCJ0cmFja3MiLCJzbG93QXZlcmFnZSIsImZ4MWEiLCJmeDFiIiwiY29uc3RydWN0b3IiLCJ0aGlzIiwiQXVkaW9Db250ZXh0IiwiaW5pdEF1ZGlvIiwiZmlsZU5hbWVzIiwibGVuZ3RoIiwiRXJyb3IiLCJmaWxlUHJvbWlzZXMiLCJtYXAiLCJmaWxlTmFtZSIsImxvYWRBdWRpb0ZpbGUiLCJQcm9taXNlIiwiYWxsIiwiZm9yRWFjaCIsImJ1ZmZlciIsInNvdXJjZU5vZGUiLCJjcmVhdGVCdWZmZXJTb3VyY2UiLCJnYWluTm9kZSIsImNyZWF0ZUdhaW4iLCJnYWluIiwidmFsdWUiLCJjb25uZWN0IiwiYW5hbHlzZXJOb2RlIiwiY3JlYXRlQW5hbHlzZXIiLCJmZnRTaXplIiwiY3JlYXRlQmlxdWFkRmlsdGVyIiwidHlwZSIsImZyZXF1ZW5jeSIsImNyZWF0ZURlbGF5IiwiZGVsYXlUaW1lIiwiZGVzdGluYXRpb24iLCJwdXNoIiwibG9vcCIsInN0YXJ0IiwidXJsIiwicmVzcG9uc2UiLCJmZXRjaCIsImFycmF5QnVmZmVyIiwiZGVjb2RlQXVkaW9EYXRhIiwiZ2V0RnJlcXVlbmN5Q29sb3IiLCJ0cmFjayIsImRhdGFBcnJheSIsIlVpbnQ4QXJyYXkiLCJmcmVxdWVuY3lCaW5Db3VudCIsImdldEJ5dGVGcmVxdWVuY3lEYXRhIiwibWF4IiwiTWF0aCIsIm1heEluZGV4IiwiaW5kZXhPZiIsInVwZGF0ZVNsb3dBdmVyYWdlIiwiZW5hYmxlVHJhY2siLCJ0cmFja051bWJlciIsImVuYWJsZSIsIm11dGVBbGwiLCJpIiwiZngxIiwieCIsInkiLCJyYW5kb20iLCJjb25zb2xlIiwibG9nIiwic3RhdGUiLCJjdXJyZW50VGltZSIsImZsb29yIiwic2V0VmFsdWVBdFRpbWUiLCJuU3F1YXJlcyIsImlzSW5pdGlhdGVkIiwiZ2V0UG9zaXRpb25Gcm9tRXZlbnQiLCJlIiwiVG91Y2hFdmVudCIsInRvdWNoZXMiLCJjaGFuZ2VkVG91Y2hlcyIsImNsaWVudFgiLCJjbGllbnRZIiwiTW91c2VFdmVudCIsImNyZWF0ZUVsZW1lbnQiLCJ0YWciLCJjbHMiLCJpZCIsInBhcmVudCIsImVsZW1lbnQiLCJkb2N1bWVudCIsImNsYXNzTGlzdCIsImFkZCIsImFwcGVuZENoaWxkIiwic2hvd0JhbGxzIiwic2hvdyIsInF1ZXJ5U2VsZWN0b3JBbGwiLCJiYWxsIiwic3R5bGUiLCJkaXNwbGF5IiwiZ2V0U3F1YXJlSWQiLCJwYXJ0cyIsInNwbGl0IiwicGFyc2VJbnQiLCJzcGlubmVyIiwiYm9keSIsImdldEVsZW1lbnRCeUlkIiwicmVtb3ZlIiwiY3JlYXRlU3RhcnRCdXR0b24iLCJzdGFydEJ1dHRvbiIsImluZm8xIiwiaW5mbzIiLCJhZGRFdmVudExpc3RlbmVyIiwiYXN5bmMiLCJtYXRyaXgiLCJiYWxsSG9tZSIsImRyYWdnYWJsZSIsImlubmVyVGV4dCIsImNyZWF0ZVVJRWxlbWVudHMiLCJiYWxscyIsIm1vdXNlRG93biIsInN0YXJ0RHJhZyIsInByZXZlbnREZWZhdWx0Iiwib3JpZ2luU3F1YXJlIiwicGFyZW50RWxlbWVudCIsInNldEF0dHJpYnV0ZSIsImRvRHJhZyIsImdldEF0dHJpYnV0ZSIsInBvc2l0aW9uIiwibGVmdCIsInRvcCIsImVuZERyYWciLCJvcmlnaW5TcXVhcmVJZCIsInRhcmdldEVsZW1lbnQiLCJlbGVtZW50RnJvbVBvaW50IiwidGFyZ2V0IiwiZHJvcEJhbGwiLCJjbGlja2VkQmFsbCIsInJlY3QiLCJnZXRCb3VuZGluZ0NsaWVudFJlY3QiLCJiYWxsWCIsIndpZHRoIiwiYmFsbFkiLCJoZWlnaHQiLCJzcXJ0IiwiZGlzdGFuY2VGcm9tQmFsbCIsImluaXRVSUxvZ2ljIiwiZHJhdyIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsInNxdWFyZSIsImJhY2tncm91bmRDb2xvciJdLCJzb3VyY2VSb290IjoiIn0=